<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>神殺しの遺物 - 死を喰らう者 -</title>
<style>
    :root {
        --bg: #050507; --card: #0f0f12; --primary: #00f2ff; 
        --accent: #ff0044; --gold: #ffcc00; --text: #e2e2e7; --sub: #71717a;
        --death: #7c3aed; /* 敗北に関連する色 */
    }
    body { background: var(--bg); color: var(--text); font-family: 'Sawsans', 'Hiragino Mincho ProN', serif; margin: 0; user-select: none; touch-action: manipulation; }
    
    #top { background: var(--card); padding: 15px; border-bottom: 2px solid #1f1f23; position: sticky; top: 0; z-index: 100; text-align: center; }
    #boss-name { font-size: 1.2em; font-weight: 900; color: var(--accent); letter-spacing: 0.4em; }
    
    .bar-container { margin: 8px 0; }
    .bar-label { font-size: 0.6em; color: var(--sub); display: flex; justify-content: space-between; margin-bottom: 2px; }
    .bar { height: 8px; background: #1a1a1f; border-radius: 4px; overflow: hidden; border: 1px solid #222; }
    .fill { height: 100%; transition: width 0.1s; }
    #bosshp { background: linear-gradient(90deg, #600, var(--accent)); width: 100%; }
    #playerhp { background: linear-gradient(90deg, #004400, #00ff00); width: 100%; }
    
    .main-stats { display: grid; grid-template-columns: repeat(2, 2fr) 1fr; gap: 8px; margin-top: 10px; }
    .stat-box { background: #000; padding: 8px; border-radius: 4px; border: 1px solid #222; }
    .stat-label { font-size: 0.55em; color: var(--sub); display: block; }
    .stat-val { font-size: 0.85em; font-weight: bold; color: var(--primary); font-family: 'Courier New', monospace; }
    .stat-death { color: var(--death) !important; }

    .nav { display: flex; background: #0a0a0c; border-bottom: 1px solid #222; }
    .nav button { flex: 1; padding: 12px 0; border: none; background: none; color: var(--sub); font-size: 0.75em; font-weight: bold; cursor: pointer; }
    .nav button.active { color: var(--primary); border-bottom: 2px solid var(--primary); background: #ffffff05; }

    .tab { display: none; padding: 15px; height: calc(100vh - 320px); overflow-y: auto; }
    .tab.active { display: block; }

    .btn-attack { 
        width: 100%; padding: 25px; background: #000; color: var(--accent); 
        font-size: 1.3em; font-weight: 900; border: 2px solid var(--accent); border-radius: 0; 
        cursor: pointer; box-shadow: inset 0 0 15px #ff004422; transition: 0.1s;
    }
    .btn-attack:active:not(:disabled) { background: var(--accent); color: #000; }
    .btn-attack:disabled { border-color: #333; color: #333; cursor: not-allowed; }

    #log { margin-top: 10px; height: 180px; overflow-y: auto; font-size: 0.75em; line-height: 1.6; background: #000; padding: 10px; border: 1px solid #111; display: flex; flex-direction: column-reverse; }
    .log-entry { border-bottom: 1px solid #0a0a0c; padding: 2px 0; }
    .l-dmg { color: #ccc; }
    .l-skill { color: var(--primary); font-weight: bold; }
    .l-drop { color: var(--gold); }
    .l-boss { color: var(--accent); }
    .l-death-log { color: #fff; background: var(--death); padding: 0 4px; }

    .relic-card { background: #0a0a0c; border: 1px solid #1a1a1f; padding: 10px; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; }
    .relic-card.gold { border: 1px solid var(--gold); }
    .relic-card.death-relic { border-left: 4px solid var(--death); }
    .relic-name { font-size: 0.85em; font-weight: bold; }
    .relic-effect { font-size: 0.65em; color: var(--sub); }
</style>
</head>
<body>

<div id="top">
    <div id="boss-name">終焉の魔神アザトース</div>
    <div class="bar-container">
        <div class="bar-label"><span>魔神の権能</span><span id="bosshp-text">100.00%</span></div>
        <div class="bar"><div id="bosshp" class="fill"></div></div>
    </div>
    <div class="bar-container">
        <div class="bar-label"><span>自身の生命力</span><span id="playerhp-text">1000 / 1000</span></div>
        <div class="bar"><div id="playerhp" class="fill"></div></div>
    </div>
    
    <div class="main-stats">
        <div class="stat-box"><span class="stat-label">総攻撃力</span><span id="p-atk" class="stat-val">0</span></div>
        <div class="stat-box"><span class="stat-label">最大体力</span><span id="p-hp-max" class="stat-val">0</span></div>
        <div class="stat-box"><span class="stat-label">敗北数</span><span id="p-death-count" class="stat-val stat-death">0</span></div>
    </div>
</div>

<div class="nav">
    <button onclick="showTab('battle', this)" class="active">討伐</button>
    <button onclick="showTab('job', this)">深淵</button>
    <button onclick="showTab('skills', this)">奥義</button>
    <button onclick="showTab('equip', this)">遺物</button>
</div>

<div id="battle" class="tab active">
    <button class="btn-attack" id="attackBtn">斬撃を放つ</button>
    <div id="log"></div>
</div>

<div id="job" class="tab"><div id="jobList"></div></div>
<div id="skills" class="tab"><div id="ownedSkills"></div></div>
<div id="equip" class="tab"><div id="inventory"></div></div>

<script>
const BOSS_MAX_HP = 1e24;
const R_PREFIX = ["古の", "呪われし", "神聖なる", "深淵の", "血塗られた", "無名の", "星々の", "魔神の", "禁忌の", "至高の"];
const R_NAME = ["首飾り", "指輪", "魔石", "刻印", "聖杯", "腕輪", "冠", "鏡", "鱗", "羽"];
const R_SUFFIX = ["の断片", "の残滓", "の記憶", "の渇望", "の輝き"];

let p, longPressIdx, isDead = false;
const SAVE_KEY = "MAJIN_REBIRTH_V3";

function init() {
    const saved = localStorage.getItem(SAVE_KEY);
    p = saved ? JSON.parse(saved) : {
        lv:1, exp:0, job:"剣聖", 
        inventory: {}, unlockedSkills: [], 
        jobLevels: {"剣聖":1}, jobExp: {"剣聖":0}, 
        bossTotalDmg: 0, playerHP: 1000, deathCount: 0
    };
    refresh();

    const btn = document.getElementById("attackBtn");
    const start = (e) => { 
        if(isDead) return;
        e.preventDefault(); battle(); clearInterval(longPressIdx); 
        longPressIdx = setInterval(battle, 100); 
    };
    const stop = () => clearInterval(longPressIdx);
    btn.addEventListener("mousedown", start); btn.addEventListener("mouseup", stop);
    btn.addEventListener("touchstart", start); btn.addEventListener("touchend", stop);
}

function getRelicData(id) {
    const seed = parseInt(id);
    // 500種のうち、特定のID（例：13の倍数）を「死の遺物」にする
    const isDeathType = (seed % 13 === 0);
    const typeIdx = seed % 4;
    const types = ["ATK", "HP", "DMG", "DROP"];
    const type = types[typeIdx];
    
    const isGold = (seed % 100 === 0);
    const baseVal = isGold ? (seed % 10 + 1) * 20 : (seed % 10 + 1);

    const name = (isDeathType ? "死を喰らう" : R_PREFIX[seed % 10]) + R_NAME[(seed >> 2) % 10] + R_SUFFIX[(seed >> 4) % 5];
    
    let desc = "";
    if(isDeathType) {
        desc = `敗北数に応じて${type==="ATK"?"攻撃力":type==="HP"?"最大体力":"威力"}が上昇(現在:+${(p.deathCount * baseVal * 0.1).toFixed(1)}%)`;
    } else {
        desc = `${type==="ATK"?"攻撃力":type==="HP"?"体力":"威力"}を ${baseVal}${type==="DMG"||type==="DROP"?"%":""} 上昇`;
    }

    return { id, name, type, val: baseVal, desc, isGold, isDeathType };
}

function calcStats() {
    let atk = 10 + (p.lv * 20);
    let hp = 1000 + (p.lv * 100);
    let dmgM = 1.0;
    let dropM = 1.0;

    Object.keys(p.inventory).forEach(id => {
        const d = getRelicData(id);
        const count = p.inventory[id];
        let boost = d.val * count;
        
        // 死の遺物の計算 (敗北数 × 基礎値の10%)
        if(d.isDeathType) {
            let deathBoost = 1 + (p.deathCount * d.val * 0.001 * count);
            if(d.type === "ATK") atk *= deathBoost;
            if(d.type === "HP") hp *= deathBoost;
            if(d.type === "DMG") dmgM *= deathBoost;
        } else {
            if(d.type === "ATK") atk += boost;
            if(d.type === "HP") hp += boost;
            if(d.type === "DMG") dmgM += (boost * 0.01);
            if(d.type === "DROP") dropM += (boost * 0.01);
        }
    });

    p.totalAtk = Math.floor(atk);
    p.maxHP = Math.floor(hp);
    p.totalDmgMult = dmgM;
    p.dropRate = 5.0 * dropM;
}

function battle() {
    if(isDead) return;
    calcStats();
    
    let dmg = Math.floor(p.totalAtk * (0.8 + Math.random() * 0.4) * p.totalDmgMult);
    p.bossTotalDmg += dmg;
    addLog(`<span class="l-dmg">【斬撃】 魔神へ ${dmg.toLocaleString()} のダメージ</span>`);

    // 反撃ダメージ
    let counterAtk = Math.floor(p.maxHP * 0.08); 
    p.playerHP -= counterAtk;

    if(p.playerHP <= 0) {
        p.deathCount++;
        playerDeath();
        return;
    }

    if(Math.random() < p.dropRate / 100) {
        let rId = Math.floor(Math.random() * 500);
        let data = getRelicData(rId);
        p.inventory[rId] = (p.inventory[rId] || 0) + 1;
        addLog(`<span class="l-drop" style="color:${data.isGold?'var(--gold)':'var(--primary)'}">★ 遺物獲得：${data.name}</span>`);
    }

    p.exp += Math.floor(dmg * 0.5);
    checkLevelUp();
    refresh();
}

function playerDeath() {
    isDead = true;
    clearInterval(longPressIdx);
    p.playerHP = 0;
    addLog(`<span class="l-death-log">◆ 敗北：死が力に変換される...（敗北数:${p.deathCount}）</span>`);
    refresh();
    setTimeout(() => {
        p.playerHP = p.maxHP;
        isDead = false;
        refresh();
    }, 1000); // 復活を1秒に短縮
}

function checkLevelUp() {
    const next = Math.pow(p.lv, 3) * 500;
    while(p.exp >= next) {
        p.exp -= next;
        p.lv++;
        addLog(`<span class="l-skill">≫ 階位上昇：第 ${p.lv} 階位</span>`);
    }
}

function refresh() {
    let hpPer = Math.max(0, 100 - (p.bossTotalDmg / BOSS_MAX_HP * 100));
    document.getElementById("bosshp").style.width = hpPer + "%";
    document.getElementById("bosshp-text").innerText = hpPer.toFixed(8) + "%";
    
    let pIpPer = (p.playerHP / p.maxHP * 100);
    document.getElementById("playerhp").style.width = pIpPer + "%";
    document.getElementById("playerhp-text").innerText = `${Math.floor(p.playerHP).toLocaleString()} / ${p.maxHP.toLocaleString()}`;

    document.getElementById("p-atk").innerText = p.totalAtk.toLocaleString();
    document.getElementById("p-hp-max").innerText = p.maxHP.toLocaleString();
    document.getElementById("p-death-count").innerText = p.deathCount;
    
    document.getElementById("inventory").innerHTML = Object.keys(p.inventory).map(id => {
        let d = getRelicData(id);
        return `
            <div class="relic-card ${d.isGold?'gold':''} ${d.isDeathType?'death-relic':''}">
                <div>
                    <div class="relic-name" style="color:${d.isDeathType?'var(--death)':(d.isGold?'var(--gold)':'var(--primary)')}">${d.name}</div>
                    <div class="relic-effect">${d.desc}</div>
                </div>
                <div style="font-weight:bold">×${p.inventory[id]}</div>
            </div>
        `;
    }).join("");

    document.getElementById("attackBtn").disabled = isDead;
    save();
}

function addLog(m) {
    const l = document.getElementById("log");
    const d = document.createElement("div");
    d.className = "log-entry";
    d.innerHTML = m;
    l.prepend(d);
    if(l.childNodes.length > 50) l.removeChild(l.lastChild);
}

function showTab(id, btn) {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.getElementById(id).classList.add("active");
    document.querySelectorAll(".nav button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
}

function save() { localStorage.setItem(SAVE_KEY, JSON.stringify(p)); }
init();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>魔神討伐伝 - 安定版 -</title>
<style>
    :root {
        --bg: #ffffff; --panel: #f1f3f5; --border: #dee2e6;
        --primary: #007bff; --text: #212529; --sub: #6c757d;
        --accent: #dc3545; --gold: #d39e00; --death: #6f42c1;
    }
    body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
    
    #header { background: var(--panel); padding: 10px; border-bottom: 2px solid var(--border); flex-shrink: 0; }
    .status-line { display: flex; justify-content: space-between; font-size: 0.85em; font-weight: bold; margin-bottom: 5px; }
    .bar { height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden; border: 1px solid var(--border); margin-bottom: 5px; }
    .fill { height: 100%; transition: width 0.1s linear; }
    #bosshp { background: linear-gradient(90deg, #ffc107, #dc3545); }
    
    .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
    .stat-box { background: #fff; padding: 5px; border-radius: 4px; border: 1px solid var(--border); text-align: center; }
    .stat-label { font-size: 0.6em; color: var(--sub); display: block; }
    .stat-val { font-size: 0.8em; font-weight: bold; }

    .nav { display: flex; background: var(--panel); border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .nav button { flex: 1; padding: 12px 0; border: none; background: none; color: var(--sub); font-weight: bold; font-size: 0.8em; cursor: pointer; }
    .nav button.active { color: var(--primary); border-bottom: 3px solid var(--primary); background: #fff; }

    #content { flex-grow: 1; overflow-y: auto; position: relative; }
    .tab { display: none; padding: 15px; height: 100%; box-sizing: border-box; }
    .tab.active { display: block; }

    .battle-layout { display: flex; flex-direction: column; height: 100%; }
    .btn-attack { width: 100%; padding: 20px; background: var(--primary); color: #fff; font-size: 1.2em; font-weight: bold; border: none; border-radius: 8px; flex-shrink: 0; cursor: pointer; }
    .btn-attack:active { opacity: 0.8; }
    
    #log { flex-grow: 1; margin-top: 10px; overflow-y: auto; font-size: 0.8em; background: #fafafa; padding: 10px; border: 1px solid var(--border); border-radius: 5px; line-height: 1.4; }

    .detail-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: #fff; z-index: 10; padding: 15px; display: none; overflow-y: auto; }
    .close-btn { background: var(--sub); color: #fff; border: none; padding: 8px 15px; border-radius: 4px; margin-bottom: 10px; }

    .list-item { background: #fff; border: 1px solid var(--border); padding: 10px; border-radius: 6px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
    .relic-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
    .relic-cell { background: #fff; border: 1px solid var(--border); padding: 8px; font-size: 0.75em; display: flex; justify-content: space-between; }

    .skill-card { background: #f8f9fa; border-left: 4px solid var(--primary); padding: 10px; margin-bottom: 8px; }
</style>
</head>
<body>

<div id="header">
    <div class="status-line"><span>魔神</span><span id="bosshp-text">100.00%</span></div>
    <div class="bar"><div id="bosshp" class="fill" style="width: 100%;"></div></div>
    <div class="stats-grid">
        <div class="stat-box"><span class="stat-label">主人公 Lv</span><span id="p-lv" class="stat-val">1</span></div>
        <div class="stat-box"><span class="stat-label">現在の職業</span><span id="p-job-lv" class="stat-val">---</span></div>
        <div class="stat-box"><span class="stat-label">累計敗北数</span><span id="p-death" class="stat-val" style="color:var(--death)">0</span></div>
    </div>
</div>

<div class="nav">
    <button onclick="showTab('battle', this)" class="active">討伐</button>
    <button onclick="showTab('job', this)">職業</button>
    <button onclick="showTab('skills', this)">スキル</button>
    <button onclick="showTab('equip', this)">遺物</button>
</div>

<div id="content">
    <div id="battle" class="tab active">
        <div class="battle-layout">
            <button class="btn-attack" id="attackBtn">魔神に攻撃</button>
            <div id="log"></div>
        </div>
    </div>
    <div id="job" class="tab"><div id="jobList"></div></div>
    <div id="skills" class="tab"><div id="ownedSkillList"></div></div>
    <div id="equip" class="tab"><div class="relic-grid" id="relicGrid"></div></div>
    <div id="detailPanel" class="detail-overlay">
        <button class="close-btn" onclick="closeDetail()">戻る</button>
        <div id="detailContent"></div>
    </div>
</div>

<script>
const BOSS_MAX_HP = 1e24;
const JOBS_DATA = {
    "剣聖": ["烈風斬", "雷鳴一閃", "空破斬", "奥義・天断", "神殺しの刃"],
    "神官": ["癒しの光", "守護の結界", "天罰の光", "奇跡の風", "聖域の守り"],
    "魔導師": ["火炎球", "氷結槍", "落雷", "崩壊の魔印", "宇宙の真理"],
    "狩人": ["速射", "狙い撃ち", "毒の矢", "影縫い", "流星の雨"],
    "武闘家": ["正拳突き", "連撃", "気功砲", "爆裂拳", "破天の構え"],
    "暗殺者": ["急所突き", "煙幕", "猛毒の刃", "影渡り", "無音の終焉"],
    "忍者": ["手裏剣", "火遁の術", "分身の術", "雷切", "秘術・微塵"],
    "聖騎士": ["盾打ち", "絶対防御", "審判の槌", "聖なる行進", "不落の城塞"],
    "狂戦士": ["猛撃", "粉砕", "雄たけび", "血の祝祭", "魂の破壊"],
    "槍術士": ["貫通突き", "旋回一閃", "螺旋の牙", "龍の咆哮", "天空を穿つ槍"],
    "弓聖": ["二連射", "魔矢", "旋風の矢", "爆裂の矢", "星堕とし"],
    "錬金術師": ["薬品投擲", "物質変化", "金剛化", "爆発生成", "賢者の石"],
    "死霊使い": ["亡者の召喚", "呪いの霧", "魂の吸収", "死霊の軍勢", "冥府の門"],
    "風術師": ["風の刃", "竜巻", "疾風の加護", "真空波", "神風の怒り"],
    "重騎士": ["大盾の構え", "体当たり", "地響き", "不屈の精神", "重力崩壊"],
    "冒険者": ["鑑定", "起死回生", "幸運のダイス", "お宝発見", "英雄の証"],
    "覇王": ["覇気", "支配の眼光", "次元の蹂躙", "覇道一撃", "天地開闢"],
    "拳闘士": ["ラッシュ", "回避", "カウンター", "KOパンチ", "無双の拳"],
    "槍王": ["一突き", "乱舞", "龍巻", "神の突き", "銀河貫通"],
    "賢者": ["知恵の閃き", "魔力収束", "時空魔法", "因果逆転", "全知全能"]
};
const R_PREFIX = ["古の", "聖なる", "深淵の", "魔神の", "星の"];
const R_NAME = ["指輪", "魔石", "刻印", "聖杯", "冠"];
const R_SUFFIX = ["の記憶", "の輝き", "の欠片"];

let p, longPressIdx, isProcessing = false;
const SAVE_KEY = "MAJIN_REBIRTH_STABLE_V1";

function init() {
    const saved = localStorage.getItem(SAVE_KEY);
    p = saved ? JSON.parse(saved) : {
        lv: 1, exp: 0, job: "剣聖", inventory: {}, 
        jobLevels: {}, jobExp: {}, bossTotalDmg: 0, deathCount: 0
    };
    Object.keys(JOBS_DATA).forEach(j => {
        if (!p.jobLevels[j]) p.jobLevels[j] = 1;
        if (p.jobExp[j] === undefined) p.jobExp[j] = 0;
    });
    
    const btn = document.getElementById("attackBtn");
    btn.addEventListener("mousedown", (e) => { e.preventDefault(); startBattle(); });
    btn.addEventListener("mouseup", stopBattle);
    btn.addEventListener("mouseleave", stopBattle);
    btn.addEventListener("touchstart", (e) => { e.preventDefault(); startBattle(); }, {passive: false});
    btn.addEventListener("touchend", stopBattle);
    
    refresh();
}

function startBattle() {
    if (longPressIdx) return;
    battle();
    longPressIdx = setInterval(battle, 100);
}

function stopBattle() {
    clearInterval(longPressIdx);
    longPressIdx = null;
}

function getRelicData(id) {
    const seed = parseInt(id);
    const types = ["攻撃力", "最大体力", "与ダメージ", "発見率"];
    const typeKey = ["ATK", "HP", "DMG", "DROP"][seed % 4];
    const isDeathType = (seed % 13 === 0);
    const isGold = (seed % 100 === 0);
    const baseVal = isGold ? (seed % 10 + 1) * 20 : (seed % 10 + 1);
    const name = (isDeathType ? "死を喰らう" : R_PREFIX[seed % 5]) + R_NAME[(seed >> 2) % 5] + R_SUFFIX[seed % 3];
    let effectText = isDeathType ? `敗北数に応じて${types[seed%4]}を強化` : `${types[seed%4]}を ${baseVal}${seed%4>=2?'%':''} 上昇`;
    return { id, name, typeKey, val: baseVal, effectText, isGold, isDeathType };
}

function battle() {
    if (isProcessing) return;
    isProcessing = true;

    let atk = 500 + (p.lv * 100) + (p.jobLevels[p.job] * 50);
    let dmgM = 1.0;
    Object.keys(p.inventory).forEach(id => {
        const d = getRelicData(id); const count = p.inventory[id];
        if (d.isDeathType) dmgM *= (1 + (p.deathCount * d.val * 0.0001 * count));
        else if (d.typeKey === "ATK") atk += d.val * count;
        else if (d.typeKey === "DMG") dmgM += d.val * 0.01 * count;
    });

    let dmg = Math.floor(atk * (0.9 + Math.random() * 0.2) * dmgM);
    p.bossTotalDmg += dmg;
    p.deathCount++; // 魔神の一撃による死

    let gain = Math.floor(dmg * 0.1) + 50;
    p.exp += gain; p.jobExp[p.job] += gain;

    if (Math.random() < 0.1) {
        let rId = Math.floor(Math.random() * 500);
        p.inventory[rId] = (p.inventory[rId] || 0) + 1;
        addLog(`<span style="color:var(--gold)">遺物：${getRelicData(rId).name} 獲得</span>`);
    }

    addLog(`魔神に ${dmg.toLocaleString()} ダメージを与えた`);
    checkLevelUp();
    refresh();
    isProcessing = false;
}

function checkLevelUp() {
    let next = Math.pow(p.lv, 3) * 500;
    while (p.exp >= next && p.lv < 9999) { p.exp -= next; p.lv++; next = Math.pow(p.lv, 3) * 500; }
    let jNext = Math.pow(p.jobLevels[p.job], 3) * 300;
    while (p.jobExp[p.job] >= jNext && p.jobLevels[p.job] < 999) { p.jobExp[p.job] -= jNext; p.jobLevels[p.job]++; jNext = Math.pow(p.jobLevels[p.job], 3) * 300; }
}

function refresh() {
    let hpPer = Math.max(0, 100 - (p.bossTotalDmg / BOSS_MAX_HP * 100));
    document.getElementById("bosshp").style.width = hpPer + "%";
    document.getElementById("bosshp-text").innerText = hpPer.toFixed(10) + "%";
    document.getElementById("p-lv").innerText = p.lv;
    document.getElementById("p-job-lv").innerText = `${p.job} Lv.${p.jobLevels[p.job]}`;
    document.getElementById("p-death").innerText = p.deathCount;

    if (document.getElementById("job").classList.contains("active")) {
        document.getElementById("jobList").innerHTML = Object.keys(JOBS_DATA).map(j => `
            <div class="list-item" onclick="openJobDetail('${j}')">
                <span><b>${j}</b> <small>Lv.${p.jobLevels[j]}</small></span>
                <button onclick="event.stopPropagation(); p.job='${j}'; refresh();" style="color:var(--primary); background:none; border:1px solid var(--primary); border-radius:4px; padding:2px 8px;">${p.job === j ? '選択中' : '転職'}</button>
            </div>
        `).join("");
    }

    if (document.getElementById("skills").classList.contains("active")) {
        document.getElementById("ownedSkillList").innerHTML = JOBS_DATA[p.job].map((s, i) => {
            if (p.jobLevels[p.job] < (i + 1) * 10) return "";
            return `<div class="skill-card"><b>【${s}】</b><br><small>与ダメージ ${(i+1)*20}% 増幅</small></div>`;
        }).join("") || "<p style='text-align:center; color:var(--sub);'>Lv.10で習得</p>";
    }

    if (document.getElementById("equip").classList.contains("active")) {
        document.getElementById("relicGrid").innerHTML = Object.keys(p.inventory).map(id => {
            const d = getRelicData(id);
            const rareStyle = d.isGold ? 'color:var(--gold); font-weight:bold;' : (d.isDeathType ? 'color:var(--death);' : '');
            return `<div class="relic-cell" onclick="openRelicDetail(${id})"><span style="${rareStyle}">${d.name}</span><span>×${p.inventory[id]}</span></div>`;
        }).join("");
    }
    localStorage.setItem(SAVE_KEY, JSON.stringify(p));
}

function addLog(m) {
    const l = document.getElementById("log");
    l.innerHTML = `<div>${m}</div>` + l.innerHTML;
    if (l.childNodes.length > 20) l.removeChild(l.lastChild);
}

function openJobDetail(jName) {
    const lv = p.jobLevels[jName];
    let html = `<h3>${jName}</h3><p>ジョブレベル: ${lv}</p><hr>`;
    JOBS_DATA[jName].forEach((s, i) => {
        const req = (i + 1) * 10;
        html += `<div style="color:${lv >= req ? 'var(--primary)' : '#ccc'}">Lv.${req}: ${s}</div>`;
    });
    showDetail(html);
}

function openRelicDetail(id) {
    const d = getRelicData(id);
    showDetail(`<h3>${d.name}</h3><p>所持数: ${p.inventory[id]}</p><hr><p>${d.effectText}</p>`);
}

function showDetail(content) {
    document.getElementById("detailContent").innerHTML = content;
    document.getElementById("detailPanel").style.display = "block";
}
function closeDetail() { document.getElementById("detailPanel").style.display = "none"; }

function showTab(id, btn) {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.getElementById(id).classList.add("active");
    document.querySelectorAll(".nav button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    refresh();
}
init();
</script>
</body>
</html>
// --- attack関数内のドロップ処理とログ表示部分を重点的に修正 ---
function attack() {
    const stats = calcStats();
    const v = getVowStats();

    // 再起(死亡)とランダム成長
    player.deathCount++;
    const addAtk = BigInt(Math.floor(Math.random() * (v.atkMax + 1)));
    const addHp = BigInt(Math.floor(Math.random() * (v.hpMax + 1)));
    player.baseAtk += addAtk;
    player.baseHP += addHp;
    
    // 指定のメッセージ表示
    addLog(`<span style="color:#dc3545;font-weight:bold;">9,999,999,999,999ダメージ。再起の誓いによって新たなる力を得た</span>`);

    let dmg = stats.atk;
    if (dmg > player.maxDmg) player.maxDmg = dmg;
    currentBossHP -= dmg; if (currentBossHP <= 0n) currentBossHP = BOSS_MAX_HP;
    addLog(`魔神に ${dmg.toLocaleString()} ダメージ！`);

    // ドロップ結果を格納する配列
    let dropResults = [];

    // 遺物ドロップ判定 (魂の研磨数分ループ)
    for (let i = 0; i < v.dropCount; i++) {
        let star = 1; let rv = Math.random() * 100;
        for(let s=10; s>=2; s--) {
            let prob = BASE_PROBS[s] + v.rareBonus;
            if(rv < prob) { star = s; break; }
            rv -= prob;
        }
        for (let s = 10; s >= 5; s--) { if (star >= s && dmg < DROP_LIMITS[s]) { star = s - 1; } }

        const cands = RELIC_MASTER.filter(rm => rm.star === star);
        const r = cands[Math.floor(Math.random() * cands.length)];

        if (!player.inventory[r.id]) player.inventory[r.id] = 0;

        let finalRelic = r;
        let isConverted = false;

        // ★6以上の重複チェック
        if (star >= 6 && player.inventory[r.id] >= 1) {
            finalRelic = RELIC_MASTER.find(rm => rm.pIdx === r.pIdx && rm.star === 1);
            if (!player.inventory[finalRelic.id]) player.inventory[finalRelic.id] = 0;
            isConverted = true;
        }

        player.inventory[finalRelic.id] += 1;
        player.totalCounts[r.pIdx] += 1;

        // ログ用の文字列作成
        let logColor = star >= 6 ? "orange" : (star >= 4 ? "#9c27b0" : "#666");
        let logText = `<span style="color:${logColor};">★${star} ${r.name}</span>`;
        if(isConverted) logText += ` <span style="font-size:0.8em; color:#888;">(重複変換)</span>`;
        dropResults.push(logText);
    }
    
    // 全ドロップ品をログに表示
    if(dropResults.length > 0) {
        addLog(`【ドロップ】${dropResults.join(", ")}`);
    }
    
    saveGame(); 
    refreshUI();
}

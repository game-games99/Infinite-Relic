<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>RELICORE - v1.4</title>
<style>
  :root { --bg: #ffffff; --panel: #f8f9fa; --border: #dee2e6; --primary: #007bff; --text: #212529; --hp: #dc3545; --dark: #1a1a1a; --gold: #d4af37; --growth: #ff69b4; --relic-purple: #6610f2; --relic-bg: #fcfaff; }
  * { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; box-sizing: border-box; }
  body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; position: relative; }
  
  /* 覚醒メッセージウィンドウ */
  #rank-up-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 50000; justify-content: center; align-items: center; padding: 20px; }
  .rank-up-content { background: #000; border: 2px solid var(--growth); border-radius: 20px; padding: 40px 20px; text-align: center; color: #fff; max-width: 450px; width: 95%; box-shadow: 0 0 40px rgba(255, 105, 180, 0.4); animation: heartbeat-pulse 2s infinite; }
  @keyframes heartbeat-pulse { 0% { transform: scale(1); } 5% { transform: scale(1.08); } 10% { transform: scale(1); } 15% { transform: scale(1.04); } 20% { transform: scale(1); } 100% { transform: scale(1); } }
  .rank-up-title { color: var(--growth); font-size: 1.6em; font-weight: bold; margin-bottom: 20px; letter-spacing: 4px; }
  .rank-up-msg { font-size: 1.1em; line-height: 1.8; margin-bottom: 30px; color: #fff; }

  #rare-drop-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 40000; justify-content: center; align-items: center; pointer-events: none; }
  .rare-card { background: #000; border: 2px solid #fff; border-radius: 15px; padding: 30px; text-align: center; color: #fff; transform: scale(0); animation: card-pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; pointer-events: auto; min-width: 280px; }
  @keyframes card-pop { 0% { transform: scale(0) rotate(-10deg); opacity: 0; } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }
  .rare-star { font-size: 1.2em; margin-bottom: 10px; display: block; }
  .rare-name { font-size: 1.6em; font-weight: bold; margin-bottom: 15px; display: block; }
  .rare-desc { font-size: 0.9em; color: #ccc; line-height: 1.5; }
  .glow-4 { box-shadow: 0 0 30px var(--relic-purple); border-color: var(--relic-purple); }
  .glow-5 { box-shadow: 0 0 30px #e83e8c; border-color: #e83e8c; }
  .glow-6 { box-shadow: 0 0 35px #fd7e14; border-color: #fd7e14; }
  .glow-7 { box-shadow: 0 0 40px #ff0000; border-color: #ff0000; }
  .glow-8 { box-shadow: 0 0 50px gold; border-color: gold; }

  #hado-awaken-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 30000; justify-content: center; align-items: center; padding: 20px; }
  .hado-content { background: #000; border: 3px solid var(--gold); border-radius: 20px; padding: 40px 20px; text-align: center; color: #fff; max-width: 450px; width: 95%; }
  .hado-title { color: var(--gold); font-size: 1.8em; font-weight: bold; margin-bottom: 25px; }
  
  #story-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 10000; justify-content: center; align-items: center; padding: 20px; }
  .story-content { max-width: 500px; color: #fff; text-align: center; line-height: 2.2; }
  .story-vow { color: gold; font-weight: bold; display: inline-block; animation: heart-beat 1.5s infinite; }
  @keyframes heart-beat { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
  .story-btn { background: none; border: 1px solid gold; color: gold; padding: 12px 40px; font-size: 1em; cursor: pointer; transition: 0.3s; }
  .c1 { color: #888888; font-weight: bold; } .c2 { color: #28a745; font-weight: bold; } .c3 { color: #007bff; font-weight: bold; } .c4 { color: #6610f2; font-weight: bold; } .c5 { color: #e83e8c; font-weight: bold; } .c6 { color: #fd7e14; font-weight: bold; } .c7 { color: #ff0000; font-weight: bold; } .c8 { color: gold; font-weight: bold; }
  #header { background: var(--dark); color: #fff; padding: 12px 10px; border-bottom: 2px solid #000; flex-shrink: 0; }
  .boss-area { text-align: center; width: 100%; }
  .hp-bar-container { background: #333; height: 10px; border-radius: 5px; overflow: hidden; margin: 0 auto 8px auto; }
  #hp-bar-fill { height: 100%; background: linear-gradient(90deg, #b02a37, #dc3545); width: 100%; transition: width 0.1s; }
  .hp-val-display { font-size: 1.3em; font-weight: bold; color: #ff6b6b; font-family: monospace; }
  .status-box { display: flex; gap: 8px; margin-top: 10px; }
  .stat-card { flex: 1; background: rgba(255,255,255,0.08); padding: 5px 10px; border-radius: 6px; border-left: 3px solid var(--primary); }
  .nav { display: flex; background: var(--panel); border-bottom: 1px solid var(--border); flex-shrink: 0; }
  .nav button { flex: 1; padding: 12px 0; border: none; background: none; color: #6c757d; font-weight: bold; font-size: 0.8em; }
  .nav button.active { color: var(--primary); border-bottom: 3px solid var(--primary); background: #fff; }
  #content-area { flex-grow: 1; overflow: hidden; background: #fff; }
  .tab { display: none; padding: 10px 10px 150px 10px; height: 100%; overflow-y: auto; }
  .tab.active { display: block; }
  .btn-attack { width: 100%; padding: 16px; background: var(--primary); color: #fff; font-size: 1.3em; font-weight: bold; border: none; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 4px 0 #0056b3; }
  #log { height: 350px; font-size: 0.82em; background: #fafafa; border: 1px solid var(--border); padding: 10px; overflow-y: auto; border-radius: 8px; }
  .vow-item { position: relative; background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 8px 16px; margin-bottom: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
  .vow-item::before { content: ""; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: gold; border-radius: 8px 0 0 8px; }
  .vow-header { display: flex; justify-content: space-between; align-items: baseline; border-bottom: 1px solid #f0f0f0; margin-bottom: 4px; }
  .vow-name { font-weight: bold; color: #333; }
  .vow-lv { font-size: 0.75em; font-weight: bold; color: var(--growth); }
  .vow-lv.max { color: gold; text-shadow: 0 0 2px gold; }
  .vow-highlight { font-weight: bold; font-size: 0.82em; color: var(--primary); display: block; }
  .vow-sub { font-size: 0.72em; color: #888; display: block; }
  .relic-list-container { display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px; }
  .relic-card { border: 1px solid #e0d5f0; padding: 6px; border-radius: 6px; background: var(--relic-bg); display: flex; flex-direction: column; grid-column: span 2; }
  .relic-card.star-high { grid-column: span 3; border-width: 2px; background: #fff; }
  .ver-footer { position: fixed; bottom: 4px; right: 4px; color: #bbb; font-size: 0.65em; pointer-events: none; }
  .rank-display { text-align: center; padding: 15px; background: #000; color: #fff; border-radius: 10px; margin-bottom: 15px; }
  .rank-title.max { color: gold; text-shadow: 0 0 10px gold; }
</style>
</head>
<body>
<div id="rank-up-modal"><div class="rank-up-content"><div class="rank-up-title">覚醒</div><div class="rank-up-msg" id="rank-up-msg-text">魂の核が激しく鼓動する……！</div><button class="story-btn" onclick="closeRankUpModal()">高みへ</button></div></div>
<div id="rare-drop-modal" onclick="closeRareModal()"><div id="rare-card-content" class="rare-card"><span id="rare-star-label"></span><span id="rare-name-label" class="rare-name"></span><div id="rare-desc-label" class="rare-desc"></div></div></div>
<div id="story-modal"><div class="story-content"><div style="text-align:left; margin-bottom:30px;">わたしはすべてをうばわれた……<br>しかし、それでもまだ諦めることを知らない光がある。<br><span class="story-vow">『再起の誓い』</span>が魂を激しく鼓動させる。<br><span style="color:#ff0000; font-weight:bold;">奴を一撃で葬るその日まで、わたしは止まるときを知らない。</span></div><button class="story-btn" onclick="closeStory()">魂に刻印する</button></div></div>
<div id="header"><div class="boss-area"><div id="boss-display-name" style="font-size:0.9em; color:#888;">終末神アポカリス＝ティア</div><div class="hp-bar-container"><div id="hp-bar-fill"></div></div><div class="hp-val-display" id="bosshp-cur">0</div></div><div class="status-box"><div class="stat-card"><div>ATK</div><div id="p-atk" style="font-weight:bold; font-family:monospace;">0</div></div><div class="stat-card" style="border-left-color:var(--hp);"><div>HP</div><div id="p-hp" style="font-weight:bold; font-family:monospace;">0</div></div></div></div>
<div class="nav"><button onclick="showTab('battle')" id="nav-battle" class="active">討伐</button><button onclick="showTab('vow')" id="nav-vow">再起</button><button onclick="showTab('relic')" id="nav-relic">遺物</button><button onclick="showTab('status')" id="nav-status">詳細</button></div>
<div id="content-area">
  <div id="battle" class="tab active"><button class="btn-attack" id="attackBtn">こうげき</button><div id="log"></div></div>
  <div id="vow" class="tab"><div id="vow-list"></div></div>
  <div id="relic" class="tab"><div class="relic-list-container" id="relic-list"></div></div>
  <div id="status" class="tab">
    <div class="rank-display"><div id="st-rank-lv" style="font-size:0.8em; color:#aaa;">Lv.1</div><div class="rank-title" id="st-rank-title">初心者</div></div>
    <div style="background:#f8f9fa; padding:10px; border-radius:8px; font-size:0.85em;">
        戦闘経験値: <span id="v-death">0</span><br>
        最高ダメージ: <span id="st-maxdmg">0</span><br>
        最終ダメージ倍率: <span id="st-dmgmult" style="color:var(--primary); font-weight:bold;">x1.00</span>
    </div>
    <button style="width:100%; margin-top:20px; padding:10px; background:#dc3545; color:#fff; border:none; border-radius:5px;" onclick="resetData()">全データリセット</button>
  </div>
</div>
<div class="ver-footer">RELICORE v1.4</div>
<script>
const SAVE_KEY = "relicore_player_data";
const BOSS_MAX_HP_BASE = 100000000000000000000n;
const MAJIN_ATK_BASE = 999999999999n;
let player = { inventory: { 0:1 }, deathCount:0, baseAtk:10n, baseHP:100n, maxDmg:0n, storySeen:false, isUra:false, bossMaxHP: BOSS_MAX_HP_BASE.toString() };
let currentBossHP = BigInt(player.bossMaxHP);
let attackInterval = null;
let isModalOpen = false;

const PLAYER_TITLES = ["初心者", "修練者", "熟練者", "探求者", "到達者", "解放者", "支配者", "超越者", "救世主", "極致：唯一神"];

function getLevelByDeath() { return Math.min(10, Math.floor(player.deathCount / 25000) + 1); }

const RELIC_MASTER = [
  {id:0, star:8, name:"再起の誓い", atk:0, hp:0, desc:"不屈の魂に刻まれた、再誕の原点。"},
  {id:101, star:1, name:"剣士の欠片", atk:7.4, hp:0}, {id:106, star:1, name:"衛兵の欠片", atk:0, hp:45.2},
  {id:401, star:4, name:"【不退転】武神の魂", atk:65000, hp:180000, desc: "獲得遺物数を加算。"},
  {id:402, star:4, name:"【刹那】聖者の遺志", atk:50000, hp:250000, desc: "HP上昇抽選回数を増加。"},
  {id:403, star:4, name:"【因果】魔導王の記憶", atk:75000, hp:150000, desc: "拒絶の下限を上昇。"},
  {id:404, star:4, name:"【反撃】勇者の残光", atk:90000, hp:120000, desc: "生存時ドロップ品質向上。"},
  {id:405, star:4, name:"【魂研】賢者の叡智", atk:55000, hp:220000, desc: "経験値ボーナス。"},
  {id:406, star:4, name:"【死刻】死神の鎌", atk:110000, hp:80000, desc: "死を刻む威力を加算。"},
  {id:701, star:7, name:"パンドラの箱", atk:150000000, hp:350000000, mult:100.0, desc:"神を討つための鍵。"}
];

function saveGame() { const data = { ...player, baseAtk: player.baseAtk.toString(), baseHP: player.baseHP.toString(), maxDmg: player.maxDmg.toString() }; localStorage.setItem(SAVE_KEY, JSON.stringify(data)); }
function loadGame() { let saved = localStorage.getItem(SAVE_KEY); if(saved) { const p = JSON.parse(saved); Object.assign(player, p); player.baseAtk = BigInt(p.baseAtk || "10"); player.baseHP = BigInt(p.baseHP || "100"); player.maxDmg = BigInt(p.maxDmg || "0"); currentBossHP = BigInt(player.bossMaxHP); } if(!player.storySeen) document.getElementById("story-modal").style.display = "flex"; }

function openRankUpModal(newLv) {
    if (attackInterval) { clearInterval(attackInterval); attackInterval = null; }
    isModalOpen = true;
    const msg = document.getElementById("rank-up-msg-text");
    msg.innerHTML = `魂の核が激しく鼓動する……！<br><br><span style="font-size:1.4em; color:var(--growth); font-weight:bold;">再起Lv.${newLv} 到達</span><br>称号が【${PLAYER_TITLES[newLv-1]}】に昇格し、<br>全ての再起スキルが強化された。`;
    document.getElementById("rank-up-modal").style.display = "flex";
}
function closeRankUpModal() { document.getElementById("rank-up-modal").style.display = "none"; isModalOpen = false; refreshUI(); }

function calcFinalDmgMult() {
  const lv = getLevelByDeath();
  const rate = (0.0004 + (lv * 0.0001)) * (1 + (player.inventory[406] || 0));
  return 1.0 + (player.deathCount * rate) / 100;
}

function renderVow() {
  const lv = getLevelByDeath();
  const skills = [
      { name: "不退転の力", highlight: `ボーナス：+${(player.inventory[401] || 0) + lv - 1}`, desc: "攻撃時に追加の遺物を刻む。" },
      { name: "刹那の堆積", highlight: `HP増加補正: x${(1 + lv * 0.5).toFixed(1)}`, desc: "再起時のHP成長率を高める。" },
      { name: "因果の拒絶", highlight: `無効化下限：${Math.min(30, player.inventory[403] || 0) + lv}%`, desc: "敵の攻撃を無効化する。" },
      { name: "反撃の狼煙", highlight: `生存ドロップ：★${(player.inventory[404] || 0) > 0 ? 3 : 2}以上`, desc: "生き残るたびに遺物を得る。" },
      { name: "魂の研磨", highlight: `経験ボーナス：+${lv + (player.inventory[405] || 0)}`, desc: "成長速度を加速させる。" },
      { name: "死を刻む", highlight: `最終倍率：x${calcFinalDmgMult().toFixed(4)}`, desc: "経験をダメージに変換する。" }
  ];
  let html = "";
  skills.forEach(s => {
      const lvText = lv >= 10 ? '<span class="vow-lv max">極</span>' : `<span class="vow-lv">Lv.${lv}</span>`;
      html += `<div class="vow-item"><div class="vow-header"><span class="vow-name">${s.name}</span>${lvText}</div><span class="vow-highlight">${s.highlight}</span><span class="vow-sub">${s.desc}</span></div>`;
  });
  document.getElementById('vow-list').innerHTML = html;
}

function attack() {
  if(isModalOpen) return;
  const b = getRelicBonus(); const finalDmgMult = calcFinalDmgMult();
  let rawBase = Number(player.baseAtk + b.atk) * b.mult;
  let finalDmg = BigInt(Math.floor(rawBase * (0.8 + Math.random() * 0.4) * finalDmgMult)) || 1n;
  if(finalDmg > player.maxDmg) player.maxDmg = finalDmg;

  let logHtml = `<div><span style="color:#007bff; font-weight:bold;">攻撃！${finalDmg.toLocaleString()} ダメージ！</span></div>`;
  const lv = getLevelByDeath();
  
  // 不退転：遺物ドロップ
  const dropCount = 1 + (player.inventory[401] || 0) + lv - 1;
  logHtml += getDropLog(dropCount);

  if(finalDmg >= currentBossHP) {
      if((player.inventory[701] || 0) > 0) { alert("神を討伐しました。"); currentBossHP = BigInt(player.bossMaxHP); } 
      else { currentBossHP = BigInt(player.bossMaxHP); logHtml += `<div><span style="color:#ff0000;">神の回帰（HP回復）</span></div>`; }
  } else {
      currentBossHP -= finalDmg;
  }

  // 敵の攻撃
  const currentTotalHP = BigInt(Math.floor(Number(player.baseHP + b.hp) * b.mult));
  let minCut = Math.min(30, player.inventory[403] || 0) + lv; 
  let finalMitigated = BigInt(Math.floor(Number(MAJIN_ATK_BASE) * (1 - (Math.floor(Math.random() * (101 - minCut)) + minCut) / 100)));

  const oldLv = getLevelByDeath();
  if (currentTotalHP > finalMitigated) {
      player.deathCount += (1 + (player.inventory[405] || 0) + lv);
      logHtml += `<div><span style="color:#28a745;">防御成功。</span></div>`;
  } else {
      let upHP = BigInt(Math.floor(Number(BigInt(Math.floor(10 + Math.random() * player.deathCount))) * (1 + lv * 0.5)));
      player.baseHP += upHP; player.deathCount += (1 + (player.inventory[405] || 0) + lv);
      logHtml += `<div><span style="color:#dc3545;">再起！ </span><span style="color:#007bff; font-weight:bold;">再起の誓いによって新たなる力を得た </span><span style="color:var(--growth);">(HP+${upHP.toLocaleString()})</span></div>`;
  }

  if(getLevelByDeath() > oldLv) openRankUpModal(getLevelByDeath());
  addLog(logHtml); saveGame(); refreshUI();
}

function getDropLog(count) {
  let obtained = "";
  for(let i=0; i<count; i++) {
    let sel = RELIC_MASTER[Math.floor(Math.random()*RELIC_MASTER.length)];
    if(sel.id === 0 || sel.star >= 4) { i--; continue; }
    player.inventory[sel.id] = (player.inventory[sel.id] || 0) + 1;
    obtained += `<span class="c${sel.star}">★${sel.star} ${sel.name} </span>`;
  }
  return obtained ? `<div>獲得：${obtained}</div>` : "";
}

function getRelicBonus() {
  let atk = 0n, hp = 0n, mult = 1.0;
  Object.entries(player.inventory).forEach(([id, count]) => {
      const r = RELIC_MASTER.find(m => m.id == id); if(!r) return;
      atk += BigInt(Math.floor(r.atk * count)); hp += BigInt(Math.floor(r.hp * count));
      if(r.mult) mult *= Math.pow(r.mult, count);
  });
  return { atk, hp, mult };
}

function refreshUI() {
  const b = getRelicBonus(); const lv = getLevelByDeath();
  document.getElementById("p-atk").innerText = BigInt(Math.floor(Number(player.baseAtk + b.atk) * b.mult)).toLocaleString();
  document.getElementById("p-hp").innerText = BigInt(Math.floor(Number(player.baseHP + b.hp) * b.mult)).toLocaleString();
  document.getElementById("bosshp-cur").innerText = currentBossHP.toLocaleString();
  document.getElementById("hp-bar-fill").style.width = `${Number(currentBossHP * 100n / BigInt(player.bossMaxHP))}%`;
  document.getElementById("st-rank-lv").innerText = `Lv.${lv}`;
  document.getElementById("st-rank-title").innerText = PLAYER_TITLES[lv - 1];
  document.getElementById("v-death").innerText = player.deathCount.toLocaleString();
  document.getElementById("st-maxdmg").innerText = player.maxDmg.toLocaleString();
  document.getElementById("st-dmgmult").innerText = "x" + calcFinalDmgMult().toFixed(4);
  const tid = document.querySelector(".tab.active").id;
  if(tid === 'vow') renderVow(); else if(tid === 'relic') renderRelics();
}

function renderRelics() {
  document.getElementById("relic-list").innerHTML = Object.entries(player.inventory).filter(([id, c]) => c > 0).map(([id, c]) => {
      const m = RELIC_MASTER.find(x => x.id == id);
      return `<div class="relic-card ${m.star>=4?'star-high':''}"><div class="c${m.star}" style="font-size:0.7em;">★${m.star} ${m.name}×${c}</div></div>`;
  }).join("");
}

function showTab(id) { document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active")); document.querySelectorAll(".nav button").forEach(b=>b.classList.remove("active")); document.getElementById(id).classList.add("active"); document.getElementById("nav-"+id).classList.add("active"); refreshUI(); }
function addLog(html) { const l = document.getElementById("log"); const d = document.createElement("div"); d.style.padding="4px 0; border-bottom:1px solid #eee;"; d.innerHTML=html; l.prepend(d); if(l.childNodes.length > 20) l.removeChild(l.lastChild); }
function closeStory() { player.storySeen = true; document.getElementById("story-modal").style.display = "none"; saveGame(); }
function closeRareModal() { document.getElementById("rare-drop-modal").style.display = "none"; isModalOpen = false; }
function resetData() { if(confirm("リセットしますか？")) { localStorage.clear(); location.reload(); } }

const btn = document.getElementById("attackBtn");
btn.addEventListener("pointerdown", (e) => { e.preventDefault(); if(!attackInterval && !isModalOpen) { attack(); attackInterval = setInterval(attack, 120); } });
window.addEventListener("pointerup", () => { clearInterval(attackInterval); attackInterval = null; });
loadGame(); refreshUI();
</script>
</body>
</html>

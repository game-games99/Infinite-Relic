<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>infiniterelic</title>
<style>
    :root {
        --bg: #ffffff; --panel: #f8f9fa; --border: #dee2e6;
        --primary: #007bff; --text: #212529; --sub: #6c757d;
        --accent: #dc3545; --gold: #d39e00; --hp: #28a745;
    }
    body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
    
    /* UIÂõ∫ÂÆö„Ç®„É™„Ç¢ */
    #header { background: var(--panel); padding: 10px; border-bottom: 2px solid var(--border); flex-shrink: 0; }
    .nav { display: flex; background: var(--panel); border-bottom: 1px solid var(--border); flex-shrink: 0; overflow-x: auto; }
    .nav button { flex: 1; min-width: 80px; padding: 12px 0; border: none; background: none; color: var(--sub); font-weight: bold; font-size: 0.75em; cursor: pointer; white-space: nowrap; }
    .nav button.active { color: var(--primary); border-bottom: 3px solid var(--primary); background: #fff; }

    /* „Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢ */
    #content { flex-grow: 1; overflow: hidden; position: relative; background: #fff; }
    .tab { display: none; padding: 10px; height: 100%; box-sizing: border-box; overflow-y: auto; }
    .tab.active { display: block; }

    /* „Éê„ÉºË°®Á§∫ */
    .bar-container { margin-bottom: 4px; }
    .bar-label { display: flex; justify-content: space-between; font-size: 0.75em; font-weight: bold; }
    .bar { height: 8px; background: #eee; border-radius: 4px; overflow: hidden; }
    .fill { height: 100%; transition: width 0.1s ease; }
    #bosshp { background: linear-gradient(90deg, #ffc107, #dc3545); }
    #playerhp { background: var(--hp); }
    #exp-bar { background: var(--primary); }
    
    .stats-summary { margin-top: 6px; background: rgba(0,0,0,0.03); padding: 8px; border-radius: 4px; font-size: 0.8em; }
    .stat-row { display: flex; justify-content: space-between; font-weight: bold; }

    /* „Ç´„Éº„Éâ„Éª„É™„Çπ„ÉàË°®Á§∫ */
    .grid-1col { display: grid; grid-template-columns: 1fr; gap: 10px; padding-bottom: 120px; }
    .card-cell { background: #fff; border: 1px solid var(--border); padding: 12px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    
    .skill-list { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-top: 8px; }
    .skill-item { font-size: 0.6em; padding: 4px; border-radius: 4px; background: #f1f3f5; border-left: 2px solid var(--border); color: #888; }
    .skill-unlocked { border-left-color: var(--primary); background: #e7f5ff; color: #000; font-weight: bold; }

    .btn-attack { width: 100%; padding: 20px; background: var(--primary); color: #fff; font-size: 1.1em; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; user-select: none; margin-bottom: 10px; }
    #log { font-size: 0.75em; background: #fdfdfd; padding: 8px; border: 1px solid var(--border); border-radius: 6px; height: 150px; overflow-y: auto; }
    
    .status-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; font-size: 0.9em; }
    .relic-effect { font-size: 0.75em; color: var(--hp); font-weight: bold; margin-top: 4px; }
    .unique-tag { background: var(--accent); color: #fff; font-size: 0.6em; padding: 2px 4px; border-radius: 3px; margin-left: 5px; }
</style>
</head>
<body>

<div id="header">
    <div class="bar-container"><div class="bar-label"><span>È≠îÁ•û</span><span id="bosshp-text">100%</span></div><div class="bar"><div id="bosshp" class="fill"></div></div></div>
    <div class="bar-container"><div class="bar-label"><span>HP</span><span id="playerhp-text">0 / 0</span></div><div class="bar"><div id="playerhp" class="fill"></div></div></div>
    <div class="bar-container"><div class="bar-label"><span id="p-lv-text">Lv.1</span><span id="exp-text">0%</span></div><div class="bar"><div id="exp-bar" class="fill"></div></div></div>
    <div class="stats-summary"><div class="stat-row"><span>ATK:</span><span id="sum-atk">0</span></div></div>
</div>

<div class="nav">
    <button onclick="showTab('battle', this)" class="active">Ë®é‰ºê</button>
    <button onclick="showTab('status', this)">„Çπ„ÉÜ„Éº„Çø„Çπ</button>
    <button onclick="showTab('power', this)">Â§±„Çè„Çå„ÅüÊ®©ËÉΩ</button>
    <button onclick="showTab('relic', this)">ÈÅ∫Áâ©</button>
</div>

<div id="content">
    <div id="battle" class="tab active">
        <button class="btn-attack" id="attackBtn">È≠îÁ•û„Å´ÊîªÊíÉÔºàÈï∑Êäº„ÅóÔºâ</button>
        <div id="log"></div>
    </div>
    <div id="status" class="tab"><div id="statusList"></div></div>
    <div id="power" class="tab"><div id="powerList" class="grid-1col"></div></div>
    <div id="relic" class="tab"><div id="relicList" class="grid-1col"></div></div>
</div>

<script>
const BOSS_MAX_HP = 1e24;
const SAVE_KEY = "MAJIN_DPS_V8_FIX";
const RELIC_GRADES = ["Ê¨†Áâá", "ÂøÉÂæó", "Ë®òÊÜ∂", "Ê•µÊÑè", "È≠Ç", "Á•ûÂüü", "Ê∑±Ê∑µ", "ËôöÁÑ°", "ÁúüÁêÜ", "Ë∂ÖË∂ä"];
const STEPS = [10, 50, 150, 300, 500, 800, 1200, 2000, 3500, 5000];
const POWER_NAMES = ["Ââ£Á•û„ÅÆÊÆãÁÅ´","‰∏çÊªÖ„ÅÆÂÆàË≠∑ËÄÖ","È≠îÂ∞éÁéã„ÅÆÈÅ∫Âøó","Ë¶áÁéã„ÅÆÊÆãÂÖâ","Áµ∂ÂΩ±„ÅÆÊÆãÂΩ±","‰øÆÁæÖ„ÅÆÂíÜÂìÆ","ÁúüÁêÜ„ÅÆÊÆãÊªì","Á•ûË®ó„ÅÆÊÆãÈüø","ËôöÁÑ°„ÅÆÊ∑±Ê∑µ","Ê©üÂ∑•„ÅÆÂøÉËáì"];

const POWER_DATA = {};
POWER_NAMES.forEach((name, idx) => {
    POWER_DATA[name] = {
        sIdx: idx,
        skills: Array.from({length:10}, (_,i)=>({req:STEPS[i], n:`Á•ûÊäÄ-${i+1}`, e:`Ê®©ËÉΩËß£Êîæ-${i+1}`}))
    };
});

let p, currentBossHP = BOSS_MAX_HP, longPressInterval = null;

function init() {
    const saved = localStorage.getItem(SAVE_KEY);
    p = saved ? JSON.parse(saved) : { lv: 1, exp: 0, inventory: {}, deathCount: 0 };
    if (!p.inventory) p.inventory = {};
    const btn = document.getElementById("attackBtn");
    
    const start = (e) => { e.preventDefault(); if(!longPressInterval){ battle(); longPressInterval = setInterval(battle, 100); } };
    const stop = () => { if(longPressInterval){ clearInterval(longPressInterval); longPressInterval = null; } };
    
    btn.addEventListener("touchstart", start); btn.addEventListener("touchend", stop);
    btn.addEventListener("mousedown", start); btn.addEventListener("mouseup", stop); btn.addEventListener("mouseleave", stop);
    
    refresh();
}

function getSystemRelicCount(name) {
    const sIdx = POWER_DATA[name].sIdx;
    let count = 0;
    for(let i=0; i<10; i++) {
        const id = sIdx * 10 + i;
        count += (p.inventory[id] || 0);
    }
    return count;
}

function calcStats() {
    const maxHP = p.lv * 2000 + 100;
    let relicAtkBonus = 0;
    Object.keys(p.inventory).forEach(id => {
        const count = p.inventory[id];
        const grade = id % 10;
        const power = (grade < 5) ? (5000 * (grade + 1) * count) : (1000000 * (grade + 1) * count);
        relicAtkBonus += power;
    });

    let s = { 
        maxHP: maxHP,
        baseAtk: 5000 + (p.lv * 2500) + relicAtkBonus, 
        deathM: 1 + (p.deathCount * 0.01), 
        multi: 1, crit: 5, critM: 2.0, hits: 1 
    };
    
    // Ââ£Á•û„Çπ„Ç≠„É´„ÅÆÁ∞°ÊòìÂèçÊò†
    if(getSystemRelicCount("Ââ£Á•û„ÅÆÊÆãÁÅ´") >= STEPS[0]) s.multi *= 5;

    s.finalAtk = s.baseAtk * s.deathM * s.multi;
    return s;
}

function battle() {
    const s = calcStats();
    currentBossHP -= s.finalAtk;
    if(currentBossHP < 0) currentBossHP = 0;

    p.deathCount++;
    p.exp += (p.lv * 100) + 1000;

    // ÈÅ∫Áâ©„Éâ„É≠„ÉÉ„Éó
    if (Math.random() < 0.3) {
        const rid = Math.floor(Math.random() * 100);
        const grade = rid % 10;
        // ‚≠êÔ∏é6‰ª•‰∏ä„ÅØ1„Å§ÈôêÂÆö
        if(grade < 5 || !p.inventory[rid]) {
            p.inventory[rid] = (p.inventory[rid] || 0) + 1;
            const name = POWER_NAMES[Math.floor(rid/10)].split("„ÅÆ")[0];
            addLog(`<span style="color:var(--gold)">üíé ‚≠êÔ∏é${grade+1} ${name}„ÅÆ${RELIC_GRADES[grade]} Áç≤Âæó</span>`);
        }
    }

    const nextExp = p.lv ** 2 * 1200;
    while (p.exp >= nextExp) { p.exp -= nextExp; p.lv++; }
    refresh();
}

function refresh() {
    const s = calcStats();
    const nextExp = p.lv ** 2 * 1200;
    
    const bossPer = (currentBossHP / BOSS_MAX_HP * 100);
    document.getElementById("bosshp").style.width = bossPer + "%";
    document.getElementById("bosshp-text").innerText = (bossPer < 100 && currentBossHP > 0) ? bossPer.toFixed(8) + "%" : Math.ceil(bossPer) + "%";
    document.getElementById("playerhp-text").innerText = `${Math.floor(s.maxHP).toLocaleString()} / ${Math.floor(s.maxHP).toLocaleString()}`;
    document.getElementById("playerhp").style.width = "100%";
    document.getElementById("exp-bar").style.width = (p.exp / nextExp * 100) + "%";
    document.getElementById("exp-text").innerText = Math.floor(p.exp / nextExp * 100) + "%";
    document.getElementById("p-lv-text").innerText = `Lv.${p.lv.toLocaleString()}`;
    document.getElementById("sum-atk").innerText = Math.floor(s.finalAtk).toLocaleString();

    if (document.getElementById("status").classList.contains("active")) renderStatus(s);
    if (document.getElementById("power").classList.contains("active")) renderPowers();
    if (document.getElementById("relic").classList.contains("active")) renderRelics();
    
    localStorage.setItem(SAVE_KEY, JSON.stringify(p));
}

function renderStatus(s) {
    document.getElementById("statusList").innerHTML = `
        <div class="status-item"><span>ÊúÄÂ§ßHP</span><span>${Math.floor(s.maxHP).toLocaleString()}</span></div>
        <div class="status-item"><span>Âü∫Á§éATK</span><span>${Math.floor(s.baseAtk).toLocaleString()}</span></div>
        <div class="status-item"><span>ÂÜçËµ∑„ÅÆË™ì„ÅÑ</span><span>${p.deathCount.toLocaleString()} Âõû</span></div>
        <div class="status-item"><span>ÊúÄÁµÇÂÆüÂäπATK</span><span>${Math.floor(s.finalAtk).toLocaleString()}</span></div>
        <div class="status-item"><span>ÈÄ£ÊíÉÊï∞</span><span>${s.hits} Hit</span></div>
    `;
}

function renderPowers() {
    document.getElementById("powerList").innerHTML = Object.keys(POWER_DATA).map(name => {
        const count = getSystemRelicCount(name);
        return `<div class="card-cell"><b>${name}</b> (ÈÅ∫Áâ©:${count})<div class="skill-list">${POWER_DATA[name].skills.map(sk => `<div class="skill-item ${count >= sk.req ? 'skill-unlocked' : ''}">${sk.n}<br><small>${count >= sk.req ? 'Ëß£ÊîæÊ∏à' : sk.req+'ÂÄã'}</small></div>`).join("")}</div></div>`;
    }).join("");
}

function renderRelics() {
    const ids = Object.keys(p.inventory).filter(id => p.inventory[id] > 0).sort((a,b)=>a-b);
    document.getElementById("relicList").innerHTML = ids.length ? ids.map(id => {
        const typeIdx = Math.floor(id / 10);
        const gradeIdx = id % 10;
        const baseName = POWER_NAMES[typeIdx].split("„ÅÆ")[0];
        const effect = (gradeIdx < 5) ? (5000 * (gradeIdx + 1) * p.inventory[id]) : (1000000 * (gradeIdx + 1));
        return `<div class="card-cell">
            <div style="display:flex; justify-content:space-between;"><b>‚≠êÔ∏é${gradeIdx + 1} ${baseName}„ÅÆ${RELIC_GRADES[gradeIdx]}${gradeIdx>=5?'<span class="unique-tag">ÂîØ‰∏Ä</span>':''}</b> <span>√ó${p.inventory[id]}</span></div>
            <div class="relic-effect">ÂäπÊûú: Âü∫Á§éATK +${effect.toLocaleString()}</div>
        </div>`;
    }).join("") : "<p style='text-align:center;'>ÈÅ∫Áâ©„ÅØÊú™Áô∫Ë¶ã</p>";
}

function showTab(id, btn) {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.getElementById(id).classList.add("active");
    document.querySelectorAll(".nav button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    refresh();
}

function addLog(m) {
    const l = document.getElementById("log");
    const d = document.createElement("div"); d.innerHTML = m;
    l.prepend(d); if (l.childNodes.length > 20) l.removeChild(l.lastChild);
}
init();
</script>
</body>
</html>

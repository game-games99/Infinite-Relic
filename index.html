<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>é­”ç¥è¨ä¼ä¼ - çœŸãƒ»DPSç©¶æ¥µé€²åŒ– -</title>
<style>
    /* æ—¢å­˜ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç¶™æ‰¿ã—ã¤ã¤ã€ãƒ­ã‚°ã®è¦–èªæ€§ã‚’å‘ä¸Š */
    :root {
        --bg: #ffffff; --panel: #f8f9fa; --border: #dee2e6;
        --primary: #007bff; --text: #212529; --sub: #6c757d;
        --accent: #dc3545; --gold: #d39e00; --death: #6f42c1; --exp: #28a745;
    }
    body { background: var(--bg); color: var(--text); font-family: 'Helvetica Neue', Arial, sans-serif; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
    #header { background: var(--panel); padding: 8px 12px; border-bottom: 2px solid var(--border); flex-shrink: 0; font-size: 0.8em; }
    .bar-container { margin-bottom: 4px; }
    .bar-label { display: flex; justify-content: space-between; font-size: 0.7em; margin-bottom: 1px; }
    .bar { height: 6px; background: #e9ecef; border-radius: 3px; overflow: hidden; border: 1px solid rgba(0,0,0,0.05); }
    .fill { height: 100%; transition: width 0.1s ease; }
    #bosshp { background: linear-gradient(90deg, #ffc107, #dc3545); }
    #playerhp { background: linear-gradient(90deg, #28a745, #20c997); }
    #exp-bar { background: var(--primary); }
    #job-exp-bar { background: var(--death); }
    .stats-summary { display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px; margin-top: 5px; background: rgba(0,0,0,0.03); padding: 5px; border-radius: 4px; }
    .stat-item { display: flex; justify-content: space-between; font-size: 0.85em; }
    .nav { display: flex; background: var(--panel); border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .nav button { flex: 1; padding: 10px 0; border: none; background: none; color: var(--sub); font-weight: bold; font-size: 0.75em; cursor: pointer; }
    .nav button.active { color: var(--primary); border-bottom: 3px solid var(--primary); background: #fff; }
    #content { flex-grow: 1; overflow-y: auto; position: relative; }
    .tab { display: none; padding: 12px; height: 100%; box-sizing: border-box; }
    .tab.active { display: block; }
    .dps-display { text-align: center; padding: 10px; background: #212529; color: #00ff00; font-family: monospace; font-size: 1.2em; border-radius: 4px; margin-bottom: 10px; }
    .btn-attack { width: 100%; padding: 18px; background: var(--primary); color: #fff; font-size: 1.1em; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; }
    #log { flex-grow: 1; margin-top: 8px; overflow-y: auto; font-size: 0.75em; background: #fafafa; padding: 8px; border: 1px solid var(--border); border-radius: 4px; }
    .log-entry { margin-bottom: 2px; border-bottom: 1px solid #eee; }
    .relic-cell { background: #fff; border: 1px solid var(--border); padding: 6px; font-size: 0.7em; display: flex; flex-direction: column; cursor: pointer; }
    .detail-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: #fff; z-index: 20; padding: 15px; display: none; }
</style>
</head>
<body>

<div id="header">
    <div class="bar-container">
        <div class="bar-label"><span>é­”ç¥</span><span id="bosshp-text">100.00%</span></div>
        <div class="bar"><div id="bosshp" class="fill"></div></div>
    </div>
    <div class="bar-container">
        <div class="bar-label"><span>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼HP</span><span id="playerhp-text">0/0</span></div>
        <div class="bar"><div id="playerhp" class="fill"></div></div>
    </div>
    <div class="bar-container">
        <div class="bar-label"><span id="p-lv-text">Lv.1 ä¸»äººå…¬</span><span id="exp-text">0%</span></div>
        <div class="bar"><div id="exp-bar" class="fill"></div></div>
    </div>
    <div class="bar-container">
        <div class="bar-label"><span id="p-job-text">å‰£è– Lv.1</span><span id="job-exp-text">0%</span></div>
        <div class="bar"><div id="job-exp-bar" class="fill"></div></div>
    </div>
    <div class="stats-summary">
        <div class="stat-item"><span>ATK:</span><span id="sum-atk">0</span></div>
        <div class="stat-item"><span>æ•—åŒ—æ•°:</span><span id="sum-death" style="color:var(--death)">0</span></div>
        <div class="stat-item"><span>ã‚¯ãƒªç‡:</span><span id="sum-crit">5%</span></div>
        <div class="stat-item"><span>å¢—å¹…:</span><span id="sum-dmg">100%</span></div>
    </div>
</div>

<div class="nav">
    <button onclick="showTab('battle', this)" class="active">è¨ä¼</button>
    <button onclick="showTab('status', this)">è©³ç´°æƒ…å ±</button>
    <button onclick="showTab('job', this)">è·æ¥­</button>
    <button onclick="showTab('equip', this)">éºç‰©</button>
</div>

<div id="content">
    <div id="battle" class="tab active">
        <div style="display:flex; flex-direction:column; height:100%;">
            <div class="dps-display">DPS: <span id="dps-val">0</span></div>
            <button class="btn-attack" id="attackBtn">é­”ç¥ã«æ”»æ’ƒ</button>
            <div id="log"></div>
        </div>
    </div>
    <div id="status" class="tab"></div>
    <div id="job" class="tab"><div id="jobList"></div></div>
    <div id="equip" class="tab"><div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:4px;" id="relicGrid"></div></div>
    <div id="detailPanel" class="detail-overlay"><button onclick="closeDetail()">æˆ»ã‚‹</button><div id="detailContent"></div></div>
</div>

<script>
const BOSS_MAX_HP = 1e24;
const SAVE_KEY = "MAJIN_DPS_V7";

let p, longPressIdx, isProcessing = false;
let dpsPool = [];
let currentBossHP = BOSS_MAX_HP;

// éºç‰©250ç¨®ç”¨ã®åå‰ç”Ÿæˆãƒ†ãƒ¼ãƒ–ãƒ«
const R_ADJ = ["å¤ã®", "é­‚ã®", "å¹»ã®", "æ­»ã‚’å–°ã‚‰ã†", "è–ãªã‚‹", "æ·±æ·µã®", "é»„é‡‘ã®", "æœ½ã¡ãŸ", "è¼ã", "ç¦å¿Œã®"];
const R_MAT = ["ç«œã®", "ç¥ã®", "é­”ç‹ã®", "è³¢è€…ã®", "æ˜Ÿã®", "é‹¼ã®", "å…‰ã®", "é—‡ã®", "çµæ™¶ã®", "ç²¾éœŠã®"];
const R_OBJ = ["ç§˜çŸ³", "å®å…·", "ç´‹ç« ", "è…•è¼ª", "å‰£", "ç›¾", "é¦–é£¾ã‚Š", "æŒ‡è¼ª", "é­”å°æ›¸", "ç‰™"];

function getRelicData(id) {
    const seed = parseInt(id);
    // é‡è¤‡ã‚’é¿ã‘ã‚‹ãŸã‚ã®åç§°çµ„ã¿åˆã‚ã›
    const name = R_ADJ[seed % 10] + R_MAT[Math.floor(seed / 10) % 10] + R_OBJ[Math.floor(seed / 25) % 10];
    
    const typeKey = ["ATK", "CRIT", "C_DMG", "FAST"][seed % 4];
    const isDeathType = (seed % 13 === 0);
    const isGold = (seed % 50 === 0);
    const baseVal = isGold ? (seed % 5 + 5) * 10 : (seed % 5 + 1);
    
    let effectText = "";
    if (typeKey === "ATK") effectText = `ATK +${baseVal * 10}`;
    else if (typeKey === "CRIT") effectText = `Critç‡ +${baseVal}%`;
    else if (typeKey === "C_DMG") effectText = `Critå€ç‡ +${baseVal*10}%`;
    else if (typeKey === "FAST") effectText = `çµŒé¨“åŠ¹ç‡ +${baseVal}%`;
    if (isDeathType) effectText = "æ•—åŒ—æ•°ã«ã‚ˆã‚‹æ”»æ’ƒåŠ›å¢—å¹…";

    return { id, name, typeKey, val: baseVal, effectText, isGold, isDeathType };
}

function init() {
    const saved = localStorage.getItem(SAVE_KEY);
    p = saved ? JSON.parse(saved) : {
        lv: 1, exp: 0, job: "å‰£è–", inventory: {}, 
        jobLevels: {"å‰£è–":1}, jobExp: {"å‰£è–":0}, deathCount: 0
    };
    
    const btn = document.getElementById("attackBtn");
    const handleStart = (e) => { e.preventDefault(); if(!longPressIdx) { battle(); longPressIdx = setInterval(battle, 100); } };
    const handleStop = () => { clearInterval(longPressIdx); longPressIdx = null; };
    btn.addEventListener("mousedown", handleStart); btn.addEventListener("mouseup", handleStop);
    btn.addEventListener("touchstart", handleStart, {passive: false}); btn.addEventListener("touchend", handleStop);
    
    setInterval(updateDPS, 1000);
    refresh();
}

function calcStats() {
    let baseAtk = 1000 + (p.lv * 100) + (p.jobLevels[p.job] * 50);
    let stats = { atk: baseAtk, crit: 5, critM: 1.5, deathM: 1.0, fast: 1.0, maxHP: 1000 + (p.lv * 500) };
    
    Object.keys(p.inventory).forEach(id => {
        const d = getRelicData(id); const count = p.inventory[id];
        if (d.isDeathType) stats.deathM += (p.deathCount * 0.001 * count);
        else {
            if (d.typeKey === "ATK") stats.atk += d.val * 10 * count;
            if (d.typeKey === "CRIT") stats.crit += d.val * count;
            if (d.typeKey === "C_DMG") stats.critM += (d.val * 0.1 * count);
            if (d.typeKey === "FAST") stats.fast += (d.val * 0.05 * count);
        }
    });
    return stats;
}

function battle() {
    if (isProcessing) return;
    isProcessing = true;
    
    let stats = calcStats();
    let isCrit = Math.random() < (stats.crit / 100);
    let dmg = Math.floor(stats.atk * (0.9 + Math.random() * 0.2) * stats.deathM);
    if (isCrit) dmg = Math.floor(dmg * stats.critM);

    // æ•µHPå‡¦ç†
    if (dmg >= currentBossHP) {
        addLog(`<span style="color:var(--gold);font-weight:bold;">âœ¨ é­”ç¥ã‚’å®Œå…¨ã«è¨ä¼ï¼æ–°ãŸãªã‚‹å€‹ä½“ãŒç¾ã‚ŒãŸã€‚</span>`);
        currentBossHP = BOSS_MAX_HP;
    } else {
        currentBossHP -= dmg;
        if (currentBossHP < 1) {
            addLog(`<span style="color:var(--accent);">âš ï¸ å‰Šã‚Šåˆ‡ã‚Œãªã‹ã£ãŸï¼é­”ç¥ãŒæ¨©èƒ½ã§å…¨å›å¾©ã—ãŸã€‚</span>`);
            currentBossHP = BOSS_MAX_HP;
        }
    }

    dpsPool.push(dmg);
    addLog(`âš”ï¸ é­”ç¥ã« ${dmg.toLocaleString()} ãƒ€ãƒ¡ãƒ¼ã‚¸ ${isCrit?'(CRIT!)':''}`);

    // è¢«ãƒ€ãƒ¡ãƒ¼ã‚¸
    let enemyDmg = Math.floor(stats.maxHP * 0.1);
    addLog(`<span style="color:var(--accent);">ğŸ’¥ é­”ç¥ã®åæ’ƒï¼š${enemyDmg.toLocaleString()} ãƒ€ãƒ¡ãƒ¼ã‚¸</span>`);
    p.deathCount++; // ã“ã®ã‚²ãƒ¼ãƒ ã§ã¯æ”»æ’ƒã”ã¨ã«ã€Œæ•—åŒ—ï¼ˆã®è“„ç©ï¼‰ã€ã‚’ã‚«ã‚¦ãƒ³ãƒˆ

    // çµŒé¨“å€¤
    let gainExp = Math.floor(dmg * 0.001 * stats.fast) + 10;
    p.exp += gainExp;
    p.jobExp[p.job] = (p.jobExp[p.job] || 0) + gainExp;
    addLog(`<span style="color:var(--exp);">ï¼‹ ${gainExp} EXP ç²å¾—</span>`);

    // éºç‰©ãƒ‰ãƒ­ãƒƒãƒ—
    if (Math.random() < 0.15) {
        let rId = Math.floor(Math.random() * 250);
        p.inventory[rId] = (p.inventory[rId] || 0) + 1;
        addLog(`<span style="color:var(--gold)">â˜… éºç‰©å…¥æ‰‹: ${getRelicData(rId).name}</span>`);
    }

    checkLevelUp();
    refresh();
    isProcessing = false;
}

function checkLevelUp() {
    const getNext = (lv) => Math.pow(lv, 3) * 500;
    while (p.exp >= getNext(p.lv)) {
        p.exp -= getNext(p.lv);
        p.lv++;
        addLog(`<span style="color:var(--primary);font-weight:bold;">â¬†ï¸ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼LvãŒ ${p.lv} ã«ä¸ŠãŒã£ãŸï¼</span>`);
    }
    const getJNext = (lv) => Math.pow(lv, 3) * 300;
    let jl = p.jobLevels[p.job] || 1;
    while (p.jobExp[p.job] >= getJNext(jl)) {
        p.jobExp[p.job] -= getJNext(jl);
        jl++;
        p.jobLevels[p.job] = jl;
        addLog(`<span style="color:var(--death);font-weight:bold;">â¬†ï¸ è·æ¥­ï¼š${p.job}LvãŒ ${jl} ã«ä¸ŠãŒã£ãŸï¼</span>`);
    }
}

function refresh() {
    const stats = calcStats();
    const hpPer = (currentBossHP / BOSS_MAX_HP * 100);
    document.getElementById("bosshp").style.width = hpPer + "%";
    document.getElementById("bosshp-text").innerText = hpPer.toFixed(10) + "%";
    document.getElementById("playerhp-text").innerText = `${stats.maxHP.toLocaleString()} / ${stats.maxHP.toLocaleString()}`;
    
    document.getElementById("p-lv-text").innerText = `Lv.${p.lv} ä¸»äººå…¬`;
    document.getElementById("exp-bar").style.width = (p.exp / (Math.pow(p.lv, 3) * 500) * 100) + "%";
    
    document.getElementById("p-job-text").innerText = `${p.job} Lv.${p.jobLevels[p.job] || 1}`;
    document.getElementById("job-exp-bar").style.width = (p.jobExp[p.job] / (Math.pow(p.jobLevels[p.job], 3) * 300) * 100) + "%";

    document.getElementById("sum-atk").innerText = Math.floor(stats.atk * stats.deathM).toLocaleString();
    document.getElementById("sum-death").innerText = p.deathCount.toLocaleString();
    document.getElementById("sum-crit").innerText = stats.crit + "%";
    document.getElementById("sum-dmg").innerText = Math.floor(stats.deathM * 100) + "%";

    if (document.getElementById("equip").classList.contains("active")) renderEquip();
    localStorage.setItem(SAVE_KEY, JSON.stringify(p));
}

function addLog(m) {
    const l = document.getElementById("log");
    const d = document.createElement("div"); d.className = "log-entry"; d.innerHTML = m;
    l.prepend(d); if (l.childNodes.length > 50) l.removeChild(l.lastChild);
}

function renderEquip() {
    document.getElementById("relicGrid").innerHTML = Object.keys(p.inventory).map(id => {
        const d = getRelicData(id);
        return `<div class="relic-cell" onclick="openRelicDetail(${id})">
            <span style="font-weight:bold; ${d.isGold?'color:var(--gold)':''}">${d.name}</span>
            <span>Ã—${p.inventory[id]}</span>
        </div>`;
    }).join("");
}

function updateDPS() {
    let total = dpsPool.reduce((a, b) => a + b, 0);
    document.getElementById("dps-val").innerText = total.toLocaleString();
    dpsPool = [];
}

function showTab(id, btn) {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.getElementById(id).classList.add("active");
    document.querySelectorAll(".nav button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active"); refresh();
}

function openRelicDetail(id) {
    const d = getRelicData(id);
    document.getElementById("detailContent").innerHTML = `<h3>${d.name}</h3><hr><p>${d.effectText}</p><p>æ‰€æŒæ•°: ${p.inventory[id]}</p>`;
    document.getElementById("detailPanel").style.display = "block";
}
function closeDetail() { document.getElementById("detailPanel").style.display = "none"; }

init();
</script>
</body>
</html>

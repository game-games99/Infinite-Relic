<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>infiniterelic</title>
<style>
    :root { --bg: #ffffff; --panel: #f8f9fa; --border: #dee2e6; --primary: #007bff; --text: #212529; --hp: #dc3545; --exp: #007bff; --player-hp: #28a745; --rare: #ffc107; --epic: #ff00ff; }
    body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
    #header { background: var(--panel); padding: 10px; border-bottom: 2px solid var(--border); flex-shrink: 0; }
    .nav { display: flex; background: var(--panel); border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .nav button { flex: 1; padding: 15px 0; border: none; background: none; color: #6c757d; font-weight: bold; font-size: 0.8em; cursor: pointer; }
    .nav button.active { color: var(--primary); border-bottom: 3px solid var(--primary); background: #fff; }
    #content-area { flex-grow: 1; overflow-y: auto; }
    .tab { display: none; padding: 15px; box-sizing: border-box; }
    .tab.active { display: block; padding-bottom: 100px; }
    .bar-label { display: flex; justify-content: space-between; font-size: 0.75em; font-weight: bold; }
    .bar { height: 10px; background: #eee; border-radius: 5px; overflow: hidden; margin: 4px 0 8px; }
    .fill { height: 100%; transition: width 0.1s ease; }
    .card-cell { background: #fff; border: 1px solid var(--border); padding: 12px; border-radius: 8px; margin-bottom: 15px; }
    .skill-grid { display: grid; gap: 6px; margin-top: 8px; }
    .skill-item { font-size: 0.7em; padding: 8px; border-radius: 4px; border-left: 4px solid #ddd; }
    .p-skill { background: #f8f9fa; border-left-color: #adb5bd; }
    .a-skill { background: #e7f5ff; border-left-color: var(--primary); font-weight: bold; }
    .btn-attack { width: 100%; padding: 25px; background: var(--primary); color: #fff; font-size: 1.2em; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; }
    #log { font-size: 0.8em; background: #fafafa; padding: 10px; border: 1px solid var(--border); border-radius: 8px; height: 220px; overflow-y: auto; margin-top: 15px; }
    .relic-rare { border: 2px solid var(--rare); background: #fffdf5; box-shadow: 0 0 10px rgba(255,193,7,0.3); }
    .stat-row { display: flex; justify-content: space-between; font-size: 0.9em; padding: 4px 0; border-bottom: 1px solid #eee; }
    .stat-val { font-weight: bold; color: var(--primary); }
    /* 演出用エフェクト */
    @keyframes flash { 0% { background: white; } 50% { background: gold; } 100% { background: white; } }
    .flash-effect { animation: flash 0.5s ease-out; }
</style>
</head>
<body id="game-body">

<div id="header">
    <div class="bar-label"><span>魔神 HP</span><span id="bosshp-text">100%</span></div>
    <div class="bar"><div id="bosshp" class="fill" style="background:var(--hp); width:100%"></div></div>
    <div class="bar-label"><span>経験値</span><span id="exp-text">0%</span></div>
    <div class="bar"><div id="exp-bar" class="fill" style="background:var(--exp); width:0%"></div></div>
    <div class="bar-label"><span>プレイヤー HP</span><span id="playerhp-text">100/100</span></div>
    <div class="bar"><div id="playerhp" class="fill" style="background:var(--player-hp); width:100%"></div></div>
    <div style="font-size:0.8em; font-weight:bold; display:flex; justify-content:space-between; margin-top:5px;">
        <span>Lv: <span id="p-lv">1</span></span>
        <span>ATK: <span id="p-atk">0</span></span>
        <span>再起の誓い: <span id="p-death">0</span></span>
    </div>
</div>

<div class="nav">
    <button id="nav-battle" onclick="showTab('battle')" class="active">討伐</button>
    <button id="nav-status" onclick="showTab('status')">能力</button>
    <button id="nav-power" onclick="showTab('power')">権能</button>
    <button id="nav-relic" onclick="showTab('relic')">遺物</button>
</div>

<div id="content-area">
    <div id="battle" class="tab active"><button class="btn-attack" id="attackBtn">こうげき</button><div id="log"></div></div>
    <div id="status" class="tab"></div>
    <div id="power" class="tab"></div>
    <div id="relic" class="tab"></div>
</div>

<script>
const POWER_NAMES = ["剣神の残火","不滅の守護者","魔導王の遺志","覇王の残光","絶影の残影","修羅の咆哮","真理の残滓","神託の残響","虚無の深淵","機工の心臓"];
const SKILL_DATA = [
    ["一の太刀:ATK5倍","燕返し:追撃30%","心眼:会心+40%","無想:威力10倍","天断:1000倍","神速:2倍速","流星:H+5","真空:ATK20倍","極・一文字:会心1000倍","剣神降臨:1万倍"],
    ["不屈:再起+5000","再生の楔:回復10%","逆境:HP減で倍","不死魂:即死耐性","守護誇:HP増","金剛体:HP100倍","鉄壁:被ダメ減","报復棘:反射100倍","絶望抗:全補正2倍","不滅域:速度10倍"],
    ["魔力線:遺物+10%","術展開:ATK3倍","詠唱棄:25%連撃","多構築:H+2","深淵知:EXP2倍","魔極致:ATK30倍","元爆発:追撃500%","真理門:スキ強化","賢者石:遺物数ATK","魔導王再臨:全2倍"],
    ["威圧:敵弱体","王進軍:ATK8倍","凱旋鬨:EXP5倍","統率才:遺物+50%","覇王盾:HP10倍","黄金暁:50倍撃","天統べ:H+10","不抜城:完全防御","絶対王政:ATK500倍","至高御座:Lv毎5000"],
    ["急所穿:会心5倍","影走り:回避20%","死刻印:10H毎2倍","虚像舞:速度5倍","暗殺誇:回避後1000倍","刹那閃:確率+10%","闇溶ける:10%生存","絶影連:H+20","魂収穫:1%全快","虚無終焉:100H固定"],
    ["狂乱:ATK12倍","血戦契:死亡数ATK","屠殺牙:会心+20%","闘神血:再起ATK増","修羅道:速度3倍","飽くなき:長押し10倍","憤怒波:追撃200%","鬼神連:H+15","命喰らう:HP永続増","冥府王:最終10倍"],
    ["等価交換:EXP→ATK","因果糸:4倍撃","世界記憶:遺物2倍","理改変:会心確定","根源理解:ATK100倍","虚構崩壊:割合削り","天秤:均一化","知識激流:速度10倍","運命断罪:1万倍","神数式:最大ダメ"],
    ["祈り:再起後100倍","聖光:敗北10万倍","天加護:ダメ減","奇跡予:遺物+1","天啓調:遺物総数増","聖域盾:即死1%化","神審判:追撃1000%","福音響:死亡数加算","至福時:EXP10倍","主御手:自動攻撃"],
    ["忘却:HP0.1%削","影浸食:ATK7倍","暗黒底:1%削り","空虚夢:被弾ATK増","存在否定:HP1000倍","無還元:乗算化","深淵眼:会心20倍","終焉予:加速","滅び歌:ATK666倍","絶対零:敵停止"],
    ["歯車回転:1.2倍速","過負荷熱:全快100倍","精密演算:会心100%","鋼鉄意志:HP5倍","自動修復:H毎回復","蒸気噴進:H+8","機工連鎖:連撃増","次元歯車:1.5倍速","神設計図:遺物10倍","究極機構:確100%"]
];
const RELIC_SUFFIX = ["の欠片", "の破片", "の結晶", "の輝石", "の紋章", "の腕", "の眼", "の核", "の心", "の術式心"];

let player = { lv: 1, exp: 0, inventory: Array(100).fill(0), deathCount: 0, rAtk: 0, rHP: 0, maxHP: 100 };
let boss = { hp: 1e18, maxHP: 1e18 };
let maxDmgDealt = 0, isPressing = false;

const RELIC_MASTER = Array.from({length: 100}, (_, i) => {
    const star = (i % 10) + 1;
    const type = (i % 2 === 0) ? "ATK" : "HP";
    const name = POWER_NAMES[Math.floor(i/10)] + RELIC_SUFFIX[star-1];
    const val = (type === "ATK") ? (star * 111 + i) : (star * 555 + i * 2);
    return { id: i, star, type, val, name, pIdx: Math.floor(i/10) };
});

function save() {
    const data = { lv: player.lv, exp: player.exp, inv: player.inventory, death: player.deathCount, maxDmg: maxDmgDealt };
    localStorage.setItem("IR_Save_V4", JSON.stringify(data));
}

function load() {
    const saved = localStorage.getItem("IR_Save_V4");
    if (saved) {
        const d = JSON.parse(saved);
        player.lv = d.lv || 1; player.exp = d.exp || 0;
        player.inventory = d.inv || Array(100).fill(0);
        player.deathCount = d.death || 0; maxDmgDealt = d.maxDmg || 0;
    }
}

function init() {
    load();
    const btn = document.getElementById("attackBtn");
    btn.addEventListener("mousedown", () => isPressing = true);
    window.addEventListener("mouseup", () => isPressing = false);
    btn.addEventListener("touchstart", (e) => { e.preventDefault(); isPressing = true; });
    window.addEventListener("touchend", () => isPressing = false);
    setInterval(() => { if(isPressing) attack(); }, 120);
    updateStats();
    refreshUI();
}

function updateStats() {
    let atkSum = 0; let hpSum = 0;
    player.inventory.forEach((count, id) => {
        if (count > 0) {
            const r = RELIC_MASTER[id];
            if (r.type === "ATK") atkSum += r.val * count;
            else hpSum += r.val * count;
        }
    });
    player.rAtk = atkSum;
    player.rHP = hpSum;
    player.maxHP = (100 + player.lv * 100) + (player.deathCount * 200) + player.rHP;
}

function attack() {
    addLog(`<span style="color:red">魔神の攻撃：999999999999999 ダメージ</span>`);
    player.deathCount++;
    addLog(`再起の誓いにより力を取り戻した...`);
    
    const baseAtk = (10 + player.lv * 10);
    const oathAtk = (player.deathCount * 50);
    const totalAtk = baseAtk + oathAtk + player.rAtk;
    let dmg = Math.floor(totalAtk * (0.8 + Math.random() * 0.4));
    boss.hp = Math.max(0, Math.floor(boss.hp - dmg));
    if(dmg > maxDmgDealt) maxDmgDealt = dmg;

    player.exp += (dmg / (player.lv * 10)) + 5;
    if(player.exp >= 100) { player.lv++; player.exp = 0; addLog(`Lv UP! Lv ${player.lv}`); }

    // 遺物ドロップ判定
    if (Math.random() < 0.08) {
        dropRelic();
    }

    save(); updateStats(); refreshUI();
    addLog(`魔神に ${Math.floor(dmg).toLocaleString()} ダメージ！`);
}

function dropRelic() {
    const rnt = Math.random() * 10000; // 0.01%単位で計算
    let star;
    // ドロップ率の細かな階層化
    if (rnt < 1) star = 10;           // 0.01%
    else if (rnt < 10) star = 9;      // 0.09%
    else if (rnt < 50) star = 8;      // 0.4%
    else if (rnt < 150) star = 7;     // 1%
    else if (rnt < 500) star = 6;     // 3.5%
    else if (rnt < 1500) star = 5;    // 10%
    else if (rnt < 3000) star = 4;    // 15%
    else if (rnt < 5000) star = 3;    // 20%
    else if (rnt < 7500) star = 2;    // 25%
    else star = 1;                    // 25%

    // ⭐︎6以上の場合、未所持の遺物のみを対象にする
    let candidates = RELIC_MASTER.filter(r => r.star === star);
    if (star >= 6) {
        candidates = candidates.filter(r => player.inventory[r.id] === 0);
        if (candidates.length === 0) {
            // すべて所持している場合は1ランク下の遺物を抽選
            return; 
        }
    }

    const r = candidates[Math.floor(Math.random() * candidates.length)];
    
    if (star >= 6) {
        player.inventory[r.id] = 1;
        triggerEpicEffect(r);
    } else {
        player.inventory[r.id]++;
        addLog(`<span style="color:var(--rare)">遺物【⭐︎${r.star} ${r.name}】を入手</span>`);
    }
}

function triggerEpicEffect(r) {
    document.getElementById("game-body").classList.add("flash-effect");
    setTimeout(() => document.getElementById("game-body").classList.remove("flash-effect"), 500);
    addLog(`<span style="color:#ff0000; font-weight:bold; font-size:1.1em;">━━━━━━━━━━━━━━━</span>`);
    addLog(`<span style="color:#ff00ff; font-weight:bold; font-size:1.1em;">超希少遺物獲得：【⭐︎${r.star} ${r.name}】</span>`);
    addLog(`<span style="color:#ff0000; font-weight:bold; font-size:1.1em;">━━━━━━━━━━━━━━━</span>`);
}

function refreshUI() {
    let bossPercent = (boss.hp / boss.maxHP * 100);
    document.getElementById("bosshp-text").innerText = Math.floor(bossPercent) + "%";
    document.getElementById("bosshp").style.width = bossPercent + "%";
    document.getElementById("exp-bar").style.width = player.exp + "%";
    document.getElementById("exp-text").innerText = Math.floor(player.exp) + "%";
    document.getElementById("playerhp-text").innerText = `${Math.floor(player.maxHP).toLocaleString()}/${Math.floor(player.maxHP).toLocaleString()}`;
    document.getElementById("p-lv").innerText = player.lv;
    document.getElementById("p-atk").innerText = Math.floor((10 + player.lv * 10) + (player.deathCount * 50) + player.rAtk).toLocaleString();
    document.getElementById("p-death").innerText = player.deathCount;
    if(document.activeTab === 'status') renderStatus();
    if(document.activeTab === 'relic') renderRelic();
}

function showTab(id) {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.querySelectorAll(".nav button").forEach(b => b.classList.remove("active"));
    document.getElementById(id).classList.add("active");
    document.getElementById("nav-" + id).classList.add("active");
    document.activeTab = id;
    if(id === 'status') renderStatus();
    if(id === 'power') renderPower();
    if(id === 'relic') renderRelic();
}

function renderPower() {
    let h = "";
    POWER_NAMES.forEach((n, i) => {
        h += `<div class="card-cell"><b>【権能】${n}</b><div class="skill-grid">`;
        SKILL_DATA[i].forEach((s, si) => { h += `<div class="skill-item ${si<5?'p-skill':'a-skill'}">⭐︎${si+1} ${s}</div>`; });
        h += `</div></div>`;
    });
    document.getElementById("power").innerHTML = h;
}

function renderRelic() {
    let h = "";
    player.inventory.forEach((count, id) => {
        if(count > 0) {
            const r = RELIC_MASTER[id];
            h += `<div class="card-cell ${r.star >= 6 ? 'relic-rare' : ''}">
                <b>⭐︎${r.star} ${r.name}</b>: ${count}個
                <div style="font-size:0.8em; color:#d63384; font-weight:bold;">強化権能スキル: ${SKILL_DATA[r.pIdx][r.star-1]}</div>
                <div style="font-size:0.8em;">能力加算: ${r.type} +${r.val.toLocaleString()}</div>
            </div>`;
        }
    });
    document.getElementById("relic").innerHTML = h || "遺物未所持";
}

function renderStatus() {
    const baseAtk = (10 + player.lv * 10);
    const oathAtk = (player.deathCount * 50);
    const baseHP = (100 + player.lv * 100);
    const oathHP = (player.deathCount * 200);
    document.getElementById("status").innerHTML = `
        <div class="card-cell"><h3>能力詳細</h3><div class="stat-row"><span>基礎攻撃力</span><span class="stat-val">+${baseAtk.toLocaleString()}</span></div><div class="stat-row"><span>再起の誓い</span><span class="stat-val">+${oathAtk.toLocaleString()}</span></div><div class="stat-row"><span>遺物加算</span><span class="stat-val">+${player.rAtk.toLocaleString()}</span></div><div class="stat-row" style="border-top:2px solid #333; margin-top:5px;"><span>合計ATK</span><span class="stat-val">${(baseAtk+oathAtk+player.rAtk).toLocaleString()}</span></div></div>
        <div class="card-cell"><h3>体力の記録</h3><div class="stat-row"><span>基礎体力</span><span class="stat-val">+${baseHP.toLocaleString()}</span></div><div class="stat-row"><span>再起の誓い</span><span class="stat-val">+${oathHP.toLocaleString()}</span></div><div class="stat-row"><span>遺物加算</span><span class="stat-val">+${player.rHP.toLocaleString()}</span></div><div class="stat-row" style="border-top:2px solid #333; margin-top:5px;"><span>最大HP</span><span class="stat-val">${(baseHP+oathHP+player.rHP).toLocaleString()}</span></div></div>
        <div class="card-cell"><div class="stat-row"><span>最大ダメージ</span><span class="stat-val">${Math.floor(maxDmgDealt).toLocaleString()}</span></div><button onclick="if(confirm('データを初期化しますか？')){localStorage.clear();location.reload();}" style="margin-top:10px; font-size:0.7em; background:#eee; border:none; padding:5px;">データ全消去</button></div>`;
}

function addLog(m) {
    const l = document.getElementById("log");
    const d = document.createElement("div"); d.innerHTML = m;
    l.prepend(d); if(l.childNodes.length > 30) l.removeChild(l.lastChild);
}
init();
</script>
</body>
</html>

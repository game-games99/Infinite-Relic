<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>é­”ç¥è¨ä¼ä¼ - çœŸãƒ»å®‰å®šç‰ˆ -</title>
<style>
    :root {
        --bg: #ffffff; --panel: #f1f3f5; --border: #dee2e6;
        --primary: #007bff; --text: #212529; --sub: #6c757d;
        --accent: #dc3545; --gold: #d39e00; --death: #6f42c1;
    }
    body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
    
    #header { background: var(--panel); padding: 10px; border-bottom: 2px solid var(--border); flex-shrink: 0; }
    .status-line { display: flex; justify-content: space-between; font-size: 0.75em; font-weight: bold; margin-bottom: 2px; }
    .bar { height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden; border: 1px solid var(--border); margin-bottom: 5px; }
    .fill { height: 100%; transition: width 0.05s linear; }
    #bosshp { background: linear-gradient(90deg, #ffc107, #dc3545); }
    #playerhp { background: linear-gradient(90deg, #28a745, #20c997); }
    
    .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
    .stat-box { background: #fff; padding: 5px; border-radius: 4px; border: 1px solid var(--border); text-align: center; }
    .stat-label { font-size: 0.6em; color: var(--sub); display: block; }
    .stat-val { font-size: 0.8em; font-weight: bold; }

    .nav { display: flex; background: var(--panel); border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .nav button { flex: 1; padding: 12px 0; border: none; background: none; color: var(--sub); font-weight: bold; font-size: 0.8em; cursor: pointer; }
    .nav button.active { color: var(--primary); border-bottom: 3px solid var(--primary); background: #fff; }

    #content { flex-grow: 1; overflow-y: auto; position: relative; }
    .tab { display: none; padding: 15px; height: 100%; box-sizing: border-box; }
    .tab.active { display: block; }

    .battle-layout { display: flex; flex-direction: column; height: 100%; }
    .btn-attack { width: 100%; padding: 20px; background: var(--primary); color: #fff; font-size: 1.2em; font-weight: bold; border: none; border-radius: 8px; flex-shrink: 0; cursor: pointer; outline: none; }
    .btn-attack:active { transform: scale(0.98); opacity: 0.9; }
    
    #log { flex-grow: 1; margin-top: 10px; overflow-y: auto; font-size: 0.8em; background: #fafafa; padding: 10px; border: 1px solid var(--border); border-radius: 5px; line-height: 1.4; display: flex; flex-direction: column; }
    .log-atk { color: var(--text); }
    .log-def { color: var(--accent); font-weight: bold; }
    .log-exp { color: var(--primary); }

    .detail-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: #fff; z-index: 10; padding: 15px; display: none; overflow-y: auto; }
</style>
</head>
<body>

<div id="header">
    <div class="status-line"><span>é­”ç¥ï¼šæ¨©èƒ½</span><span id="bosshp-text">100.00%</span></div>
    <div class="bar"><div id="bosshp" class="fill"></div></div>
    
    <div class="status-line"><span>ç”Ÿå‘½åŠ›</span><span id="playerhp-text">--- / ---</span></div>
    <div class="bar"><div id="playerhp" class="fill"></div></div>

    <div class="stats-grid">
        <div class="stat-box"><span class="stat-label">ä¸»äººå…¬ Lv</span><span id="p-lv" class="stat-val">1</span></div>
        <div class="stat-box"><span class="stat-label">ç¾åœ¨ã®è·æ¥­</span><span id="p-job-lv" class="stat-val">---</span></div>
        <div class="stat-box"><span class="stat-label">ç´¯è¨ˆæ•—åŒ—æ•°</span><span id="p-death" class="stat-val" style="color:var(--death)">0</span></div>
    </div>
</div>

<div class="nav">
    <button onclick="showTab('battle', this)" class="active">è¨ä¼</button>
    <button onclick="showTab('job', this)">è·æ¥­</button>
    <button onclick="showTab('skills', this)">ã‚¹ã‚­ãƒ«</button>
    <button onclick="showTab('equip', this)">éºç‰©</button>
</div>

<div id="content">
    <div id="battle" class="tab active">
        <div class="battle-layout">
            <button class="btn-attack" id="attackBtn">é­”ç¥ã«æ”»æ’ƒ</button>
            <div id="log"></div>
        </div>
    </div>
    <div id="job" class="tab"><div id="jobList"></div></div>
    <div id="skills" class="tab"><div id="ownedSkillList"></div></div>
    <div id="equip" class="tab"><div id="relicGrid" style="display:grid; grid-template-columns:1fr 1fr; gap:5px;"></div></div>
    <div id="detailPanel" class="detail-overlay">
        <button onclick="closeDetail()" style="margin-bottom:10px;">æˆ»ã‚‹</button>
        <div id="detailContent"></div>
    </div>
</div>

<script>
const BOSS_MAX_HP = 1e24;
const JOBS_DATA = {
    "å‰£è–": ["çƒˆé¢¨æ–¬", "é›·é³´ä¸€é–ƒ", "ç©ºç ´æ–¬", "å¥¥ç¾©ãƒ»å¤©æ–­", "ç¥æ®ºã—ã®åˆƒ"],
    "ç¥å®˜": ["ç™’ã—ã®å…‰", "å®ˆè­·ã®çµç•Œ", "å¤©ç½°ã®å…‰", "å¥‡è·¡ã®é¢¨", "è–åŸŸã®å®ˆã‚Š"],
    "é­”å°å¸«": ["ç«ç‚çƒ", "æ°·çµæ§", "è½é›·", "å´©å£Šã®é­”å°", "å®‡å®™ã®çœŸç†"],
    "ç‹©äºº": ["é€Ÿå°„", "ç‹™ã„æ’ƒã¡", "æ¯’ã®çŸ¢", "å½±ç¸«ã„", "æµæ˜Ÿã®é›¨"],
    "æ­¦é—˜å®¶": ["æ­£æ‹³çªã", "é€£æ’ƒ", "æ°—åŠŸç ²", "çˆ†è£‚æ‹³", "ç ´å¤©ã®æ§‹ãˆ"],
    "æš—æ®ºè€…": ["æ€¥æ‰€çªã", "ç…™å¹•", "çŒ›æ¯’ã®åˆƒ", "å½±æ¸¡ã‚Š", "ç„¡éŸ³ã®çµ‚ç„‰"],
    "å¿è€…": ["æ‰‹è£å‰£", "ç«éã®è¡“", "åˆ†èº«ã®è¡“", "é›·åˆ‡", "ç§˜è¡“ãƒ»å¾®å¡µ"],
    "è–é¨å£«": ["ç›¾æ‰“ã¡", "çµ¶å¯¾é˜²å¾¡", "å¯©åˆ¤ã®æ§Œ", "è–ãªã‚‹è¡Œé€²", "ä¸è½ã®åŸå¡"],
    "ç‹‚æˆ¦å£«": ["çŒ›æ’ƒ", "ç²‰ç •", "é›„ãŸã‘ã³", "è¡€ã®ç¥ç¥­", "é­‚ã®ç ´å£Š"],
    "æ§è¡“å£«": ["è²«é€šçªã", "æ—‹å›ä¸€é–ƒ", "èºæ—‹ã®ç‰™", "é¾ã®å’†å“®", "å¤©ç©ºã‚’ç©¿ã¤æ§"],
    "å¼“è–": ["äºŒé€£å°„", "é­”çŸ¢", "æ—‹é¢¨ã®çŸ¢", "çˆ†è£‚ã®çŸ¢", "æ˜Ÿå •ã¨ã—"],
    "éŒ¬é‡‘è¡“å¸«": ["è–¬å“æŠ•æ“²", "ç‰©è³ªå¤‰åŒ–", "é‡‘å‰›åŒ–", "çˆ†ç™ºç”Ÿæˆ", "è³¢è€…ã®çŸ³"],
    "æ­»éœŠä½¿ã„": ["äº¡è€…ã®å¬å–š", "å‘ªã„ã®éœ§", "é­‚ã®å¸å", "æ­»éœŠã®è»å‹¢", "å†¥åºœã®é–€"],
    "é¢¨è¡“å¸«": ["é¢¨ã®åˆƒ", "ç«œå·»", "ç–¾é¢¨ã®åŠ è­·", "çœŸç©ºæ³¢", "ç¥é¢¨ã®æ€’ã‚Š"],
    "é‡é¨å£«": ["å¤§ç›¾ã®æ§‹ãˆ", "ä½“å½“ãŸã‚Š", "åœ°éŸ¿ã", "ä¸å±ˆã®ç²¾ç¥", "é‡åŠ›å´©å£Š"],
    "å†’é™ºè€…": ["é‘‘å®š", "èµ·æ­»å›ç”Ÿ", "å¹¸é‹ã®ãƒ€ã‚¤ã‚¹", "ãŠå®ç™ºè¦‹", "è‹±é›„ã®è¨¼"],
    "è¦‡ç‹": ["è¦‡æ°—", "æ”¯é…ã®çœ¼å…‰", "æ¬¡å…ƒã®è¹‚è™™", "è¦‡é“ä¸€æ’ƒ", "å¤©åœ°é–‹é—¢"],
    "æ‹³é—˜å£«": ["ãƒ©ãƒƒã‚·ãƒ¥", "å›é¿", "ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼", "KOãƒ‘ãƒ³ãƒ", "ç„¡åŒã®æ‹³"],
    "æ§ç‹": ["ä¸€çªã", "ä¹±èˆ", "é¾å·»", "ç¥ã®çªã", "éŠ€æ²³è²«é€š"],
    "è³¢è€…": ["çŸ¥æµã®é–ƒã", "é­”åŠ›åæŸ", "æ™‚ç©ºé­”æ³•", "å› æœé€†è»¢", "å…¨çŸ¥å…¨èƒ½"]
};

let p, longPressIdx, isProcessing = false;
const SAVE_KEY = "MAJIN_REBIRTH_REPAIR_V3";

function init() {
    const saved = localStorage.getItem(SAVE_KEY);
    p = saved ? JSON.parse(saved) : {
        lv: 1, exp: 0, job: "å‰£è–", inventory: {}, 
        jobLevels: {}, jobExp: {}, bossTotalDmg: 0, deathCount: 0
    };
    Object.keys(JOBS_DATA).forEach(j => {
        if (!p.jobLevels[j]) p.jobLevels[j] = 1;
        if (p.jobExp[j] === undefined) p.jobExp[j] = 0;
    });
    
    const btn = document.getElementById("attackBtn");
    const handleStart = (e) => { e.preventDefault(); if(!longPressIdx) { battle(); longPressIdx = setInterval(battle, 100); } };
    const handleStop = () => { clearInterval(longPressIdx); longPressIdx = null; };

    btn.addEventListener("mousedown", handleStart);
    btn.addEventListener("mouseup", handleStop);
    btn.addEventListener("mouseleave", handleStop);
    btn.addEventListener("touchstart", handleStart, {passive: false});
    btn.addEventListener("touchend", handleStop);
    
    refresh();
}

function battle() {
    if (isProcessing) return;
    isProcessing = true;

    try {
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨ˆç®— (åˆæœŸãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å¤§å¹…ã«ãƒãƒ•)
        let atk = 5000 + (p.lv * 500) + (p.jobLevels[p.job] * 200);
        let maxHP = 1000 + (p.lv * 100);
        let dmgM = 1.0;
        
        Object.keys(p.inventory).forEach(id => {
            const seed = parseInt(id);
            const count = p.inventory[id];
            if (seed % 13 === 0) dmgM *= (1 + (p.deathCount * 0.001 * count));
            else if (seed % 4 === 0) atk += (seed % 10 + 1) * 50 * count;
        });

        // æ”»æ’ƒ
        let dmg = Math.floor(atk * (0.9 + Math.random() * 0.2) * dmgM);
        p.bossTotalDmg += dmg;
        let gainExp = Math.floor(dmg * 0.01) + 10;
        p.exp += gainExp;
        p.jobExp[p.job] += gainExp;

        addLog(`<span class="log-atk">âš”ï¸ é­”ç¥ã« ${dmg.toLocaleString()} ãƒ€ãƒ¡ãƒ¼ã‚¸</span>`);
        addLog(`<span class="log-exp">âœ¨ çµŒé¨“å€¤ ${gainExp.toLocaleString()} ç²å¾—</span>`);

        // è¢«å¼¾ã¨æ­»äº¡
        let enemyDmg = maxHP * 2;
        addLog(`<span class="log-def">ğŸ’¥ é­”ç¥ã®åæ’ƒï¼š${enemyDmg.toLocaleString()} è¢«å¼¾</span>`);
        p.deathCount++;

        checkLevelUp();
        refresh();
    } catch (e) {
        console.error(e);
    } finally {
        isProcessing = false;
    }
}

function checkLevelUp() {
    let next = Math.pow(p.lv, 3) * 1000;
    while (p.exp >= next) { p.exp -= next; p.lv++; next = Math.pow(p.lv, 3) * 1000; }
    let jNext = Math.pow(p.jobLevels[p.job], 3) * 500;
    while (p.jobExp[p.job] >= jNext) { p.jobExp[p.job] -= jNext; p.jobLevels[p.job]++; jNext = Math.pow(p.jobLevels[p.job], 3) * 500; }
}

function refresh() {
    const hpPer = Math.max(0, 100 - (p.bossTotalDmg / BOSS_MAX_HP * 100));
    document.getElementById("bosshp").style.width = hpPer + "%";
    document.getElementById("bosshp-text").innerText = hpPer.toFixed(10) + "%";
    
    const maxHP = 1000 + (p.lv * 100);
    document.getElementById("playerhp").style.width = "100%";
    document.getElementById("playerhp-text").innerText = `${maxHP.toLocaleString()} / ${maxHP.toLocaleString()}`;
    
    document.getElementById("p-lv").innerText = p.lv;
    document.getElementById("p-job-lv").innerText = `${p.job} Lv.${p.jobLevels[p.job]}`;
    document.getElementById("p-death").innerText = p.deathCount;

    // ã‚¿ãƒ–ã”ã¨ã®æ›´æ–°
    if (document.getElementById("job").classList.contains("active")) renderJobs();
    if (document.getElementById("skills").classList.contains("active")) renderSkills();
    if (document.getElementById("equip").classList.contains("active")) renderEquip();

    localStorage.setItem(SAVE_KEY, JSON.stringify(p));
}

function addLog(m) {
    const l = document.getElementById("log");
    const d = document.createElement("div");
    d.innerHTML = m;
    l.prepend(d);
    if (l.childNodes.length > 20) l.removeChild(l.lastChild);
}

function renderJobs() {
    document.getElementById("jobList").innerHTML = Object.keys(JOBS_DATA).map(j => `
        <div style="display:flex; justify-content:space-between; padding:10px; border:1px solid #ddd; margin-bottom:5px;">
            <span>${j} Lv.${p.jobLevels[j]}</span>
            <button onclick="p.job='${j}'; refresh();">${p.job === j ? 'é¸æŠä¸­' : 'è»¢è·'}</button>
        </div>
    `).join("");
}

function renderSkills() {
    document.getElementById("ownedSkillList").innerHTML = JOBS_DATA[p.job].map((s, i) => {
        if (p.jobLevels[p.job] < (i + 1) * 10) return "";
        return `<div style="padding:10px; border-left:4px solid var(--primary); background:#f8f9fa; margin-bottom:5px;"><b>${s}</b><br><small>å¨åŠ›å¼·åŒ–</small></div>`;
    }).join("") || "Lv.10ã§ç¿’å¾—";
}

function renderEquip() {
    document.getElementById("relicGrid").innerHTML = Object.keys(p.inventory).map(id => `
        <div style="padding:8px; border:1px solid #ddd; font-size:0.8em;">éºç‰© #${id} Ã— ${p.inventory[id]}</div>
    `).join("") || "æœªæ‰€æŒ";
}

function showTab(id, btn) {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.getElementById(id).classList.add("active");
    document.querySelectorAll(".nav button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    refresh();
}

function closeDetail() { document.getElementById("detailPanel").style.display = "none"; }

init();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>é­”ç¥è¨ä¼ä¼ - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è§£æ -</title>
<style>
    :root {
        --bg: #ffffff; --panel: #f1f3f5; --border: #dee2e6;
        --primary: #007bff; --text: #212529; --sub: #6c757d;
        --accent: #dc3545; --gold: #d39e00; --death: #6f42c1;
    }
    body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
    
    #header { background: var(--panel); padding: 10px; border-bottom: 2px solid var(--border); flex-shrink: 0; }
    .status-line { display: flex; justify-content: space-between; font-size: 0.75em; font-weight: bold; margin-bottom: 2px; }
    .bar { height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden; border: 1px solid var(--border); margin-bottom: 5px; }
    .fill { height: 100%; transition: width 0.05s linear; }
    #bosshp { background: linear-gradient(90deg, #ffc107, #dc3545); }
    #playerhp { background: linear-gradient(90deg, #28a745, #20c997); }
    
    .nav { display: flex; background: var(--panel); border-bottom: 1px solid var(--border); flex-shrink: 0; overflow-x: auto; }
    .nav button { flex: 1; min-width: 60px; padding: 12px 0; border: none; background: none; color: var(--sub); font-weight: bold; font-size: 0.75em; cursor: pointer; white-space: nowrap; }
    .nav button.active { color: var(--primary); border-bottom: 3px solid var(--primary); background: #fff; }

    #content { flex-grow: 1; overflow-y: auto; position: relative; }
    .tab { display: none; padding: 15px; height: 100%; box-sizing: border-box; }
    .tab.active { display: block; }

    .btn-attack { width: 100%; padding: 20px; background: var(--primary); color: #fff; font-size: 1.2em; font-weight: bold; border: none; border-radius: 8px; flex-shrink: 0; cursor: pointer; }
    #log { flex-grow: 1; margin-top: 10px; overflow-y: auto; font-size: 0.8em; background: #fafafa; padding: 10px; border: 1px solid var(--border); border-radius: 5px; line-height: 1.4; display: flex; flex-direction: column-reverse; }

    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”»é¢ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .status-card { background: #f8f9fa; border: 1px solid var(--border); border-radius: 8px; padding: 15px; margin-bottom: 10px; }
    .status-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9em; border-bottom: 1px dashed #ddd; padding-bottom: 4px; }
    .status-val { font-weight: bold; color: var(--primary); }
    .death-bonus { color: var(--death); font-weight: bold; }

    .list-item { background: #fff; border: 1px solid var(--border); padding: 10px; border-radius: 6px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .relic-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
    .relic-cell { background: #fff; border: 1px solid var(--border); padding: 8px; font-size: 0.75em; display: flex; justify-content: space-between; cursor: pointer; }
    .detail-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: #fff; z-index: 20; padding: 15px; display: none; overflow-y: auto; }
</style>
</head>
<body>

<div id="header">
    <div class="status-line"><span>é­”ç¥ï¼šæ¨©èƒ½</span><span id="bosshp-text">100.00%</span></div>
    <div class="bar"><div id="bosshp" class="fill"></div></div>
    <div class="status-line"><span>ç”Ÿå‘½åŠ›</span><span id="playerhp-text">--- / ---</span></div>
    <div class="bar"><div id="playerhp" class="fill"></div></div>
</div>

<div class="nav">
    <button onclick="showTab('battle', this)" class="active">è¨ä¼</button>
    <button onclick="showTab('status', this)">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</button>
    <button onclick="showTab('job', this)">è·æ¥­</button>
    <button onclick="showTab('skills', this)">ã‚¹ã‚­ãƒ«</button>
    <button onclick="showTab('equip', this)">éºç‰©</button>
</div>

<div id="content">
    <div id="battle" class="tab active">
        <div style="display:flex; flex-direction:column; height:100%;">
            <button class="btn-attack" id="attackBtn">é­”ç¥ã«æ”»æ’ƒ</button>
            <div id="log"></div>
        </div>
    </div>

    <div id="status" class="tab">
        <div class="status-card">
            <h3 style="margin-top:0;">ğŸ‘¤ ä¸»äººå…¬èƒ½åŠ›</h3>
            <div class="status-row"><span>ãƒ¬ãƒ™ãƒ«</span><span id="st-lv" class="status-val">1</span></div>
            <div class="status-row"><span>ç´¯è¨ˆæ•—åŒ—æ•°</span><span id="st-death" class="death-bonus">0</span></div>
            <div class="status-row"><span>ç¾åœ¨ã®è·æ¥­</span><span id="st-job" class="status-val">---</span></div>
        </div>
        <div class="status-card">
            <h3 style="margin-top:0;">âš”ï¸ æˆ¦é—˜è£œæ­£</h3>
            <div class="status-row"><span>åŸºç¤æ”»æ’ƒåŠ›</span><span id="st-atk" class="status-val">0</span></div>
            <div class="status-row"><span>éºç‰©åŠ ç®—ATK</span><span id="st-rel-atk" class="status-val">+0</span></div>
            <div class="status-row"><span>ãƒ€ãƒ¡ãƒ¼ã‚¸å¢—å¹…</span><span id="st-dmg-m" class="status-val">100%</span></div>
            <div class="status-row"><span>æ­»ã®æ©æµ(æ•—åŒ—ãƒœãƒ¼ãƒŠã‚¹)</span><span id="st-death-m" class="death-bonus">x1.00</span></div>
        </div>
        <div class="status-card">
            <h3 style="margin-top:0;">ğŸ’ ç‰¹æ®ŠåŠ¹æœ</h3>
            <div class="status-row"><span>éºç‰©ç™ºè¦‹ç‡</span><span id="st-drop" class="status-val">10%</span></div>
            <div class="status-row"><span>ç·ãƒ€ãƒ¡ãƒ¼ã‚¸</span><span id="st-total-dmg" style="font-size:0.7em;">0</span></div>
        </div>
    </div>

    <div id="job" class="tab"><div id="jobList"></div></div>
    <div id="skills" class="tab"><div id="ownedSkillList"></div></div>
    <div id="equip" class="tab"><div class="relic-grid" id="relicGrid"></div></div>
    
    <div id="detailPanel" class="detail-overlay">
        <button style="width:100%; padding:10px; margin-bottom:10px;" onclick="closeDetail()">æˆ»ã‚‹</button>
        <div id="detailContent"></div>
    </div>
</div>

<script>
const BOSS_MAX_HP = 1e24;
const JOBS_DATA = {
    "å‰£è–": ["çƒˆé¢¨æ–¬", "é›·é³´ä¸€é–ƒ", "ç©ºç ´æ–¬", "å¥¥ç¾©ãƒ»å¤©æ–­", "ç¥æ®ºã—ã®åˆƒ"],
    "ç¥å®˜": ["ç™’ã—ã®å…‰", "å®ˆè­·ã®çµç•Œ", "å¤©ç½°ã®å…‰", "å¥‡è·¡ã®é¢¨", "è–åŸŸã®å®ˆã‚Š"],
    "é­”å°å¸«": ["ç«ç‚çƒ", "æ°·çµæ§", "è½é›·", "å´©å£Šã®é­”å°", "å®‡å®™ã®çœŸç†"],
    "ç‹©äºº": ["é€Ÿå°„", "ç‹™ã„æ’ƒã¡", "æ¯’ã®çŸ¢", "å½±ç¸«ã„", "æµæ˜Ÿã®é›¨"],
    "æ­¦é—˜å®¶": ["æ­£æ‹³çªã", "é€£æ’ƒ", "æ°—åŠŸç ²", "çˆ†è£‚æ‹³", "ç ´å¤©ã®æ§‹ãˆ"],
    "æš—æ®ºè€…": ["æ€¥æ‰€çªã", "ç…™å¹•", "çŒ›æ¯’ã®åˆƒ", "å½±æ¸¡ã‚Š", "ç„¡éŸ³ã®çµ‚ç„‰"],
    "å¿è€…": ["æ‰‹è£å‰£", "ç«éã®è¡“", "åˆ†èº«ã®è¡“", "é›·åˆ‡", "ç§˜è¡“ãƒ»å¾®å¡µ"],
    "è–é¨å£«": ["ç›¾æ‰“ã¡", "çµ¶å¯¾é˜²å¾¡", "å¯©åˆ¤ã®æ§Œ", "è–ãªã‚‹è¡Œé€²", "ä¸è½ã®åŸå¡"],
    "ç‹‚æˆ¦å£«": ["çŒ›æ’ƒ", "ç²‰ç •", "é›„ãŸã‘ã³", "è¡€ã®ç¥ç¥­", "é­‚ã®ç ´å£Š"],
    "æ§è¡“å£«": ["è²«é€šçªã", "æ—‹å›ä¸€é–ƒ", "èºæ—‹ã®ç‰™", "é¾ã®å’†å“®", "å¤©ç©ºã‚’ç©¿ã¤æ§"],
    "å¼“è–": ["äºŒé€£å°„", "é­”çŸ¢", "æ—‹é¢¨ã®çŸ¢", "çˆ†è£‚ã®çŸ¢", "æ˜Ÿå •ã¨ã—"],
    "éŒ¬é‡‘è¡“å¸«": ["è–¬å“æŠ•æ“²", "ç‰©è³ªå¤‰åŒ–", "é‡‘å‰›åŒ–", "çˆ†ç™ºç”Ÿæˆ", "è³¢è€…ã®çŸ³"],
    "æ­»éœŠä½¿ã„": ["äº¡è€…ã®å¬å–š", "å‘ªã„ã®éœ§", "é­‚ã®å¸å", "æ­»éœŠã®è»å‹¢", "å†¥åºœã®é–€"],
    "é¢¨è¡“å¸«": ["é¢¨ of åˆƒ", "ç«œå·»", "ç–¾é¢¨ã®åŠ è­·", "çœŸç©ºæ³¢", "ç¥é¢¨ã®æ€’ã‚Š"],
    "é‡é¨å£«": ["å¤§ç›¾ã®æ§‹ãˆ", "ä½“å½“ãŸã‚Š", "åœ°éŸ¿ã", "ä¸å±ˆã®ç²¾ç¥", "é‡åŠ›å´©å£Š"],
    "å†’é™ºè€…": ["é‘‘å®š", "èµ·æ­»å›ç”Ÿ", "å¹¸é‹ã®ãƒ€ã‚¤ã‚¹", "ãŠå®ç™ºè¦‹", "è‹±é›„ã®è¨¼"],
    "è¦‡ç‹": ["è¦‡æ°—", "æ”¯é…ã®çœ¼å…‰", "æ¬¡å…ƒã®è¹‚è™™", "è¦‡é“ä¸€æ’ƒ", "å¤©åœ°é–‹é—¢"],
    "æ‹³é—˜å£«": ["ãƒ©ãƒƒã‚·ãƒ¥", "å›é¿", "ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼", "KOãƒ‘ãƒ³ãƒ", "ç„¡åŒã®æ‹³"],
    "æ§ç‹": ["ä¸€çªã", "ä¹±èˆ", "é¾å·»", "ç¥ã®çªã", "éŠ€æ²³è²«é€š"],
    "è³¢è€…": ["çŸ¥æµã®é–ƒã", "é­”åŠ›åæŸ", "æ™‚ç©ºé­”æ³•", "å› æœé€†è»¢", "å…¨çŸ¥å…¨èƒ½"]
};
const R_PREFIX = ["å¤ã®", "è–ãªã‚‹", "æ·±æ·µã®", "é­”ç¥ã®", "æ˜Ÿã®"];
const R_NAME = ["æŒ‡è¼ª", "é­”çŸ³", "åˆ»å°", "è–æ¯", "å† "];
const R_SUFFIX = ["ã®è¨˜æ†¶", "ã®è¼ã", "ã®æ¬ ç‰‡"];

let p, longPressIdx, isProcessing = false;
const SAVE_KEY = "MAJIN_REBIRTH_STATUS_V5";

function init() {
    const saved = localStorage.getItem(SAVE_KEY);
    p = saved ? JSON.parse(saved) : {
        lv: 1, exp: 0, job: "å‰£è–", inventory: {}, 
        jobLevels: {}, jobExp: {}, bossTotalDmg: 0, deathCount: 0
    };
    Object.keys(JOBS_DATA).forEach(j => {
        if (!p.jobLevels[j]) p.jobLevels[j] = 1;
        if (p.jobExp[j] === undefined) p.jobExp[j] = 0;
    });
    
    const btn = document.getElementById("attackBtn");
    const handleStart = (e) => { e.preventDefault(); if(!longPressIdx) { battle(); longPressIdx = setInterval(battle, 100); } };
    const handleStop = () => { clearInterval(longPressIdx); longPressIdx = null; };
    btn.addEventListener("mousedown", handleStart); btn.addEventListener("mouseup", handleStop);
    btn.addEventListener("touchstart", handleStart, {passive: false}); btn.addEventListener("touchend", handleStop);
    
    refresh();
}

function getRelicData(id) {
    const seed = parseInt(id);
    const types = ["æ”»æ’ƒåŠ›", "æœ€å¤§ä½“åŠ›", "ä¸ãƒ€ãƒ¡ãƒ¼ã‚¸", "ç™ºè¦‹ç‡"];
    const typeKey = ["ATK", "HP", "DMG", "DROP"][seed % 4];
    const isDeathType = (seed % 13 === 0);
    const isGold = (seed % 100 === 0);
    const baseVal = isGold ? (seed % 10 + 1) * 20 : (seed % 10 + 1);
    const name = (isDeathType ? "æ­»ã‚’å–°ã‚‰ã†" : R_PREFIX[seed % 5]) + R_NAME[(seed >> 2) % 5] + R_SUFFIX[seed % 3];
    return { id, name, typeKey, val: baseVal, isGold, isDeathType };
}

function battle() {
    if (isProcessing) return;
    isProcessing = true;
    try {
        let baseAtk = 5000 + (p.lv * 500) + (p.jobLevels[p.job] * 200);
        let relAtk = 0;
        let dmgM = 1.0;
        let deathM = 1.0;
        
        Object.keys(p.inventory).forEach(id => {
            const d = getRelicData(id); const count = p.inventory[id];
            if (d.isDeathType) deathM *= (1 + (p.deathCount * d.val * 0.0001 * count));
            else if (d.typeKey === "ATK") relAtk += d.val * count;
            else if (d.typeKey === "DMG") dmgM += d.val * 0.01 * count;
        });

        let dmg = Math.floor((baseAtk + relAtk) * (0.9 + Math.random() * 0.2) * dmgM * deathM);
        p.bossTotalDmg += dmg;
        let gainExp = Math.floor(dmg * 0.01) + 10;
        p.exp += gainExp; p.jobExp[p.job] += gainExp;

        addLog(`âš”ï¸ æ”»æ’ƒ: ${dmg.toLocaleString()} / âœ¨ Exp: ${gainExp.toLocaleString()}`);
        p.deathCount++;
        if (Math.random() < 0.1) {
            let rId = Math.floor(Math.random() * 250); // éºç‰©ç¨®é¡ã‚’250ã«åœ§ç¸®
            p.inventory[rId] = (p.inventory[rId] || 0) + 1;
            addLog(`<span style="color:var(--gold)">â˜… éºç‰©ç²å¾—</span>`);
        }
        checkLevelUp(); refresh();
    } finally { isProcessing = false; }
}

function checkLevelUp() {
    let next = Math.pow(p.lv, 3) * 1000;
    while (p.exp >= next) { p.exp -= next; p.lv++; next = Math.pow(p.lv, 3) * 1000; }
    let jNext = Math.pow(p.jobLevels[p.job], 3) * 500;
    while (p.jobExp[p.job] >= jNext) { p.jobExp[p.job] -= jNext; p.jobLevels[p.job]++; jNext = Math.pow(p.jobLevels[p.job], 3) * 500; }
}

function refresh() {
    const hpPer = Math.max(0, 100 - (p.bossTotalDmg / BOSS_MAX_HP * 100));
    document.getElementById("bosshp").style.width = hpPer + "%";
    document.getElementById("bosshp-text").innerText = hpPer.toFixed(10) + "%";
    const maxHP = 1000 + (p.lv * 100);
    document.getElementById("playerhp").style.width = "100%";
    document.getElementById("playerhp-text").innerText = `${maxHP.toLocaleString()} / ${maxHP.toLocaleString()}`;

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¿ãƒ–æ›´æ–°
    if (document.getElementById("status").classList.contains("active")) {
        let relAtk = 0; let dmgM = 1.0; let deathM = 1.0; let dropB = 10;
        Object.keys(p.inventory).forEach(id => {
            const d = getRelicData(id); const count = p.inventory[id];
            if (d.isDeathType) deathM *= (1 + (p.deathCount * d.val * 0.0001 * count));
            else if (d.typeKey === "ATK") relAtk += d.val * count;
            else if (d.typeKey === "DMG") dmgM += (d.val * 0.01 * count);
            else if (d.typeKey === "DROP") dropB += (d.val * 0.1 * count);
        });
        document.getElementById("st-lv").innerText = p.lv;
        document.getElementById("st-death").innerText = p.deathCount.toLocaleString();
        document.getElementById("st-job").innerText = `${p.job} (Lv.${p.jobLevels[p.job]})`;
        document.getElementById("st-atk").innerText = (5000 + (p.lv * 500) + (p.jobLevels[p.job] * 200)).toLocaleString();
        document.getElementById("st-rel-atk").innerText = "+" + relAtk.toLocaleString();
        document.getElementById("st-dmg-m").innerText = Math.floor(dmgM * 100) + "%";
        document.getElementById("st-death-m").innerText = "x" + deathM.toFixed(2);
        document.getElementById("st-drop").innerText = dropB.toFixed(1) + "%";
        document.getElementById("st-total-dmg").innerText = p.bossTotalDmg.toLocaleString();
    }

    if (document.getElementById("job").classList.contains("active")) {
        document.getElementById("jobList").innerHTML = Object.keys(JOBS_DATA).map(j => `
            <div class="list-item" onclick="openJobDetail('${j}')">
                <span><b>${j}</b> <small>Lv.${p.jobLevels[j]}</small></span>
                <button onclick="event.stopPropagation(); p.job='${j}'; refresh();" style="color:var(--primary); background:none; border:1px solid var(--primary); border-radius:4px; padding:2px 8px;">è»¢è·</button>
            </div>
        `).join("");
    }
    if (document.getElementById("equip").classList.contains("active")) {
        document.getElementById("relicGrid").innerHTML = Object.keys(p.inventory).map(id => {
            const d = getRelicData(id);
            return `<div class="relic-cell" onclick="openRelicDetail(${id})"><span>${d.name}</span><span>Ã—${p.inventory[id]}</span></div>`;
        }).join("");
    }
    localStorage.setItem(SAVE_KEY, JSON.stringify(p));
}

function openJobDetail(jName) {
    const lv = p.jobLevels[jName];
    let html = `<h3>${jName}</h3><hr>`;
    JOBS_DATA[jName].forEach((s, i) => {
        html += `<div style="color:${lv >= (i+1)*10 ? 'var(--primary)' : '#ccc'}">Lv.${(i+1)*10}: ${s}</div>`;
    });
    showDetail(html);
}

function openRelicDetail(id) {
    const d = getRelicData(id);
    showDetail(`<h3>${d.name}</h3><p>æ‰€æŒæ•°: ${p.inventory[id]}</p><hr><p>${d.isDeathType ? 'æ•—åŒ—æ•°ãƒœãƒ¼ãƒŠã‚¹' : 'é€šå¸¸ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¼·åŒ–'}</p>`);
}

function showDetail(content) { document.getElementById("detailContent").innerHTML = content; document.getElementById("detailPanel").style.display = "block"; }
function closeDetail() { document.getElementById("detailPanel").style.display = "none"; }
function addLog(m) {
    const l = document.getElementById("log");
    const d = document.createElement("div"); d.innerHTML = m;
    l.prepend(d); if (l.childNodes.length > 25) l.removeChild(l.lastChild);
}
function showTab(id, btn) {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.getElementById(id).classList.add("active");
    document.querySelectorAll(".nav button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active"); refresh();
}
init();
</script>
</body>
</html>

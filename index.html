<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>infiniterelic</title>
<style>
    :root { --bg: #ffffff; --panel: #f8f9fa; --border: #dee2e6; --primary: #007bff; --text: #212529; --hp: #dc3545; --exp: #007bff; --player-hp: #28a745; --rare: #ffc107; }
    body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
    #header { background: var(--panel); padding: 10px; border-bottom: 2px solid var(--border); flex-shrink: 0; }
    .nav { display: flex; background: var(--panel); border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .nav button { flex: 1; padding: 15px 0; border: none; background: none; color: #6c757d; font-weight: bold; font-size: 0.8em; cursor: pointer; }
    .nav button.active { color: var(--primary); border-bottom: 3px solid var(--primary); background: #fff; }
    #content-area { flex-grow: 1; overflow-y: auto; background: #fff; }
    .tab { display: none; padding: 15px; box-sizing: border-box; }
    .tab.active { display: block; padding-bottom: 100px; }
    
    /* 遺物一覧 2列表示 */
    .relic-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .relic-card { background: #fff; border: 1px solid var(--border); padding: 10px; border-radius: 8px; font-size: 0.75em; }
    .relic-epic { border: 2px solid var(--rare); background: #fffdf5; }

    .btn-attack { width: 100%; padding: 25px; background: var(--primary); color: #fff; font-size: 1.2em; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; touch-action: manipulation; }
    #log { font-size: 0.8em; background: #fafafa; padding: 10px; border: 1px solid var(--border); border-radius: 8px; height: 220px; overflow-y: auto; margin-top: 15px; }
    
    .bar-label { display: flex; justify-content: space-between; font-size: 0.75em; font-weight: bold; }
    .bar { height: 10px; background: #eee; border-radius: 5px; overflow: hidden; margin: 4px 0 8px; }
    .fill { height: 100%; transition: width 0.1s ease; }
    
    .stat-row { display: flex; justify-content: space-between; font-size: 0.9em; padding: 4px 0; border-bottom: 1px solid #eee; }
    .stat-val { font-weight: bold; color: var(--primary); }
    @keyframes flash { 0% { background: gold; } 100% { background: white; } }
    .flash-effect { animation: flash 0.5s ease-out; }
</style>
</head>
<body id="game-body">

<div id="header">
    <div class="bar-label"><span>魔神 HP</span><span id="bosshp-text">100%</span></div>
    <div class="bar"><div id="bosshp" class="fill" style="background:var(--hp); width:100%"></div></div>
    <div class="bar-label"><span>経験値</span><span id="exp-text">0%</span></div>
    <div class="bar"><div id="exp-bar" class="fill" style="background:var(--exp); width:0%"></div></div>
    <div style="font-size:0.8em; font-weight:bold; display:flex; justify-content:space-between; margin-top:5px;">
        <span>Lv: <span id="p-lv">1</span></span>
        <span>ATK: <span id="p-atk">0</span></span>
        <span>再起の誓い: <span id="p-death">0</span></span>
    </div>
</div>

<div class="nav">
    <button id="nav-battle" onclick="showTab('battle')" class="active">討伐</button>
    <button id="nav-status" onclick="showTab('status')">能力</button>
    <button id="nav-power" onclick="showTab('power')">権能</button>
    <button id="nav-relic" onclick="showTab('relic')">遺物</button>
</div>

<div id="content-area">
    <div id="battle" class="tab active"><button class="btn-attack" id="attackBtn">こうげき</button><div id="log"></div></div>
    <div id="status" class="tab"></div>
    <div id="power" class="tab"></div>
    <div id="relic" class="tab"></div>
</div>

<script>
const POWER_NAMES = ["剣神の残火","不滅の守護者","魔導王の遺志","覇王の残光","絶影の残影","修羅の咆哮","真理の残滓","神託の残響","虚無の深淵","機工の心臓"];
const SKILL_DATA = [
    ["一の太刀:ATK5倍","燕返し:ATK8倍","心眼:ATK15倍","無想:ATK30倍","天断:ATK100倍","神速:ATK500倍","流星:ATK2000倍","真空:ATK1万倍","極・一文字:ATK10万倍","剣神降臨:ATK100万倍"],
    ["不屈:ATK2倍","再生:ATK4倍","逆境:ATK8倍","不死:ATK16倍","守護:ATK32倍","金剛:ATK100倍","鉄壁:ATK500倍","報復:ATK2000倍","絶望:ATK1万倍","不滅:ATK10万倍"],
    // ... 他のスキルも同様にATK倍率として計算に組み込む
];
// ダミーデータ補完（10権能分）
for(let i=2; i<10; i++){ SKILL_DATA[i] = SKILL_DATA[0].map(s => s.replace("ATK", "ATK")); }

const RELIC_SUFFIX = ["の欠片", "の破片", "の結晶", "の輝石", "の紋章", "の腕", "の眼", "の核", "の心", "の術式心"];

let player = { lv: 1, exp: 0, inventory: Array(100).fill(0), deathCount: 0, baseAtk: 10, baseHP: 100 };
let boss = { hp: 1e30, maxHP: 1e30 }; // 魔神は実質倒せない設定
let maxDmg = 0, isPressing = false;

const RELIC_MASTER = Array.from({length: 100}, (_, i) => {
    const star = (i % 10) + 1;
    const pIdx = Math.floor(i/10);
    const type = (i % 2 === 0) ? "ATK" : "HP";
    let val = (type === "ATK") ? (star * 100) : (star * 500);
    let isPercent = false;
    if(star >= 6) { val = star * 50; isPercent = true; } // ⭐︎6以上は％上昇
    return { id: i, star, type, val, isPercent, name: POWER_NAMES[pIdx] + RELIC_SUFFIX[star-1], pIdx };
});

function save() {
    const data = { lv: player.lv, exp: player.exp, inv: player.inventory, death: player.deathCount, bAtk: player.baseAtk, bHP: player.baseHP, maxDmg: maxDmg };
    localStorage.setItem("IR_Save_V5", JSON.stringify(data));
}

function load() {
    const saved = localStorage.getItem("IR_Save_V5");
    if (saved) {
        const d = JSON.parse(saved);
        player.lv = d.lv; player.exp = d.exp; player.inventory = d.inv;
        player.deathCount = d.death; player.baseAtk = d.bAtk || 10; player.baseHP = d.bHP || 100; maxDmg = d.maxDmg || 0;
    }
}

function attack() {
    player.deathCount++;
    // レベルアップ成長（ランダム）
    const growth = Math.floor(Math.random() * player.lv) + 5;
    const isLucky = Math.random() < 0.1;
    const finalGrowth = isLucky ? growth * 3 : growth;
    player.baseAtk += finalGrowth;
    addLog(`<span style="color:#666">再起の誓い... 基礎ATKが+${finalGrowth}上昇${isLucky?'(会心成長!)':''}</span>`);

    // 倍率計算
    let relicAtkAdd = 0;
    let relicAtkMul = 1;
    let skillMul = 1;
    let activeSkillName = "";

    player.inventory.forEach((count, id) => {
        if(count > 0) {
            const r = RELIC_MASTER[id];
            if(r.type === "ATK") {
                if(r.isPercent) relicAtkMul += (r.val / 100);
                else relicAtkAdd += r.val * count;
            }
            // スキル倍率（所持している最高レアのものを適用）
            const sVal = parseInt(SKILL_DATA[r.pIdx][r.star-1].split("ATK")[1]);
            if(sVal > skillMul) {
                skillMul = sVal;
                activeSkillName = SKILL_DATA[r.pIdx][r.star-1].split(":")[0];
            }
        }
    });

    const totalAtk = Math.floor((player.baseAtk + relicAtkAdd) * relicAtkMul * skillMul);
    const dmg = Math.floor(totalAtk * (0.9 + Math.random() * 0.2));
    
    if(activeSkillName) addLog(`<span style="color:var(--primary); font-weight:bold;">【${activeSkillName}】発動！ ${skillMul.toLocaleString()}倍撃！</span>`);
    addLog(`魔神に ${dmg.toLocaleString()} ダメージ！`);

    if(dmg > maxDmg) maxDmg = dmg;
    
    // 経験値（完全与ダメ比例）
    const expGain = (dmg / (player.lv * 100));
    player.exp += expGain;
    while(player.exp >= 100) {
        player.lv++;
        player.exp -= 100;
        addLog(`<span style="color:orange; font-weight:bold;">Lv UP! 現在 Lv${player.lv}</span>`);
    }

    if(Math.random() < 0.1) dropRelic();
    save(); refreshUI();
}

function dropRelic() {
    const rnt = Math.random() * 10000;
    let star = 1;
    if(rnt < 1) star = 10;
    else if(rnt < 10) star = 9;
    else if(rnt < 50) star = 8;
    else if(rnt < 150) star = 7;
    else if(rnt < 500) star = 6;
    else if(rnt < 1500) star = 5;
    else if(rnt < 3000) star = 4;
    else if(rnt < 5000) star = 3;
    else if(rnt < 7500) star = 2;

    let candidates = RELIC_MASTER.filter(r => r.star === star);
    if(star >= 6) candidates = candidates.filter(r => player.inventory[r.id] === 0);
    if(candidates.length === 0) return;

    const r = candidates[Math.floor(Math.random() * candidates.length)];
    player.inventory[r.id]++;
    
    if(star >= 6) {
        document.getElementById("game-body").classList.add("flash-effect");
        setTimeout(()=>document.getElementById("game-body").classList.remove("flash-effect"),500);
        addLog(`<span style="color:var(--rare); font-weight:bold;">★超希少遺物獲得：【${r.name}】★</span>`);
    } else {
        addLog(`遺物【${r.name}】を入手`);
    }
}

function refreshUI() {
    document.getElementById("exp-bar").style.width = Math.min(100, player.exp) + "%";
    document.getElementById("exp-text").innerText = Math.floor(player.exp) + "%";
    document.getElementById("p-lv").innerText = player.lv;
    document.getElementById("p-atk").innerText = "計算中..."; // 攻撃時に確定
    document.getElementById("p-death").innerText = player.deathCount;
    if(document.activeTab === 'status') renderStatus();
    if(document.activeTab === 'relic') renderRelic();
}

function showTab(id) {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.querySelectorAll(".nav button").forEach(b => b.classList.remove("active"));
    document.getElementById(id).classList.add("active");
    document.getElementById("nav-" + id).classList.add("active");
    document.activeTab = id;
    if(id === 'status') renderStatus();
    if(id === 'relic') renderRelic();
    if(id === 'power') renderPower();
}

function renderRelic() {
    let h = `<div class="relic-grid">`;
    // ⭐︎1から表示（昇順ソート）
    const owned = [];
    player.inventory.forEach((count, id) => { if(count > 0) owned.push({id, count, ...RELIC_MASTER[id]}); });
    owned.sort((a,b) => a.star - b.star);

    owned.forEach(r => {
        h += `<div class="relic-card ${r.star>=6?'relic-epic':''}">
            <b>⭐︎${r.star} ${r.name}</b><br>
            所持: ${r.count}個<br>
            効果: ${r.type}${r.val >= 10 ? (r.isPercent ? ' +'+r.val+'%' : ' +'+r.val) : ''}
        </div>`;
    });
    h += `</div>`;
    document.getElementById("relic").innerHTML = h || "遺物未所持";
}

function renderStatus() {
    document.getElementById("status").innerHTML = `
        <div class="card-cell">
            <h3>能力詳細</h3>
            <div class="stat-row"><span>基礎ATK</span><span class="stat-val">${player.baseAtk.toLocaleString()}</span></div>
            <div class="stat-row"><span>最大ダメージ</span><span class="stat-val">${maxDmg.toLocaleString()}</span></div>
            <div class="stat-row"><span>再起の誓い</span><span class="stat-val">${player.deathCount}回</span></div>
        </div>
        <button onclick="localStorage.clear();location.reload();" style="font-size:0.6em; opacity:0.5;">初期化</button>`;
}

function renderPower() {
    let h = "";
    POWER_NAMES.forEach((n, i) => {
        h += `<div style="font-size:0.8em; margin-bottom:10px; border-bottom:1px solid #eee;"><b>【権能】${n}</b><br>`;
        SKILL_DATA[i].forEach((s, si) => { h += ` ⭐︎${si+1} ${s.split(":")[0]} / `; });
        h += `</div>`;
    });
    document.getElementById("power").innerHTML = h;
}

function addLog(m) {
    const l = document.getElementById("log");
    const d = document.createElement("div"); d.innerHTML = m;
    l.prepend(d); if(l.childNodes.length > 30) l.removeChild(l.lastChild);
}

init();
</script>
</body>
</html>

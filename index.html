<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>é­”ç¥è¨ä¼ä¼ - é—˜äº‰ã®è¨˜éŒ² -</title>
<style>
    :root {
        --bg: #ffffff; --panel: #f1f3f5; --border: #dee2e6;
        --primary: #007bff; --text: #212529; --sub: #6c757d;
        --accent: #dc3545; --gold: #d39e00; --death: #6f42c1;
        --heal: #28a745;
    }
    body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
    
    #header { background: var(--panel); padding: 10px; border-bottom: 2px solid var(--border); flex-shrink: 0; }
    .status-line { display: flex; justify-content: space-between; font-size: 0.75em; font-weight: bold; margin-bottom: 2px; }
    .bar { height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden; border: 1px solid var(--border); margin-bottom: 5px; }
    .fill { height: 100%; transition: width 0.05s linear; }
    #bosshp { background: linear-gradient(90deg, #ffc107, #dc3545); }
    #playerhp { background: linear-gradient(90deg, #28a745, #20c997); }
    
    .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
    .stat-box { background: #fff; padding: 5px; border-radius: 4px; border: 1px solid var(--border); text-align: center; }
    .stat-label { font-size: 0.6em; color: var(--sub); display: block; }
    .stat-val { font-size: 0.8em; font-weight: bold; }

    .nav { display: flex; background: var(--panel); border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .nav button { flex: 1; padding: 12px 0; border: none; background: none; color: var(--sub); font-weight: bold; font-size: 0.8em; cursor: pointer; }
    .nav button.active { color: var(--primary); border-bottom: 3px solid var(--primary); background: #fff; }

    #content { flex-grow: 1; overflow-y: auto; position: relative; }
    .tab { display: none; padding: 15px; height: 100%; box-sizing: border-box; }
    .tab.active { display: block; }

    .battle-layout { display: flex; flex-direction: column; height: 100%; }
    .btn-attack { width: 100%; padding: 20px; background: var(--primary); color: #fff; font-size: 1.2em; font-weight: bold; border: none; border-radius: 8px; flex-shrink: 0; cursor: pointer; }
    
    #log { flex-grow: 1; margin-top: 10px; overflow-y: auto; font-size: 0.8em; background: #fafafa; padding: 10px; border: 1px solid var(--border); border-radius: 5px; line-height: 1.4; }
    .log-atk { color: var(--text); }
    .log-def { color: var(--accent); font-weight: bold; }
    .log-exp { color: var(--primary); font-size: 0.9em; }

    .detail-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: #fff; z-index: 10; padding: 15px; display: none; overflow-y: auto; }
    .close-btn { background: var(--sub); color: #fff; border: none; padding: 8px 15px; border-radius: 4px; margin-bottom: 10px; }
    .relic-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
    .relic-cell { background: #fff; border: 1px solid var(--border); padding: 8px; font-size: 0.75em; display: flex; justify-content: space-between; }
</style>
</head>
<body>

<div id="header">
    <div class="status-line"><span>é­”ç¥ï¼šæ¨©èƒ½</span><span id="bosshp-text">100.00%</span></div>
    <div class="bar"><div id="bosshp" class="fill" style="width: 100%;"></div></div>
    
    <div class="status-line"><span>ç”Ÿå‘½åŠ›</span><span id="playerhp-text">1000 / 1000</span></div>
    <div class="bar"><div id="playerhp" class="fill" style="width: 100%;"></div></div>

    <div class="stats-grid">
        <div class="stat-box"><span class="stat-label">ä¸»äººå…¬ Lv</span><span id="p-lv" class="stat-val">1</span></div>
        <div class="stat-box"><span class="stat-label">ç¾åœ¨ã®è·æ¥­</span><span id="p-job-lv" class="stat-val">---</span></div>
        <div class="stat-box"><span class="stat-label">ç´¯è¨ˆæ•—åŒ—æ•°</span><span id="p-death" class="stat-val" style="color:var(--death)">0</span></div>
    </div>
</div>

<div class="nav">
    <button onclick="showTab('battle', this)" class="active">è¨ä¼</button>
    <button onclick="showTab('job', this)">è·æ¥­</button>
    <button onclick="showTab('skills', this)">ã‚¹ã‚­ãƒ«</button>
    <button onclick="showTab('equip', this)">éºç‰©</button>
</div>

<div id="content">
    <div id="battle" class="tab active">
        <div class="battle-layout">
            <button class="btn-attack" id="attackBtn">é­”ç¥ã«æ”»æ’ƒ</button>
            <div id="log"></div>
        </div>
    </div>
    <div id="job" class="tab"><div id="jobList"></div></div>
    <div id="skills" class="tab"><div id="ownedSkillList"></div></div>
    <div id="equip" class="tab"><div class="relic-grid" id="relicGrid"></div></div>
    <div id="detailPanel" class="detail-overlay">
        <button class="close-btn" onclick="closeDetail()">æˆ»ã‚‹</button>
        <div id="detailContent"></div>
    </div>
</div>

<script>
const BOSS_MAX_HP = 1e24;
const JOBS_DATA = {
    "å‰£è–": ["çƒˆé¢¨æ–¬", "é›·é³´ä¸€é–ƒ", "ç©ºç ´æ–¬", "å¥¥ç¾©ãƒ»å¤©æ–­", "ç¥æ®ºã—ã®åˆƒ"],
    "ç¥å®˜": ["ç™’ã—ã®å…‰", "å®ˆè­·ã®çµç•Œ", "å¤©ç½°ã®å…‰", "å¥‡è·¡ã®é¢¨", "è–åŸŸã®å®ˆã‚Š"],
    "é­”å°å¸«": ["ç«ç‚çƒ", "æ°·çµæ§", "è½é›·", "å´©å£Šã®é­”å°", "å®‡å®™ã®çœŸç†"],
    "ç‹©äºº": ["é€Ÿå°„", "ç‹™ã„æ’ƒã¡", "æ¯’ã®çŸ¢", "å½±ç¸«ã„", "æµæ˜Ÿã®é›¨"],
    "æ­¦é—˜å®¶": ["æ­£æ‹³çªã", "é€£æ’ƒ", "æ°—åŠŸç ²", "çˆ†è£‚æ‹³", "ç ´å¤©ã®æ§‹ãˆ"],
    "æš—æ®ºè€…": ["æ€¥æ‰€çªã", "ç…™å¹•", "çŒ›æ¯’ã®åˆƒ", "å½±æ¸¡ã‚Š", "ç„¡éŸ³ã®çµ‚ç„‰"],
    "å¿è€…": ["æ‰‹è£å‰£", "ç«éã®è¡“", "åˆ†èº«ã®è¡“", "é›·åˆ‡", "ç§˜è¡“ãƒ»å¾®å¡µ"],
    "è–é¨å£«": ["ç›¾æ‰“ã¡", "çµ¶å¯¾é˜²å¾¡", "å¯©åˆ¤ã®æ§Œ", "è–ãªã‚‹è¡Œé€²", "ä¸è½ã®åŸå¡"],
    "ç‹‚æˆ¦å£«": ["çŒ›æ’ƒ", "ç²‰ç •", "é›„ãŸã‘ã³", "è¡€ã®ç¥ç¥­", "é­‚ã®ç ´å£Š"],
    "æ§è¡“å£«": ["è²«é€šçªã", "æ—‹å›ä¸€é–ƒ", "èºæ—‹ã®ç‰™", "é¾ã®å’†å“®", "å¤©ç©ºã‚’ç©¿ã¤æ§"],
    "å¼“è–": ["äºŒé€£å°„", "é­”çŸ¢", "æ—‹é¢¨ã®çŸ¢", "çˆ†è£‚ã®çŸ¢", "æ˜Ÿå •ã¨ã—"],
    "éŒ¬é‡‘è¡“å¸«": ["è–¬å“æŠ•æ“²", "ç‰©è³ªå¤‰åŒ–", "é‡‘å‰›åŒ–", "çˆ†ç™ºç”Ÿæˆ", "è³¢è€…ã®çŸ³"],
    "æ­»éœŠä½¿ã„": ["äº¡è€…ã®å¬å–š", "å‘ªã„ã®éœ§", "é­‚ã®å¸å", "æ­»éœŠã®è»å‹¢", "å†¥åºœã®é–€"],
    "é¢¨è¡“å¸«": ["é¢¨ã®åˆƒ", "ç«œå·»", "ç–¾é¢¨ã®åŠ è­·", "çœŸç©ºæ³¢", "ç¥é¢¨ã®æ€’ã‚Š"],
    "é‡é¨å£«": ["å¤§ç›¾ã®æ§‹ãˆ", "ä½“å½“ãŸã‚Š", "åœ°éŸ¿ã", "ä¸å±ˆã®ç²¾ç¥", "é‡åŠ›å´©å£Š"],
    "å†’é™ºè€…": ["é‘‘å®š", "èµ·æ­»å›ç”Ÿ", "å¹¸é‹ã®ãƒ€ã‚¤ã‚¹", "ãŠå®ç™ºè¦‹", "è‹±é›„ã®è¨¼"],
    "è¦‡ç‹": ["è¦‡æ°—", "æ”¯é…ã®çœ¼å…‰", "æ¬¡å…ƒã®è¹‚è™™", "è¦‡é“ä¸€æ’ƒ", "å¤©åœ°é–‹é—¢"],
    "æ‹³é—˜å£«": ["ãƒ©ãƒƒã‚·ãƒ¥", "å›é¿", "ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼", "KOãƒ‘ãƒ³ãƒ", "ç„¡åŒã®æ‹³"],
    "æ§ç‹": ["ä¸€çªã", "ä¹±èˆ", "é¾å·»", "ç¥ã®çªã", "éŠ€æ²³è²«é€š"],
    "è³¢è€…": ["çŸ¥æµã®é–ƒã", "é­”åŠ›åæŸ", "æ™‚ç©ºé­”æ³•", "å› æœé€†è»¢", "å…¨çŸ¥å…¨èƒ½"]
};
const R_PREFIX = ["å¤ã®", "è–ãªã‚‹", "æ·±æ·µã®", "é­”ç¥ã®", "æ˜Ÿã®"];
const R_NAME = ["æŒ‡è¼ª", "é­”çŸ³", "åˆ»å°", "è–æ¯", "å† "];
const R_SUFFIX = ["ã®è¨˜æ†¶", "ã®è¼ã", "ã®æ¬ ç‰‡"];

let p, longPressIdx, isProcessing = false;
const SAVE_KEY = "MAJIN_REBIRTH_STABLE_V2";

function init() {
    const saved = localStorage.getItem(SAVE_KEY);
    p = saved ? JSON.parse(saved) : {
        lv: 1, exp: 0, job: "å‰£è–", inventory: {}, 
        jobLevels: {}, jobExp: {}, bossTotalDmg: 0, deathCount: 0, playerHP: 1000
    };
    Object.keys(JOBS_DATA).forEach(j => {
        if (!p.jobLevels[j]) p.jobLevels[j] = 1;
        if (p.jobExp[j] === undefined) p.jobExp[j] = 0;
    });
    refresh();
    
    const btn = document.getElementById("attackBtn");
    btn.addEventListener("mousedown", (e) => { e.preventDefault(); startBattle(); });
    btn.addEventListener("mouseup", stopBattle);
    btn.addEventListener("mouseleave", stopBattle);
    btn.addEventListener("touchstart", (e) => { e.preventDefault(); startBattle(); }, {passive: false});
    btn.addEventListener("touchend", stopBattle);
}

function startBattle() { if (!longPressIdx) { battle(); longPressIdx = setInterval(battle, 100); } }
function stopBattle() { clearInterval(longPressIdx); longPressIdx = null; }

function getRelicData(id) {
    const seed = parseInt(id);
    const types = ["æ”»æ’ƒåŠ›", "æœ€å¤§ä½“åŠ›", "ä¸ãƒ€ãƒ¡ãƒ¼ã‚¸", "ç™ºè¦‹ç‡"];
    const typeKey = ["ATK", "HP", "DMG", "DROP"][seed % 4];
    const isDeathType = (seed % 13 === 0);
    const isGold = (seed % 100 === 0);
    const baseVal = isGold ? (seed % 10 + 1) * 20 : (seed % 10 + 1);
    const name = (isDeathType ? "æ­»ã‚’å–°ã‚‰ã†" : R_PREFIX[seed % 5]) + R_NAME[(seed >> 2) % 5] + R_SUFFIX[seed % 3];
    return { id, name, typeKey, val: baseVal, effectText: isDeathType ? `æ•—åŒ—æ•°ã«å¿œã˜ã¦å¼·åŒ–` : `${types[seed%4]}ã‚’å¼·åŒ–`, isGold, isDeathType };
}

function battle() {
    if (isProcessing) return;
    isProcessing = true;

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨ˆç®—
    let atk = 500 + (p.lv * 100) + (p.jobLevels[p.job] * 50);
    let maxHP = 1000 + (p.lv * 100);
    let dmgM = 1.0;
    Object.keys(p.inventory).forEach(id => {
        const d = getRelicData(id); const count = p.inventory[id];
        if (d.isDeathType) dmgM *= (1 + (p.deathCount * d.val * 0.0001 * count));
        else if (d.typeKey === "ATK") atk += d.val * count;
        else if (d.typeKey === "HP") maxHP += d.val * count;
        else if (d.typeKey === "DMG") dmgM += d.val * 0.01 * count;
    });
    p.maxHP = maxHP;

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ”»æ’ƒ
    let dmg = Math.floor(atk * (0.9 + Math.random() * 0.2) * dmgM);
    p.bossTotalDmg += dmg;
    let gain = Math.floor(dmg * 0.1) + 50;
    p.exp += gain; p.jobExp[p.job] += gain;

    addLog(`<span class="log-atk">âš”ï¸ é­”ç¥ã¸ ${dmg.toLocaleString()} ãƒ€ãƒ¡ãƒ¼ã‚¸</span>`);
    addLog(`<span class="log-exp">âœ¨ çµŒé¨“å€¤ ${gain.toLocaleString()} ç²å¾—</span>`);

    // é­”ç¥ã®åæ’ƒ
    let enemyDmg = Math.floor(p.maxHP * 1.5); // å¿…ãšæ­»ã¬ãƒ€ãƒ¡ãƒ¼ã‚¸
    p.playerHP = 0; // è¡¨ç¤ºä¸ŠHPã‚’0ã«ã™ã‚‹
    p.deathCount++;

    addLog(`<span class="log-def">ğŸ’¥ é­”ç¥ã®æ”»æ’ƒï¼š${enemyDmg.toLocaleString()} ãƒ€ãƒ¡ãƒ¼ã‚¸å—é ˜</span>`);

    // å³åº§ã«å¾©æ´»
    p.playerHP = p.maxHP;

    if (Math.random() < 0.1) {
        let rId = Math.floor(Math.random() * 500);
        p.inventory[rId] = (p.inventory[rId] || 0) + 1;
        addLog(`<span style="color:var(--gold)">â˜… éºç‰©ï¼š${getRelicData(rId).name} ç²å¾—</span>`);
    }

    checkLevelUp();
    refresh();
    isProcessing = false;
}

function checkLevelUp() {
    let next = Math.pow(p.lv, 3) * 500;
    while (p.exp >= next && p.lv < 9999) { p.exp -= next; p.lv++; next = Math.pow(p.lv, 3) * 500; }
    let jNext = Math.pow(p.jobLevels[p.job], 3) * 300;
    while (p.jobExp[p.job] >= jNext && p.jobLevels[p.job] < 999) { p.jobExp[p.job] -= jNext; p.jobLevels[p.job]++; jNext = Math.pow(p.jobLevels[p.job], 3) * 300; }
}

function refresh() {
    let hpPer = Math.max(0, 100 - (p.bossTotalDmg / BOSS_MAX_HP * 100));
    document.getElementById("bosshp").style.width = hpPer + "%";
    document.getElementById("bosshp-text").innerText = hpPer.toFixed(10) + "%";
    
    document.getElementById("playerhp").style.width = "100%";
    document.getElementById("playerhp-text").innerText = `${p.maxHP.toLocaleString()} / ${p.maxHP.toLocaleString()}`;
    
    document.getElementById("p-lv").innerText = p.lv;
    document.getElementById("p-job-lv").innerText = `${p.job} Lv.${p.jobLevels[p.job]}`;
    document.getElementById("p-death").innerText = p.deathCount;

    if (document.getElementById("job").classList.contains("active")) {
        document.getElementById("jobList").innerHTML = Object.keys(JOBS_DATA).map(j => `
            <div class="list-item" onclick="openJobDetail('${j}')">
                <span><b>${j}</b> <small>Lv.${p.jobLevels[j]}</small></span>
                <button onclick="event.stopPropagation(); p.job='${j}'; refresh();" style="color:var(--primary); background:none; border:1px solid var(--primary); border-radius:4px; padding:2px 8px;">${p.job === j ? 'é¸æŠä¸­' : 'è»¢è·'}</button>
            </div>
        `).join("");
    }

    if (document.getElementById("skills").classList.contains("active")) {
        document.getElementById("ownedSkillList").innerHTML = JOBS_DATA[p.job].map((s, i) => {
            if (p.jobLevels[p.job] < (i + 1) * 10) return "";
            return `<div class="skill-card"><b>ã€${s}ã€‘</b><br><small>ä¸ãƒ€ãƒ¡ãƒ¼ã‚¸ ${(i+1)*20}% å¢—å¹…</small></div>`;
        }).join("") || "<p style='text-align:center; color:var(--sub);'>Lv.10ã§ç¿’å¾—</p>";
    }

    if (document.getElementById("equip").classList.contains("active")) {
        document.getElementById("relicGrid").innerHTML = Object.keys(p.inventory).map(id => {
            const d = getRelicData(id);
            const rareStyle = d.isGold ? 'color:var(--gold); font-weight:bold;' : (d.isDeathType ? 'color:var(--death);' : '');
            return `<div class="relic-cell" onclick="openRelicDetail(${id})"><span style="${rareStyle}">${d.name}</span><span>Ã—${p.inventory[id]}</span></div>`;
        }).join("");
    }
    localStorage.setItem(SAVE_KEY, JSON.stringify(p));
}

function addLog(m) {
    const l = document.getElementById("log");
    l.innerHTML = `<div>${m}</div>` + l.innerHTML;
    if (l.childNodes.length > 25) l.removeChild(l.lastChild);
}

function openJobDetail(jName) {
    const lv = p.jobLevels[jName];
    let html = `<h3>${jName}</h3><p>ã‚¸ãƒ§ãƒ–ãƒ¬ãƒ™ãƒ«: ${lv}</p><hr>`;
    JOBS_DATA[jName].forEach((s, i) => { html += `<div style="color:${lv >= (i+1)*10 ? 'var(--primary)' : '#ccc'}">Lv.${(i+1)*10}: ${s}</div>`; });
    showDetail(html);
}

function openRelicDetail(id) {
    const d = getRelicData(id);
    showDetail(`<h3>${d.name}</h3><p>æ‰€æŒæ•°: ${p.inventory[id]}</p><hr><p>${d.effectText}</p>`);
}

function showDetail(content) { document.getElementById("detailContent").innerHTML = content; document.getElementById("detailPanel").style.display = "block"; }
function closeDetail() { document.getElementById("detailPanel").style.display = "none"; }

function showTab(id, btn) {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.getElementById(id).classList.add("active");
    document.querySelectorAll(".nav button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    refresh();
}
init();
</script>
</body>
</html>

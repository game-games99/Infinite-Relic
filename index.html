<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>RELICORE - v2.2.9-DEBUG-FULL</title>
<style>
    /* v2.2.9の全スタイルを完全継承 */
    :root { --bg: #ffffff; --panel: #f8f9fa; --border: #dee2e6; --primary: #007bff; --text: #212529; --hp: #dc3545; --dark: #1a1a1a; }
    * { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; box-sizing: border-box; }
    body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
    .c1 { color: #888888; font-weight: bold; } .c2 { color: #28a745; font-weight: bold; } .c3 { color: #007bff; font-weight: bold; }
    .c4 { color: #6610f2; font-weight: bold; } .c5 { color: #e83e8c; font-weight: bold; } .c6 { color: #fd7e14; font-weight: bold; }
    .c7 { color: #d9534f; font-weight: bold; } .c11 { color: #ffc107; font-weight: bold; } .c12 { color: gold; font-weight: bold; }
    #story-modal, #clear-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 10000; justify-content: center; align-items: center; padding: 20px; }
    .story-content, .modal-content { max-width: 500px; color: #fff; text-align: center; }
    #header { background: var(--dark); color: #fff; padding: 12px 10px; border-bottom: 2px solid #000; flex-shrink: 0; }
    .hp-bar-container { background: #333; height: 10px; border-radius: 5px; overflow: hidden; margin-bottom: 8px; }
    #hp-bar-fill { height: 100%; background: linear-gradient(90deg, #b02a37, #dc3545); width: 100%; transition: width 0.15s; }
    .hp-val-display { font-size: 1.45em; font-weight: bold; color: #ff6b6b; text-align: center; font-family: monospace; }
    .nav { display: flex; background: var(--panel); border-bottom: 1px solid var(--border); }
    .nav button { flex: 1; padding: 12px 0; border: none; background: none; font-size: 0.8em; font-weight: bold; color: #6c757d; }
    .nav button.active { color: var(--primary); border-bottom: 3px solid var(--primary); background: #fff; }
    #content-area { flex-grow: 1; overflow: hidden; position: relative; }
    .tab { display: none; padding: 10px; height: 100%; overflow-y: auto; }
    .tab.active { display: block; }
    .btn-attack { width: 100%; padding: 20px; background: var(--primary); color: #fff; font-size: 1.4em; font-weight: bold; border: none; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 4px 0 #0056b3; }
    #log { height: 350px; font-size: 0.85em; background: #fafafa; border: 1px solid var(--border); padding: 10px; overflow-y: auto; border-radius: 8px; }
    .vow-item { background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 8px; margin-bottom: 10px; border-left: 4px solid gold; }
    .relic-list-container { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .relic-card { border: 1px solid var(--border); padding: 8px; border-radius: 8px; background: #fff; font-size: 0.75em; }
    .power-section { border: 1px solid var(--border); margin-bottom: 10px; border-radius: 8px; overflow: hidden; }
    .power-head { background: #eee; padding: 8px; font-weight: bold; display: flex; justify-content: space-between; font-size: 0.8em; }
    .skill-row { padding: 4px 8px; border-bottom: 1px solid #eee; font-size: 0.7em; }
</style>
</head>
<body>
<div id="story-modal"><div class="story-content"><h3>灰の中から、何度でも立ち上がれ.</h3><button onclick="closeStory()" style="color:gold; border:1px solid gold; background:none; padding:10px 20px;">運命を受け入れる</button></div></div>
<div id="clear-modal"><div class="modal-content"><h2 id="modal-title">討伐成功</h2><button onclick="closeClearModal()" style="color:gold; border:1px solid gold; background:none; padding:10px 20px;">次なる戦いへ</button></div></div>

<div id="header">
    <div class="boss-name" id="boss-display-name" style="text-align:center; color:#888;">魔神</div>
    <div class="hp-bar-container"><div id="hp-bar-fill"></div></div>
    <div class="hp-val-display" id="bosshp-cur">0</div>
    <div class="status-box" style="display:flex; gap:8px; margin-top:10px;">
        <div class="stat-card" style="flex:1; border-left:3px solid var(--primary); background:rgba(255,255,255,0.1); padding:5px;"><span style="font-size:0.6em; color:#aaa;">ATK</span><div id="p-atk" style="font-weight:bold; font-size:0.9em;">0</div></div>
        <div class="stat-card" style="flex:1; border-left:3px solid var(--hp); background:rgba(255,255,255,0.1); padding:5px;"><span style="font-size:0.6em; color:#aaa;">HP</span><div id="p-hp" style="font-weight:bold; font-size:0.9em;">0</div></div>
    </div>
</div>

<div class="nav">
    <button onclick="showTab('battle')" id="nav-battle" class="active">討伐</button>
    <button onclick="showTab('vow')" id="nav-vow">再起</button>
    <button onclick="showTab('power')" id="nav-power">権能</button>
    <button onclick="showTab('relic')" id="nav-relic">遺物</button>
    <button onclick="showTab('status')" id="nav-status">詳細</button>
</div>

<div id="content-area">
    <div id="battle" class="tab active"><button class="btn-attack" id="attackBtn">こうげき</button><div id="log"></div></div>
    <div id="vow" class="tab"><div id="vow-list"></div></div>
    <div id="power" class="tab"><div id="power-content"></div></div>
    <div id="relic" class="tab"><div class="relic-list-container" id="relic-list"></div></div>
    <div id="status" class="tab"><div id="status-info" style="font-size:0.8em; background:#f8f9fa; padding:10px; border-radius:8px;"></div></div>
</div>

<script>
// データ定義：v2.2.9から完全移植
const BOSS_MAX_HP_BASE = 100000000000000000000n; 
const BOSS_MAX_HP_ENDLESS = 1000000000000000000000000000000000000000000000000000000000000n;
const RELIC_MASTER = [
    {id:0, star:12, name:"再起の誓い", atk:0, hp:0, pIdx:-1, desc:"勇者の魂に刻まれた誓い。"},
    {id:101, star:1, name:"勇者の木片", atk:3, hp:0, pIdx:0}, {id:102, star:1, name:"野草の滴", atk:0, hp:14, pIdx:1}, {id:103, star:1, name:"冒険の証", atk:2, hp:9, pIdx:2}, {id:104, star:1, name:"兵士の号令", atk:7, hp:15, pIdx:3}, {id:105, star:1, name:"虚ろな石", atk:4, hp:10, pIdx:4},
    {id:201, star:2, name:"鉄の剣", atk:17, hp:0, pIdx:0}, {id:202, star:2, name:"兵士の盾", atk:0, hp:126, pIdx:1}, {id:203, star:2, name:"熟練の証", atk:13, hp:55, pIdx:2}, {id:204, star:2, name:"鋼の篭手", atk:28, hp:45, pIdx:3}, {id:205, star:2, name:"影の残滓", atk:44, hp:60, pIdx:4},
    {id:301, star:3, name:"魔力剣", atk:137, hp:0, pIdx:0}, {id:302, star:3, name:"命の硬玉", atk:0, hp:772, pIdx:1}, {id:303, star:3, name:"知恵の輪", atk:144, hp:233, pIdx:2}, {id:304, star:3, name:"騎士の魂", atk:312, hp:450, pIdx:3}, {id:305, star:3, name:"深淵の破片", atk:444, hp:666, pIdx:4},
    {id:401, star:4, name:"王宮の秘宝", atk:5777, hp:0, pIdx:0}, {id:402, star:4, name:"聖樹の種", atk:0, hp:24680, pIdx:1}, {id:403, star:4, name:"伝説の断片", atk:8192, hp:12000, pIdx:2}, {id:404, star:4, name:"覇道の手引書", atk:18888, hp:25000, pIdx:3}, {id:405, star:4, name:"破滅の引き金", atk:44444, hp:66666, pIdx:4},
    {id:501, star:5, name:"天界の神剣", atk:677777, hp:0, pIdx:0}, {id:502, star:5, name:"神殺しの刃", atk:1333337, hp:0, pIdx:0}, {id:503, star:5, name:"慈愛の聖杯", atk:0, hp:654321, pIdx:1}, {id:504, star:5, name:"神格の心臓", atk:0, hp:1888888, pIdx:1}, {id:505, star:5, name:"魔力回路の核", atk:987654, hp:1500000, pIdx:2}, {id:506, star:5, name:"真理の到達者", atk:2178281, hp:3000000, pIdx:2}, {id:507, star:5, name:"王者の刻印", atk:3333333, hp:4500000, pIdx:3}, {id:508, star:5, name:"大号令の旗", atk:5555555, hp:7777777, pIdx:3}, {id:509, star:5, name:"虚空の魔眼", atk:6666666, hp:8888888, pIdx:4}, {id:510, star:5, name:"魔神の供物", atk:9999999, hp:12000000, pIdx:4}, {id:511, star:5, name:"失われた聖典", atk:1234567, hp:2000000, pIdx:2},
    {id:601, star:6, name:"【絶】の小太刀", atk:12345678, hp:0, pIdx:0, mult:1.1}, {id:602, star:6, name:"【永】の古盾", atk:0, hp:24242424, pIdx:1, mult:1.1}, {id:603, star:6, name:"【叡】の頁", atk:9988776, hp:15000000, pIdx:2, mult:1.1}, {id:604, star:6, name:"【凱】の徴", atk:18181818, hp:25000000, pIdx:3, mult:1.1}, {id:605, star:6, name:"【零】の塵", atk:44444444, hp:60000000, pIdx:4, mult:1.1},
    {id:701, star:7, name:"【絶】の長剣", atk:150000000, hp:0, pIdx:0, mult:1.2}, {id:702, star:7, name:"【永】の鉄壁", atk:0, hp:300000000, pIdx:1, mult:1.2}, {id:703, star:7, name:"【叡】の魔導書", atk:120000000, hp:180000000, pIdx:2, mult:1.2}, {id:704, star:7, name:"【凱】の軍旗", atk:200000000, hp:300000000, pIdx:3, mult:1.2}, {id:705, star:7, name:"【零】の裂け目", atk:250000000, hp:400000000, pIdx:4, mult:1.2},
    {id:801, star:8, name:"【絶】界の神滅", atk:1000000000, hp:0, pIdx:0, mult:1.5}, {id:802, star:8, name:"【永】劫の聖域", atk:0, hp:2000000000, pIdx:1, mult:1.5}, {id:803, star:8, name:"【叡】智の真理", atk:888888888, hp:1200000000, pIdx:2, mult:1.5}, {id:804, star:8, name:"【凱】旋の覇道", atk:1500000000, hp:2500000000, pIdx:3, mult:1.5}, {id:805, star:8, name:"【零】の侵食", atk:2500000000, hp:4000000000, pIdx:4, mult:1.5},
    {id:901, star:9, name:"【絶】界・多重定義", atk:10000000000, hp:0, pIdx:0, mult:2.0}, {id:902, star:9, name:"【永】死生超越の理", atk:0, hp:20000000000, pIdx:1, mult:2.0}, {id:903, star:9, name:"【叡】真理の法典", atk:9999999999, hp:15000000000, pIdx:2, mult:2.0}, {id:904, star:9, name:"【凱】覇道の極致", atk:15000000000, hp:25000000000, pIdx:3, mult:2.0}, {id:905, star:9, name:"【零】無窮の深淵", atk:25000000000, hp:40000000000, pIdx:4, mult:2.0},
    {id:1001, star:10, name:"パンドラの箱", atk:54321098765, hp:88888888888, pIdx:3, mult:100.0},
    {id:1101, star:11, name:"終焉の福音", atk:999999999999, hp:1500000000000, pIdx:4, mult:1000.0}
];
const POWERS = [{name:"剣神",s:["一の太刀","心气一致","万象一掃","天断の極意","極限一閃"]},{"name:"不滅",s:["生命の根源","再誕の輝き","不撓不屈","死を超越せし者","不滅王"]},{"name:"魔導",s:["魔力回路","魔力奔流","理の解析","古の叡智","真理の扉"]},{"name:"覇王",s:["万軍の主","覇王の威光","統率の理","覇道の足跡","終焉の号令"]},{"name:"虚無",s:["忘却の彼方","深淵の理","残滓の追撃","無に帰す一撃","虚無の深淵"]}];

// 状態初期化（デバッグルール適用）
let player = {
    inventory: {}, // 後で全遺物1個ずつ追加
    deathCount: 100000,
    baseAtk: 10n, baseHP: 100n,
    maxDmg: 0n, isEndless: false, storySeen: false,
    powerPts: [10000000, 10000000, 10000000, 10000000, 10000000] // 全解放
};
let currentBossHP = BOSS_MAX_HP_BASE;
let attackInterval = null;
let isModalOpen = false;

function initDebug() {
    RELIC_MASTER.forEach(r => player.inventory[r.id] = 1);
    refreshUI();
}

function attack() {
    if(isModalOpen) return;
    const b = getRelicBonus();
    
    // 多段ヒットを排除し一撃に集約
    let deathDmgMult = 1.0 + (player.deathCount * 0.000004);
    let powerMult = (1.0 + (Object.keys(player.inventory).length * 0.2)) * deathDmgMult;
    let totalAtk = (player.baseAtk * 120n / 100n + b.atk);
    let finalDamage = BigInt(Math.floor(Number(totalAtk) * b.mult * powerMult));
    
    currentBossHP -= finalDamage;
    addLog(`<span style="color:#007bff; font-weight:bold;">${finalDamage.toLocaleString()} ダメージ！</span>`);
    addLog(`<span style="color:#dc3545;">魔神の攻撃！ 999,999,999,999ダメージ。再起の誓いによって新たなる力を得た</span>`);

    if(currentBossHP <= 0n) {
        currentBossHP = 0n;
        isModalOpen = true;
        document.getElementById("clear-modal").style.display = "flex";
        handleDrop(5 + 4); // 魂の研磨ボーナス+4固定
    } else {
        if(Math.random() < 0.05) handleDrop(1 + 4);
    }
    refreshUI();
}

function handleDrop(count) {
    for(let i=0; i<count; i++) {
        let r = RELIC_MASTER[Math.floor(Math.random()*RELIC_MASTER.length)];
        player.inventory[r.id] = (player.inventory[r.id] || 0) + 1;
        addLog(`<span class="c${r.star}">【獲得】★${r.star} ${r.name}</span>`);
    }
}

function getRelicBonus() {
    let atk = 0n, hp = 0n, mult = 1.0;
    let pts = [0,0,0,0,0];
    Object.entries(player.inventory).forEach(([id, c]) => {
        const r = RELIC_MASTER.find(m => m.id == id);
        if(!r) return;
        atk += BigInt(r.atk) * BigInt(c);
        hp += BigInt(r.hp) * BigInt(c);
        if(r.mult) mult *= Math.pow(r.mult, c);
        if(r.pIdx >= 0) pts[r.pIdx] += (r.star * c);
    });
    return { atk, hp, mult, pts };
}

function closeClearModal() {
    isModalOpen = false;
    document.getElementById("clear-modal").style.display = "none";
    if(!player.isEndless) {
        player.isEndless = true;
        currentBossHP = BOSS_MAX_HP_ENDLESS;
    } else {
        currentBossHP = BOSS_MAX_HP_ENDLESS;
    }
    refreshUI();
}

function refreshUI() {
    const b = getRelicBonus();
    document.getElementById("p-atk").innerText = (player.baseAtk + b.atk).toLocaleString();
    document.getElementById("p-hp").innerText = (player.baseHP + b.hp).toLocaleString();
    document.getElementById("bosshp-cur").innerText = currentBossHP.toLocaleString();
    document.getElementById("boss-display-name").innerText = player.isEndless ? "虚無の残滓 [真の姿]" : "魔神";
    let max = player.isEndless ? BOSS_MAX_HP_ENDLESS : BOSS_MAX_HP_BASE;
    document.getElementById("hp-bar-fill").style.width = Number(currentBossHP * 100n / max) + "%";
}

function showTab(id) {
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.getElementById(id).classList.add("active");
    if(id === 'power') renderPower();
    if(id === 'relic') renderRelics();
    if(id === 'vow') renderVow();
}

function renderPower() {
    const b = getRelicBonus();
    document.getElementById("power-content").innerHTML = POWERS.map((p, i) => `
        <div class="power-section"><div class="power-head"><span>${p.name}</span><span>${b.pts[i]} pt</span></div>
        ${p.s.map(s => `<div class="skill-row"><b>${s}</b> [解放済み]</div>`).join("")}</div>`).join("");
}

function renderRelics() {
    document.getElementById("relic-list").innerHTML = Object.entries(player.inventory).map(([id, c]) => {
        const r = RELIC_MASTER.find(x => x.id == id);
        return `<div class="relic-card"><b class="c${r.star}">${r.name} x${c}</b><br>ATK+${r.atk}/HP+${r.hp}</div>`;
    }).join("");
}

function renderVow() {
    document.getElementById("vow-list").innerHTML = `<div class="vow-item"><b>魂の研磨 [MAX]</b><br>ドロップ/再起ボーナス+4</div>
    <div class="vow-item"><b>不退転の力</b><br>ATK検証用</div>`;
}

function addLog(m) {
    const l = document.getElementById("log");
    const d = document.createElement("div"); d.innerHTML = m;
    l.prepend(d);
    if(l.childNodes.length > 30) l.removeChild(l.lastChild);
}

function closeStory() { document.getElementById("story-modal").style.display = "none"; }
document.getElementById("attackBtn").onclick = attack;
initDebug();
</script>
</body>
</html>

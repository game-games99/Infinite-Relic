<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>infiniterelic</title>
<style>
    /* CSSは前回の最適化レイアウトを維持 */
    :root { --bg: #ffffff; --panel: #f8f9fa; --border: #dee2e6; --primary: #007bff; --text: #212529; --sub: #6c757d; --accent: #dc3545; --gold: #d39e00; --death: #6f42c1; --exp: #28a745; --rarity0: #868e96; --rarity1: #28a745; --rarity2: #007bff; --rarity3: #a335ee; --rarity4: #ff8000; }
    body { background: var(--bg); color: var(--text); font-family: 'Helvetica Neue', Arial, sans-serif; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
    #header { background: var(--panel); padding: 8px 12px; border-bottom: 2px solid var(--border); flex-shrink: 0; font-size: 0.9em; }
    .bar-container { margin-bottom: 6px; }
    .bar-label { display: flex; justify-content: space-between; font-size: 0.85em; margin-bottom: 2px; font-weight: bold; }
    .bar { height: 10px; background: #e9ecef; border-radius: 5px; overflow: hidden; border: 1px solid rgba(0,0,0,0.1); }
    .fill { height: 100%; transition: width 0.1s ease; }
    #bosshp { background: linear-gradient(90deg, #ffc107, #dc3545); }
    #playerhp { background: linear-gradient(90deg, #28a745, #20c997); }
    #exp-bar { background: var(--primary); }
    #job-exp-bar { background: var(--death); }
    .stats-summary { display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px; margin-top: 6px; background: rgba(0,0,0,0.05); padding: 6px; border-radius: 6px; }
    .stat-item { display: flex; justify-content: space-between; font-size: 0.85em; font-weight: bold; }
    .nav { display: flex; background: var(--panel); border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .nav button { flex: 1; padding: 10px 0; border: none; background: none; color: var(--sub); font-weight: bold; font-size: 0.75em; cursor: pointer; }
    .nav button.active { color: var(--primary); border-bottom: 3px solid var(--primary); background: #fff; }
    #content { flex-grow: 1; overflow: hidden; position: relative; }
    .tab { display: none; padding: 10px; height: 100%; box-sizing: border-box; overflow-y: auto; }
    .tab.active { display: block; }
    .grid-2col { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding-bottom: 120px; }
    .card-cell { background: #fff; border: 1px solid var(--border); padding: 10px; border-radius: 8px; cursor: pointer; position: relative; }
    .job-name-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .mini-btn { padding: 4px 8px; font-size: 0.7em; background: var(--primary); color: #fff; border: none; border-radius: 4px; }
    .detail-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: #fff; z-index: 20; display: none; flex-direction: column; }
    .detail-header { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid var(--border); background: var(--panel); }
    .detail-body { flex-grow: 1; overflow-y: auto; padding: 15px; padding-bottom: 60px; }
    .skill-box { background: #f1f3f5; padding: 8px; border-radius: 6px; font-size: 0.85em; margin-bottom: 6px; }
    .btn-attack { width: 100%; padding: 12px; background: var(--primary); color: #fff; font-size: 1.0em; font-weight: bold; border: none; border-radius: 8px; }
    #log { flex-grow: 1; margin-top: 6px; overflow-y: auto; font-size: 0.7em; background: #fafafa; padding: 6px; border: 1px solid var(--border); border-radius: 4px; height: 200px; }
</style>
</head>
<body>

<div id="header">
    <div class="bar-container"><div class="bar-label"><span>魔神</span><span id="bosshp-text">100%</span></div><div class="bar"><div id="bosshp" class="fill"></div></div></div>
    <div class="bar-container"><div class="bar-label"><span>主人公HP</span><span id="playerhp-text">0/0</span></div><div class="bar"><div id="playerhp" class="fill"></div></div></div>
    <div class="bar-container"><div class="bar-label"><span id="p-lv-text">Lv.1</span><span id="exp-text">0%</span></div><div class="bar"><div id="exp-bar" class="fill"></div></div></div>
    <div class="bar-container"><div class="bar-label"><span id="p-job-text">Lv.1</span><span id="job-exp-text">0%</span></div><div class="bar"><div id="job-exp-bar" class="fill"></div></div></div>
    <div class="stats-summary">
        <div class="stat-item"><span>ATK:</span><span id="sum-atk">0</span></div>
        <div class="stat-item"><span>敗北数:</span><span id="sum-death">0</span></div>
        <div class="stat-item"><span>クリ率:</span><span id="sum-crit">5%</span></div>
        <div class="stat-item"><span>増幅:</span><span id="sum-dmg">100%</span></div>
    </div>
</div>

<div class="nav">
    <button onclick="showTab('battle', this)" class="active">討伐</button>
    <button onclick="showTab('status', this)">ステータス</button>
    <button onclick="showTab('job', this)">職業</button>
    <button onclick="showTab('equip', this)">遺物</button>
</div>

<div id="content">
    <div id="battle" class="tab active"><button class="btn-attack" id="attackBtn">魔神に攻撃</button><div id="log"></div></div>
    <div id="status" class="tab"><div id="statusList"></div></div>
    <div id="job" class="tab"><div id="jobList" class="grid-2col"></div></div>
    <div id="equip" class="tab"><div id="relicGrid" class="grid-2col"></div></div>
    
    <div id="detailPanel" class="detail-overlay">
        <div class="detail-header"><button onclick="closeDetail()">戻る</button><div style="flex-grow:1; text-align:center; font-weight:bold;">職業詳細</div></div>
        <div class="detail-body">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <button onclick="slideJob(-1)">◀ 前</button><button onclick="slideJob(1)">次 ▶</button>
            </div>
            <div id="detailContent"></div>
        </div>
    </div>
</div>

<script>
const BOSS_MAX_HP = 1e24;
const SAVE_KEY = "MAJIN_DPS_V8_FIX"; // 元のセーブキーに戻しました [cite: 2026-02-20]

const JOBS_DATA = {
    "神話の剣聖": { desc: "斬撃の極致。", skills: Array.from({length:10}, (_,i)=>({n:`剣聖技${i+1}`, e:`効果量${(i+1)*10}%アップ`})) },
    "大聖者": { desc: "徳（敗北）を力に。", skills: Array.from({length:10}, (_,i)=>({n:`聖者技${i+1}`, e:`効果量${(i+1)*10}%アップ`})) },
    "賢者魔導王": { desc: "魔法と知恵。", skills: Array.from({length:10}, (_,i)=>({n:`魔導技${i+1}`, e:`効果量${(i+1)*10}%アップ`})) },
    "至高の覇王": { desc: "最強の基礎力。", skills: Array.from({length:10}, (_,i)=>({n:`覇王技${i+1}`, e:`効果量${(i+1)*10}%アップ`})) },
    "絶影の暗殺者": { desc: "一撃必殺。", skills: Array.from({length:10}, (_,i)=>({n:`暗殺技${i+1}`, e:`効果量${(i+1)*10}%アップ`})) },
    "竜血の修羅": { desc: "戦闘の化身。", skills: Array.from({length:10}, (_,i)=>({n:`修羅技${i+1}`, e:`効果量${(i+1)*10}%アップ`})) },
    "真理の錬金術師": { desc: "遺物変換。", skills: Array.from({length:10}, (_,i)=>({n:`錬金技${i+1}`, e:`効果量${(i+1)*10}%アップ`})) },
    "神託の吟遊詩人": { desc: "万能の歌声。", skills: Array.from({length:10}, (_,i)=>({n:`詩人技${i+1}`, e:`効果量${(i+1)*10}%アップ`})) },
    "虚無の死霊使い": { desc: "死を糧に。", skills: Array.from({length:10}, (_,i)=>({n:`死霊技${i+1}`, e:`効果量${(i+1)*10}%アップ`})) },
    "魔導機工士": { desc: "連撃の嵐。", skills: Array.from({length:10}, (_,i)=>({n:`機工技${i+1}`, e:`効果量${(i+1)*10}%アップ`})) }
};

let p, currentDetailJobIdx = 0, currentBossHP = BOSS_MAX_HP, currentPlayerHP = 0, isProcessing = false;

function init() {
    const saved = localStorage.getItem(SAVE_KEY);
    p = saved ? JSON.parse(saved) : { lv: 1, exp: 0, job: "神話の剣聖", inventory: {}, jobLevels: {}, jobExp: {}, deathCount: 0, extraAtk: 0 };
    
    // データ不整合（旧ジョブ名など）を新ジョブにマッピングして保護
    if (!JOBS_DATA[p.job]) p.job = "神話の剣聖";
    Object.keys(JOBS_DATA).forEach(j => { if (!p.jobLevels[j]) p.jobLevels[j] = 1; if (p.jobExp[j] === undefined) p.jobExp[j] = 0; });

    const btn = document.getElementById("attackBtn");
    btn.onclick = battle;
    refresh();
}

function calcStats() {
    let baseAtk = 5000 + (p.lv * 500) + (p.jobLevels[p.job] * 200) + (p.extraAtk || 0);
    let stats = { totalAtk: baseAtk, crit: 5, critM: 1.5, deathM: 1.0 + (p.deathCount * 0.01), maxHP: 1000 + (p.lv * 100) };
    Object.keys(p.inventory).forEach(id => { stats.totalAtk += 1000 * p.inventory[id]; });
    stats.totalAtk *= stats.deathM;
    return stats;
}

function battle() {
    if (isProcessing) return; isProcessing = true;
    const stats = calcStats();
    let dmg = stats.totalAtk;
    currentBossHP -= dmg;
    p.deathCount++;
    p.exp += 100; p.jobExp[p.job] += 100;
    while (p.exp >= (p.lv ** 3 * 1000)) { p.exp -= (p.lv ** 3 * 1000); p.lv++; }
    while (p.jobExp[p.job] >= (p.jobLevels[p.job] ** 3 * 500)) { p.jobExp[p.job] -= (p.jobLevels[p.job] ** 3 * 500); p.jobLevels[p.job]++; }
    refresh();
    setTimeout(() => { isProcessing = false; }, 50);
}

function refresh() {
    const s = calcStats();
    document.getElementById("bosshp-text").innerText = (currentBossHP / BOSS_MAX_HP * 100).toFixed(4) + "%";
    document.getElementById("p-lv-text").innerText = `Lv.${p.lv} 主人公`;
    document.getElementById("p-job-text").innerText = `Lv.${p.jobLevels[p.job]} ${p.job}`;
    document.getElementById("sum-atk").innerText = Math.floor(s.totalAtk).toLocaleString();
    document.getElementById("sum-death").innerText = p.deathCount;
    if (document.getElementById("job").classList.contains("active")) renderJobs();
    if (document.getElementById("equip").classList.contains("active")) renderEquip();
    localStorage.setItem(SAVE_KEY, JSON.stringify(p));
}

function renderJobs() {
    const list = document.getElementById("jobList");
    list.innerHTML = Object.keys(JOBS_DATA).map((j, idx) => `
        <div class="card-cell" onclick="openJobDetailByIdx(${idx})">
            <div class="job-name-row">
                <span style="font-weight:bold;">${j}</span>
                <button class="mini-btn" onclick="event.stopPropagation(); changeJob('${j}')">転職</button>
            </div>
            <div style="font-size:0.7em;">Lv.${p.jobLevels[j]}</div>
        </div>`).join("");
}

function openJobDetailByIdx(idx) {
    currentDetailJobIdx = idx;
    const jName = Object.keys(JOBS_DATA)[currentDetailJobIdx];
    const d = JOBS_DATA[jName];
    document.getElementById("detailContent").innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>${jName}</h3>
            <button class="btn-attack" style="width:auto; padding:5px 10px;" onclick="changeJob('${jName}')">転職する</button>
        </div>
        <p>${d.desc}</p>
        ${d.skills.map((s,i)=>`<div class="skill-box"><b>${s.n}</b><br>${s.e}</div>`).join("")}`;
    document.getElementById("detailPanel").style.display = "flex";
}

function slideJob(dir) {
    const jobs = Object.keys(JOBS_DATA);
    currentDetailJobIdx = (currentDetailJobIdx + dir + jobs.length) % jobs.length;
    openJobDetailByIdx(currentDetailJobIdx);
}

function changeJob(jName) { p.job = jName; closeDetail(); refresh(); }
function closeDetail() { document.getElementById("detailPanel").style.display = "none"; }
function showTab(id, btn) { document.querySelectorAll(".tab").forEach(t => t.classList.remove("active")); document.getElementById(id).classList.add("active"); refresh(); }
function renderEquip() {
    document.getElementById("relicGrid").innerHTML = Object.keys(p.inventory).map(id => `<div>遺物ID:${id} (${p.inventory[id]})</div>`).join("");
}

init();
</script>
</body>
</html>

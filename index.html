<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>THE ONE - çµ‚ç„‰ã®è¶…è¶Šè€… -</title>
<style>
    :root {
        --bg: #050505; --card: #111; --primary: #00e676; 
        --secondary: #40c4ff; --danger: #ff5252; --text: #eee;
    }
    body { background: var(--bg); color: var(--text); font-family: 'serif'; margin: 0; user-select: none; touch-action: manipulation; }
    #top { background: var(--card); padding: 15px; border-bottom: 2px solid #333; position: sticky; top: 0; z-index: 100; text-align: center; }
    .status-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 0.8em; margin-bottom: 10px; color: var(--secondary); }
    .bar { height: 10px; background: #222; border-radius: 5px; margin: 5px 0; overflow: hidden; border: 1px solid #333; }
    .fill { height: 100%; transition: width 0.1s; }
    #jobexp { background: #ff4081; }
    #bosshp { background: linear-gradient(90deg, #600, #f00); width: 100%; }
    
    .nav { display: flex; background: #111; border-bottom: 1px solid #333; }
    .nav button { flex: 1; padding: 12px; border: none; background: transparent; color: #666; font-size: 0.8em; }
    .nav button.active { color: var(--primary); border-bottom: 2px solid var(--primary); }
    
    .tab { display: none; padding: 15px; }
    .tab.active { display: block; }
    
    .btn-attack { width: 100%; padding: 30px; background: #200; border: 2px solid var(--danger); color: var(--danger); font-size: 1.4em; font-weight: bold; border-radius: 10px; cursor: pointer; outline: none; transition: 0.1s; }
    .btn-attack:active { background: #600; color: #fff; transform: scale(0.98); }

    .item-card { background: #1a1a1a; padding: 12px; margin-bottom: 8px; border-radius: 5px; border: 1px solid #333; position: relative; }
    .item-val { color: var(--primary); font-weight: bold; font-family: 'monospace'; }
    
    #log { height: 160px; overflow-y: auto; background: #000; padding: 10px; font-size: 0.75em; border: 1px solid #333; margin-top: 10px; display: flex; flex-direction: column-reverse; }
    .btn-action { padding: 6px 12px; background: #333; color: #fff; border: none; border-radius: 3px; cursor: pointer; font-size: 0.75em; }
    .skill-list { display: grid; grid-template-columns: repeat(5, 1fr); gap: 2px; margin-top: 5px; }
    .skill-item { background: #000; height: 4px; border-radius: 2px; }
    .skill-on { background: var(--primary); box-shadow: 0 0 5px var(--primary); }
</style>
</head>
<body>

<div id="top">
    <div id="boss-name" style="font-size:1.2em; color:var(--danger); letter-spacing: 0.2em;">ã€ä¸‡ç‰©ã®çµ‚ç„‰ã€‘ã‚¢ã‚¶ãƒˆãƒ¼ã‚¹</div>
    <div class="bar"><div id="bosshp" class="fill"></div></div>
    <div id="bosshp-text" style="font-size: 0.7em; font-family: monospace;">HP: ??? / ???</div>
</div>

<div class="nav">
    <button onclick="showTab('battle', this)" class="active">æ­»é—˜</button>
    <button onclick="showTab('job', this)">æ·±æ·µ</button>
    <button onclick="showTab('equip', this)">éºç‰©</button>
    <button onclick="showTab('system', this)">è¨˜éŒ²</button>
</div>

<div id="battle" class="tab active">
    <button class="btn-attack" id="attackBtn">ä¸€æ’ƒã‚’å©ãè¾¼ã‚€</button>
    <div id="log"></div>
</div>

<div id="job" class="tab">
    <div class="status-grid">
        <span id="p-lv">Lv.1</span>
        <span id="p-job">å‰£å£« Lv.1</span>
        <span id="p-atk">å¨åŠ›: 0</span>
        <span id="p-crit">ä¼šå¿ƒ: 0%</span>
    </div>
    <div class="bar"><div id="jobexp" class="fill"></div></div>
    <div id="jobList" style="max-height: 50vh; overflow-y: auto;"></div>
</div>

<div id="equip" class="tab">
    <div style="display:flex; gap:5px; margin-bottom:10px;">
        <button class="btn-action" onclick="setEquipTab('weapon')" style="flex:1">æ­¦å™¨</button>
        <button class="btn-action" onclick="setEquipTab('armor')" style="flex:1">é˜²å…·</button>
        <button class="btn-action" onclick="setEquipTab('acc')" style="flex:1">å®é£¾</button>
    </div>
    <button class="btn-action" onclick="bulkDelete()" style="width:100%; background:#400; margin-bottom:10px;">æœªæ–½éŒ ã®éºç‰©ã‚’å…¨ã¦ç ´æ£„</button>
    <div id="inventory" style="max-height: 50vh; overflow-y: auto;"></div>
</div>

<div id="system" class="tab">
    <textarea id="saveInput" style="width:100%; background:#000; color:#0f0; font-size:0.6em; border:1px solid #444;" rows="8"></textarea>
    <div style="display:flex; gap:5px; margin-top:5px;">
        <button class="btn-action" onclick="copySaveCode()" style="flex:1">å†™ã—ã‚’å–ã‚‹</button>
        <button class="btn-action" onclick="importSave()" style="flex:1">è¨˜æ†¶ã‚’æˆ»ã™</button>
    </div>
</div>

<script>
const BOSS_MAX_HP = 1e15; // 1000å…†
const JOBS = {
    "å‰£å£«": ["æ–¬æ’ƒ","æ–­ã¡","é‡åœ§","ç„¡æƒ³","å‰£è–"],
    "é¨å£«": ["é˜²å®ˆ","ç›¾æ§‹","ä¸é€€","é‰„å¿ƒ","å®ˆè­·ç¥"],
    "é­”è¡“å¸«": ["ç«ç‚","å†·å¾¹","é›·é³´","æ··æ²Œ","ç¦å¿Œ"],
    "ç›—è³Š": ["æ å¥ª","æš—æ®º","ç¥é€Ÿ","è£æŠ€","è™šç©º"],
    "å¼“ä½¿ã„": ["å¿…ä¸­","åƒçŸ¢","ä¸€ç‚¹","é¢¨èª­","ç¥å°„"],
    "åƒ§ä¾¶": ["æ…ˆæ„›","æ´—ç¤¼","ç¦éŸ³","è£ã","æ•‘æ¸ˆ"],
    "æ‹³é—˜å£«": ["ç ´ç •","é€£æ’ƒ","çˆ†è£‚","å‰›è…•","å£Šæ»…"],
    "ä¾": ["å±…åˆ","è¦‹åˆ‡","ä¿®ç¾…","é¬¼çœ¼","ä¸€åˆ€"],
    "æ§ä½¿ã„": ["è²«é€š","é¾çª","åƒæ‰‹","ä¸å€’","é–ƒå…‰"],
    "è³¢è€…": ["å¡æ™º","è§£æ","çœŸç†","å› æœ","å…¨çŸ¥"]
};

// è£…å‚™åç”Ÿæˆç”¨
const WEAPON_NAMES = ["æ–­ç½ªã®å‰£", "çµ¶æœ›ã‚’ç©¿ã¤æ§", "è™šç„¡ã®çˆª", "æ»…ã³ã®æ–", "æ˜Ÿç •ãã®æ§Œ", "æ¬¡å…ƒã®åˆƒ", "çµ‚ç„‰ã®å¤ªåˆ€"];
const ARMOR_NAMES = ["å†¥åºœã®è¡£", "è¦‡ç‹ã®ç”²å†‘", "å¹½ç„ã®æ³•è¡£", "ç†ã‚’å¤–ã‚ŒãŸé§", "æ·±æ·µã®å¤–å¥—"];
const ACC_NAMES = ["åˆ»å°ã®æŒ‡è¼ª", "é­”çœ¼ã®é¦–é£¾ã‚Š", "é­‚ã®é›«", "ç•°ç•Œã®å®ç‰", "å¤ã®å‘ªå°"];

let p, currentEquipTab = 'weapon', longPressIdx;
const SAVE_KEY = "THE_ONE_HARDCORE_V1";

function init() {
    const saved = localStorage.getItem(SAVE_KEY);
    p = saved ? JSON.parse(saved) : createNewPlayer();
    
    const btn = document.getElementById("attackBtn");
    const start = (e) => { e.preventDefault(); battle(); longPressIdx = setInterval(battle, 100); };
    const stop = () => clearInterval(longPressIdx);
    btn.addEventListener("mousedown", start); btn.addEventListener("mouseup", stop);
    btn.addEventListener("touchstart", start); btn.addEventListener("touchend", stop);

    refresh();
}

function createNewPlayer() {
    let d = { lv:1, exp:0, job:"å‰£å£«", inventory:[], weapon:null, armor:null, acc:null, jobLevels:{}, jobExp:{} };
    Object.keys(JOBS).forEach(j => { d.jobLevels[j] = 1; d.jobExp[j] = 0; });
    return d;
}

function calcStats() {
    let baseAtk = 10 + (p.lv * 5);
    let crit = 5;
    if (p.weapon) baseAtk += p.weapon.val;
    if (p.acc) crit += p.acc.val / 1000; // ã‚¢ã‚¯ã‚»ã‚µãƒªã¯ä¼šå¿ƒè£œæ­£

    let jobBonus = 1.0;
    Object.keys(p.jobLevels).forEach(j => {
        jobBonus += (p.jobLevels[j] - 1) * 0.1; // 1Lvã”ã¨ã«10%å¼·åŒ–
    });

    p.totalAtk = Math.floor(baseAtk * jobBonus);
    p.totalCrit = Math.min(95, crit);
}

function battle() {
    calcStats();
    let isCrit = Math.random() < p.totalCrit/100;
    let dmg = isCrit ? p.totalAtk * 10 : p.totalAtk;
    
    // ãƒœã‚¹ã¯æŒ‘ã‚€ãŸã³ã«å…¨å¿«ã€‚dmgãŒã©ã‚Œã ã‘å‰Šã£ãŸã‹ã®è¨˜éŒ²ã«ãªã‚‹
    let bossCurrentHP = BOSS_MAX_HP - dmg;
    let hpPercent = (bossCurrentHP / BOSS_MAX_HP * 100);
    
    document.getElementById("bosshp").style.width = hpPercent + "%";
    document.getElementById("bosshp-text").innerText = `å‰Šã‚Š: ${dmg.toLocaleString()} / ${BOSS_MAX_HP.toLocaleString()}`;

    // å ±é…¬: ä¸ãˆãŸãƒ€ãƒ¡ãƒ¼ã‚¸ãŒé«˜ã„ã»ã©é£›èºçš„ã«å¢—ãˆã‚‹
    let gain = Math.floor(Math.pow(dmg, 0.7));
    p.exp += gain;
    p.jobExp[p.job] += gain;

    if (Math.random() < 0.1) dropItem(dmg);

    checkLevelUp();
    save();
    refresh();
}

function dropItem(dmg) {
    const type = ["weapon", "armor", "acc"][Math.floor(Math.random()*3)];
    const names = type === 'weapon' ? WEAPON_NAMES : type === 'armor' ? ARMOR_NAMES : ACC_NAMES;
    const baseName = names[Math.floor(Math.random()*names.length)];
    
    // ãƒ€ãƒ¡ãƒ¼ã‚¸é‡ã«å¿œã˜ã¦æ€§èƒ½ãŒãƒ©ãƒ³ãƒ€ãƒ ã«å¤‰å‹•
    const quality = Math.floor(Math.random() * (dmg / 10)) + 1;
    
    p.inventory.push({
        id: Date.now()+Math.random(),
        type,
        lock: false,
        name: baseName,
        val: quality
    });
    // è‡ªå‹•ã‚½ãƒ¼ãƒˆ
    sortInventory();
    addLog(`âœ¨ éºç‰©ã€${baseName}ã€ã‚’å…¥æ‰‹ (${quality.toLocaleString()})`);
}

function checkLevelUp() {
    while (p.exp >= p.lv * 100) { p.exp -= p.lv * 100; p.lv++; }
    while (p.jobExp[p.job] >= p.jobLevels[p.job] * 150) {
        p.jobExp[p.job] -= p.jobLevels[p.job] * 150;
        p.jobLevels[p.job]++;
    }
}

function sortInventory() {
    p.inventory.sort((a, b) => b.val - a.val);
}

function refresh() {
    calcStats();
    document.getElementById("p-lv").innerText = `Lv.${p.lv}`;
    document.getElementById("p-job").innerText = `${p.job} Lv.${p.jobLevels[p.job]}`;
    document.getElementById("p-atk").innerText = `å¨åŠ›: ${p.totalAtk.toLocaleString()}`;
    document.getElementById("p-crit").innerText = `ä¼šå¿ƒ: ${p.totalCrit.toFixed(1)}%`;
    document.getElementById("jobexp").style.width = (p.jobExp[p.job] / (p.jobLevels[p.job] * 150) * 100) + "%";

    document.getElementById("inventory").innerHTML = p.inventory.filter(it => it.type === currentEquipTab).map(it => {
        const isEq = (p.weapon?.id===it.id || p.armor?.id===it.id || p.acc?.id===it.id);
        return `<div class="item-card">
            <b>${isEq?'<span style="color:#0f0">[è£…ç€]</span> ':''}${it.name}</b><br>
            <span class="item-val">ï¼‹${it.val.toLocaleString()}</span>
            <div style="margin-top:8px; display:flex; gap:10px;">
                <button class="btn-action" onclick="toggleEquip(${it.id})">${isEq?'å¤–ã™':'è£…ç€'}</button>
                <button class="btn-action" onclick="toggleLock(${it.id})">${it.lock?'ğŸ”’':'ğŸ”“'}</button>
                <button class="btn-action" onclick="deleteItem(${it.id})" style="color:#999">æ£„ã¦ã‚‹</button>
            </div>
        </div>`;
    }).join("");

    document.getElementById("jobList").innerHTML = Object.keys(JOBS).map(j => {
        const lv = p.jobLevels[j];
        const skills = JOBS[j];
        return `<div class="item-card" style="border-left: 3px solid ${p.job===j?'var(--primary)':'#333'}">
            <b>${j}</b> <small>ç†Ÿç·´åº¦:${lv}</small>
            <div class="skill-list">
                ${skills.map((s,i) => `<div class="skill-item ${lv > i*10 ? 'skill-on' : ''}"></div>`).join("")}
            </div>
            <button class="btn-action" onclick="p.job='${j}';save();refresh();" ${p.job===j?'disabled':''} style="width:100%; margin-top:8px;">æ·±æ·µã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹</button>
        </div>`;
    }).join("");
}

function toggleEquip(id) {
    let it = p.inventory.find(i=>i.id===id);
    if(it.type==="weapon") p.weapon = (p.weapon?.id===id)?null:it;
    if(it.type==="armor") p.armor = (p.armor?.id===id)?null:it;
    if(it.type==="acc") p.acc = (p.acc?.id===id)?null:it;
    save(); refresh();
}
function toggleLock(id) { let it = p.inventory.find(i=>i.id===id); it.lock = !it.lock; save(); refresh(); }
function deleteItem(id) { p.inventory = p.inventory.filter(i=>i.id!==id); if(p.weapon?.id===id)p.weapon=null;if(p.armor?.id===id)p.armor=null;if(p.acc?.id===id)p.acc=null; save(); refresh(); }
function bulkDelete() { p.inventory = p.inventory.filter(it => it.lock || p.weapon?.id===it.id || p.armor?.id===it.id || p.acc?.id===it.id); save(); refresh(); }
function addLog(m) {
    const l = document.getElementById("log");
    l.innerHTML += `<div>${m}</div>`;
    if(l.childNodes.length > 30) l.removeChild(l.firstChild);
}
function setEquipTab(t) { currentEquipTab = t; refresh(); }
function showTab(id, btn) {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.getElementById(id).classList.add("active");
    document.querySelectorAll(".nav button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
}
function save() { localStorage.setItem(SAVE_KEY, JSON.stringify(p)); }
function copySaveCode() { save(); document.getElementById("saveInput").value = btoa(unescape(encodeURIComponent(JSON.stringify(p)))); alert("å†™ã—ã‚’å–ã‚Šã¾ã—ãŸ"); }
function importSave() { try{ p = JSON.parse(decodeURIComponent(escape(atob(document.getElementById("saveInput").value)))); save(); location.reload(); }catch(e){alert("å¤±æ•—");} }

init();
</script>
</body>
</html>

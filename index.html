<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>infiniterelic</title>
<style>
    :root {
        --bg: #ffffff; --panel: #f8f9fa; --border: #dee2e6;
        --primary: #007bff; --text: #212529; --sub: #6c757d;
        --accent: #dc3545; --gold: #d39e00; --death: #6f42c1; --exp: #28a745;
    }
    body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
    #header { background: var(--panel); padding: 10px; border-bottom: 2px solid var(--border); flex-shrink: 0; }
    .bar-container { margin-bottom: 4px; }
    .bar-label { display: flex; justify-content: space-between; font-size: 0.75em; font-weight: bold; }
    .bar { height: 8px; background: #eee; border-radius: 4px; overflow: hidden; }
    .fill { height: 100%; transition: width 0.1s ease; }
    #bosshp { background: linear-gradient(90deg, #ffc107, #dc3545); }
    #exp-bar { background: var(--primary); }
    .stats-summary { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-top: 6px; background: rgba(0,0,0,0.03); padding: 6px; border-radius: 4px; font-size: 0.8em; }
    .stat-item { display: flex; justify-content: space-between; font-weight: bold; }
    
    .nav { display: flex; background: var(--panel); border-bottom: 1px solid var(--border); }
    .nav button { flex: 1; padding: 12px 0; border: none; background: none; color: var(--sub); font-weight: bold; font-size: 0.8em; cursor: pointer; }
    .nav button.active { color: var(--primary); border-bottom: 3px solid var(--primary); background: #fff; }

    #content { flex-grow: 1; overflow: hidden; position: relative; }
    .tab { display: none; padding: 10px; height: 100%; box-sizing: border-box; overflow-y: auto; }
    .tab.active { display: block; }

    .grid-1col { display: grid; grid-template-columns: 1fr; gap: 10px; padding-bottom: 120px; }
    .card-cell { background: #fff; border: 1px solid var(--border); padding: 12px; border-radius: 8px; }
    
    .skill-list { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: 8px; }
    .skill-item { font-size: 0.7em; padding: 6px; border-radius: 4px; background: #f1f3f5; border-left: 2px solid var(--border); color: #888; }
    .skill-unlocked { border-left-color: var(--primary); background: #e7f5ff; color: #000; font-weight: bold; }

    .btn-attack { width: 100%; padding: 20px; background: var(--primary); color: #fff; font-size: 1.2em; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; user-select: none; -webkit-user-select: none; }
    #log { flex-grow: 1; margin-top: 10px; overflow-y: auto; font-size: 0.75em; background: #fdfdfd; padding: 8px; border: 1px solid var(--border); border-radius: 6px; height: 180px; }
</style>
</head>
<body>

<div id="header">
    <div class="bar-container"><div class="bar-label"><span>é­”ç¥ã®å‘ªç¸›</span><span id="bosshp-text">100%</span></div><div class="bar"><div id="bosshp" class="fill"></div></div></div>
    <div class="bar-container"><div class="bar-label"><span id="p-lv-text">å†èµ· Lv.1</span><span id="exp-text">0%</span></div><div class="bar"><div id="exp-bar" class="fill"></div></div></div>
    <div class="stats-summary">
        <div class="stat-item"><span>å›å¸°ã—ãŸåŠ›:</span><span id="sum-atk">0</span></div>
        <div class="stat-item"><span>æ•—åŒ—æ•°:</span><span id="sum-death">0</span></div>
    </div>
</div>

<div class="nav">
    <button onclick="showTab('battle', this)" class="active">è¨ä¼</button>
    <button onclick="showTab('power', this)">å¤±ã‚ã‚ŒãŸæ¨©èƒ½</button>
    <button onclick="showTab('relic', this)">éºç‰©</button>
</div>

<div id="content">
    <div id="battle" class="tab active"><button class="btn-attack" id="attackBtn">å‘ªç¸›ã«æ”»æ’ƒï¼ˆé•·æŠ¼ã—å¯ï¼‰</button><div id="log"></div></div>
    <div id="power" class="tab"><div id="powerList" class="grid-1col"></div></div>
    <div id="relic" class="tab"><div id="relicList" class="grid-1col"></div></div>
</div>

<script>
const BOSS_MAX_HP = 1e24;
const SAVE_KEY = "MAJIN_DPS_V8_FIX";

// 10ç³»çµ±ã®æ¨©èƒ½
const POWER_DATA = {
    "å‰£ç¥ã®æ®‹ç«": { desc: "ã‹ã¤ã¦ã®å‰£æŠ€ã€‚ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã¨é€£æ’ƒã‚’å¸ã‚‹ã€‚", skills: [
        {req:5, n:"ä¸€ã®å¤ªåˆ€", e:"ATK3å€"}, {req:15, n:"ç‡•è¿”ã—", e:"è¿½æ’ƒç™ºç”Ÿ"}, {req:30, n:"å¿ƒçœ¼", e:"ã‚¯ãƒªç‡+20%"}, {req:60, n:"ç„¡æƒ³", e:"è¶…ç¨€ã«100å€"}, {req:100, n:"å¤©æ–­", e:"ã‚¯ãƒªå¨åŠ›5å€"}
    ]},
    "ä¸æ»…ã®å®ˆè­·è€…": { desc: "æ•—åŒ—ã‚’åŠ›ã¸å¤‰ãˆã‚‹ç”Ÿå­˜ã®æ¥µè‡´ã€‚", skills: [
        {req:5, n:"ä¸å±ˆ", e:"æ•—åŒ—åŠ ç®—+1000"}, {req:15, n:"å†ç”Ÿã®æ¥”", e:"æ•—åŒ—å€ç‡UP"}, {req:30, n:"é€†å¢ƒã®ç†", e:"HPæ¶ˆå¤±æ™‚ATKå¢—"}, {req:60, n:"ä¸æ­»ã®é­‚", e:"å†èµ·åŠ¹ç‡åŒ–"}, {req:100, n:"å®ˆè­·ç¥ã®èª‡ã‚Š", e:"å…¨ATK2å€"}
    ]},
    "é­”å°ç‹ã®éºå¿—": { desc: "ä¸‡è±¡ã®çŸ¥æµã€‚éºç‰©å…±é³´ã‚’æ·±ã‚ã‚‹ã€‚", skills: [
        {req:5, n:"é­”åŠ›å°ç·š", e:"å…±é³´åŠ¹ç‡+30%"}, {req:15, n:"è¡“å¼å±•é–‹", e:"éºç‰©ATKä¸Šæ˜‡"}, {req:30, n:"è© å”±ç ´æ£„", e:"é€£æ’ƒé€Ÿåº¦UP"}, {req:60, n:"å…¨çŸ¥", e:"å…¨ã‚¹ãƒ†+50%"}, {req:100, n:"çœŸç†ã®è§£æ”¾", e:"éºç‰©å¨åŠ›3å€"}
    ]},
    "è¦‡ç‹ã®æ®‹å…‰": { desc: "ä¸–ç•Œã‚’çµ±ã¹ãŸç‹ã€‚åœ§å€’çš„åŸºç¤ç«åŠ›ã€‚", skills: [
        {req:5, n:"è¦‡æ°—", e:"ATK+5ä¸‡"}, {req:15, n:"å¨åœ§", e:"æœ€å°ãƒ€ãƒ¡ãƒ¼ã‚¸ä¿è¨¼"}, {req:30, n:"ç‹ã®å‡±æ—‹", e:"ãƒ‰ãƒ­ãƒƒãƒ—ç‡2å€"}, {req:60, n:"æ”¯é…", e:"æœ€çµ‚ãƒ€ãƒ¡1.5å€"}, {req:100, n:"è‡³é«˜ã®å¾¡åº§", e:"å…¨ATK10å€"}
    ]},
    "çµ¶å½±ã®æ®‹å½±": { desc: "ç¥é€Ÿã®æ¨©èƒ½ã€‚é˜²å¾¡ã‚’ç„¡è¦–ã™ã‚‹ã€‚", skills: [
        {req:5, n:"æ€¥æ‰€ç©¿ã¡", e:"ã‚¯ãƒªç‡+15%"}, {req:15, n:"å½±èµ°ã‚Š", e:"æ”»æ’ƒé€Ÿåº¦2å€"}, {req:30, n:"æ­»ã®åˆ»å°", e:"é˜²å¾¡è²«é€š"}, {req:60, n:"æš—æ®ºå¥¥ç¾©", e:"1%ã§å³æ­»"}, {req:100, n:"è™šåƒ", e:"ãƒ’ãƒƒãƒˆæ•°+5"}
    ]}
};

let p, currentBossHP = BOSS_MAX_HP, longPressInterval = null;

function init() {
    try {
        const saved = localStorage.getItem(SAVE_KEY);
        p = saved ? JSON.parse(saved) : { lv: 1, exp: 0, inventory: {}, deathCount: 0, extraAtk: 0 };
        if (!p.inventory) p.inventory = {};
        
        const btn = document.getElementById("attackBtn");
        // é•·æŠ¼ã—ã‚¤ãƒ™ãƒ³ãƒˆã®ç¢ºå®Ÿãªç™»éŒ²
        const start = (e) => { e.preventDefault(); if(!longPressInterval){ battle(); longPressInterval = setInterval(battle, 100); } };
        const stop = () => { if(longPressInterval){ clearInterval(longPressInterval); longPressInterval = null; } };
        
        btn.addEventListener("touchstart", start); btn.addEventListener("touchend", stop);
        btn.addEventListener("mousedown", start); btn.addEventListener("mouseup", stop); btn.addEventListener("mouseleave", stop);
        
        refresh();
    } catch(e) { console.error("åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", e); }
}

function getSystemRelicCount(systemName) {
    const systemNames = Object.keys(POWER_DATA);
    const sIdx = systemNames.indexOf(systemName);
    if (sIdx === -1) return 0;
    let count = 0;
    for(let i=0; i<10; i++) {
        const rid = sIdx * 10 + i;
        count += (p.inventory[rid] || 0);
    }
    return count;
}

function calcStats() {
    let s = { baseAtk: 5000 + (p.lv * 1000), deathM: 1 + (p.deathCount * 0.01), multi: 1, crit: 5 };
    
    // éºç‰©ãã®ã‚‚ã®ã®åŠ ç®—
    Object.keys(p.inventory).forEach(id => { s.baseAtk += (p.inventory[id] * 800); });

    // æ¨©èƒ½ã«ã‚ˆã‚‹è£œæ­£
    Object.keys(POWER_DATA).forEach(name => {
        const count = getSystemRelicCount(name);
        const sk = POWER_DATA[name].skills;
        if (name === "å‰£ç¥ã®æ®‹ç«" && count >= sk[1].req) s.multi += 1;
        if (name === "è¦‡ç‹ã®æ®‹å…‰" && count >= sk[0].req) s.baseAtk += 50000;
        if (name === "ä¸æ»…ã®å®ˆè­·è€…" && count >= sk[1].req) s.deathM *= 1.5;
    });

    s.finalAtk = s.baseAtk * s.deathM * s.multi;
    return s;
}

function battle() {
    try {
        const s = calcStats();
        currentBossHP -= s.finalAtk;
        
        p.deathCount++;
        p.exp += 150;
        
        // éºç‰©ãƒ‰ãƒ­ãƒƒãƒ—ã¨åæ˜ 
        if (Math.random() < 0.2) {
            const rid = Math.floor(Math.random() * 100);
            p.inventory[rid] = (p.inventory[rid] || 0) + 1;
            addLog(`<span style="color:var(--gold)">ğŸ’ éºç‰©[ID:${rid}]ã‚’ç²å¾—</span>`);
        }

        while (p.exp >= (p.lv ** 3 * 1000)) { p.exp -= (p.lv ** 3 * 1000); p.lv++; }
        refresh();
    } catch(e) { console.error("æˆ¦é—˜ã‚¨ãƒ©ãƒ¼:", e); }
}

function refresh() {
    const s = calcStats();
    document.getElementById("bosshp").style.width = Math.max(0, (currentBossHP / BOSS_MAX_HP * 100)) + "%";
    document.getElementById("bosshp-text").innerText = Math.max(0, (currentBossHP / BOSS_MAX_HP * 100)).toFixed(4) + "%";
    document.getElementById("exp-bar").style.width = (p.exp / (p.lv ** 3 * 1000) * 100) + "%";
    document.getElementById("p-lv-text").innerText = `å†èµ· Lv.${p.lv}`;
    document.getElementById("sum-atk").innerText = Math.floor(s.finalAtk).toLocaleString();
    document.getElementById("sum-death").innerText = p.deathCount;

    if (document.getElementById("power").classList.contains("active")) renderPowers();
    if (document.getElementById("relic").classList.contains("active")) renderRelics();
    localStorage.setItem(SAVE_KEY, JSON.stringify(p));
}

function renderPowers() {
    const list = document.getElementById("powerList");
    list.innerHTML = Object.keys(POWER_DATA).map(name => {
        const count = getSystemRelicCount(name);
        return `
        <div class="card-cell">
            <b>${name}</b> <span style="font-size:0.7em; color:var(--primary);">éºç‰©:${count}</span>
            <div class="skill-list">
                ${POWER_DATA[name].skills.map(sk => `
                    <div class="skill-item ${count >= sk.req ? 'skill-unlocked' : ''}">
                        ${sk.n}<br><small>${count >= sk.req ? sk.e : sk.req+'å€‹ã§è§£æ”¾'}</small>
                    </div>
                `).join("")}
            </div>
        </div>`;
    }).join("");
}

function renderRelics() {
    const list = document.getElementById("relicList");
    // inventoryã«ã‚ã‚‹ã€1å€‹ä»¥ä¸ŠæŒã£ã¦ã„ã‚‹éºç‰©ã‚’ã™ã¹ã¦è¡¨ç¤º
    const collectedIds = Object.keys(p.inventory).filter(id => p.inventory[id] > 0).sort((a,b)=>a-b);
    
    if (collectedIds.length === 0) {
        list.innerHTML = "<p style='text-align:center; color:var(--sub);'>éºç‰©ã¯ã¾ã è¦‹ã¤ã‹ã£ã¦ã„ãªã„...</p>";
        return;
    }

    list.innerHTML = collectedIds.map(id => `
        <div class="card-cell" style="padding:10px; display:flex; justify-content:space-between;">
            <span>éºç‰© ID:${id}</span>
            <b style="color:var(--primary);">æ‰€æŒæ•°: ${p.inventory[id]}</b>
        </div>
    `).join("");
}

function showTab(id, btn) {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.getElementById(id).classList.add("active");
    document.querySelectorAll(".nav button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    refresh();
}

function addLog(m) {
    const l = document.getElementById("log");
    const d = document.createElement("div");
    d.innerHTML = m;
    l.prepend(d);
    if (l.childNodes.length > 15) l.removeChild(l.lastChild);
}

init();
</script>
</body>
</html>
